<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Noteflux</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0d0d11;
  --surface:#141418;
  --surface2:#1c1c22;
  --surface3:#242430;
  --surface4:#2e2e3c;
  --border:rgba(255,255,255,.065);
  --border2:rgba(255,255,255,.11);
  --accent:#b8e32a;
  --accent-dim:rgba(184,227,42,.11);
  --accent-glow:rgba(184,227,42,.28);
  --accent2:#7c5cfc;
  --accent2-dim:rgba(124,92,252,.12);
  --text:#e2e2ea;
  --text2:#8e8ea8;
  --text3:#55556a;
  --danger:#f05252;
  --danger-dim:rgba(240,82,82,.1);
  --tr:.17s cubic-bezier(.4,0,.2,1);
  --r:10px;
  --r-lg:15px;
  --rail:56px;
  --sidebar:252px;
  --sh:0 4px 20px rgba(0,0,0,.5);
  --sh-lg:0 16px 60px rgba(0,0,0,.65);
}
.light{
  --bg:#efefe9;
  --surface:#fafafa;
  --surface2:#f2f2ec;
  --surface3:#e8e8e2;
  --surface4:#deded8;
  --border:rgba(0,0,0,.07);
  --border2:rgba(0,0,0,.13);
  --accent:#5a9900;
  --accent-dim:rgba(90,153,0,.1);
  --accent-glow:rgba(90,153,0,.22);
  --accent2:#5134d0;
  --accent2-dim:rgba(81,52,208,.1);
  --text:#17171f;
  --text2:#5c5c72;
  --text3:#9898aa;
  --danger:#d92626;
  --danger-dim:rgba(217,38,38,.08);
  --sh:0 4px 20px rgba(0,0,0,.08);
  --sh-lg:0 16px 60px rgba(0,0,0,.14);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;overflow:hidden}

/* ambient orbs */
.orb{position:fixed;border-radius:50%;filter:blur(90px);pointer-events:none;z-index:0}
.orb1{top:-20%;left:10%;width:50vw;height:50vw;background:radial-gradient(circle,rgba(124,92,252,.07),transparent 70%)}
.orb2{bottom:-15%;right:5%;width:40vw;height:40vw;background:radial-gradient(circle,rgba(184,227,42,.05),transparent 70%)}

/* â”€â”€ APP SHELL: rail | sidebar-panel | editor â”€â”€ */
.app{display:grid;grid-template-columns:var(--rail) var(--sidebar) 1fr;height:100vh;position:relative;z-index:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ICON RAIL (leftmost strip)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rail{
  width:var(--rail);
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  align-items:center;
  padding:12px 0;
  gap:2px;
  overflow:hidden;
  z-index:10;
}
.rail-logo{
  width:32px;height:32px;
  background:var(--accent);
  border-radius:9px;
  display:flex;align-items:center;justify-content:center;
  margin-bottom:12px;cursor:pointer;transition:var(--tr);flex-shrink:0;
}
.rail-logo:hover{filter:brightness(1.1);transform:scale(1.05)}
.rail-logo svg{width:15px;height:15px}

.rail-btn{
  width:38px;height:38px;
  border-radius:10px;
  border:1px solid transparent;
  background:none;color:var(--text3);
  cursor:pointer;transition:var(--tr);
  display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;position:relative;
}
.rail-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--border)}
.rail-btn.active{background:var(--surface2);color:var(--accent);border-color:var(--accent-dim)}
.rail-btn .tip{
  position:absolute;left:calc(100% + 10px);
  background:var(--surface3);border:1px solid var(--border2);
  color:var(--text);font-family:'Syne',sans-serif;font-size:11px;font-weight:600;
  padding:4px 9px;border-radius:7px;white-space:nowrap;
  pointer-events:none;opacity:0;transition:opacity .15s;
  box-shadow:var(--sh);z-index:200;
}
.rail-btn:hover .tip{opacity:1}

.rail-sep{width:26px;height:1px;background:var(--border);margin:4px 0;flex-shrink:0}
.rail-spacer{flex:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{
  width:var(--sidebar);
  background:var(--surface);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  overflow:hidden;
}

/* panel header */
.panel-hdr{
  padding:14px 14px 10px;
  border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.panel-title{
  font-family:'Syne',sans-serif;font-weight:700;font-size:13px;
  letter-spacing:.2px;color:var(--text);
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:10px;
}
.panel-title-lbl{display:flex;align-items:center;gap:7px}
.panel-title-lbl .panel-icon{font-size:15px}
.cnt-pill{
  background:var(--surface3);border-radius:5px;
  padding:1px 6px;font-size:10px;color:var(--text2);
  font-family:'DM Sans',sans-serif;font-weight:400;
}

.btn-new{
  width:100%;padding:9px 10px;
  background:var(--accent);color:#0d0d11;
  border:none;border-radius:var(--r);
  font-family:'Syne',sans-serif;font-weight:700;font-size:12px;
  cursor:pointer;transition:var(--tr);
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.btn-new:hover{filter:brightness(1.08);transform:translateY(-1px);box-shadow:0 6px 18px var(--accent-glow)}

/* search */
.sb-search{padding:10px 12px;border-bottom:1px solid var(--border);flex-shrink:0}
.search-wrap{position:relative}
.search-ico{position:absolute;left:9px;top:50%;transform:translateY(-50%);color:var(--text3);pointer-events:none}
.search-inp{
  width:100%;background:var(--surface2);
  border:1px solid var(--border);border-radius:var(--r);
  padding:7px 10px 7px 30px;
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:12.5px;
  outline:none;transition:var(--tr);
}
.search-inp::placeholder{color:var(--text3)}
.search-inp:focus{border-color:var(--accent-glow)}

/* sort */
.sort-row{padding:6px 12px 4px;display:flex;align-items:center;gap:6px;flex-shrink:0}
.sort-lbl{font-size:11px;color:var(--text3);flex-shrink:0}
.sort-sel{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:7px;color:var(--text);
  font-size:11px;font-family:'DM Sans',sans-serif;
  padding:3px 6px;outline:none;cursor:pointer;flex:1;
}

/* notes list */
.list-header{
  padding:8px 14px 4px;
  font-family:'Syne',sans-serif;font-size:9.5px;font-weight:700;
  letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);
  display:flex;align-items:center;gap:5px;flex-shrink:0;
}
.notes-list{
  flex:1;overflow-y:auto;padding:2px 8px 8px;min-height:0;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
}
.notes-list::-webkit-scrollbar{width:3px}
.notes-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}

/* note card */
.note-item{
  padding:9px 10px;border-radius:var(--r);cursor:pointer;
  transition:var(--tr);margin-bottom:2px;
  border:1px solid transparent;position:relative;
  animation:itemIn .2s ease both;
}
@keyframes itemIn{from{opacity:0;transform:translateX(-5px)}to{opacity:1;transform:translateX(0)}}
.note-item:hover{background:var(--surface2)}
.note-item.active{background:var(--surface2);border-color:var(--border)}
.note-item.active::before{
  content:'';position:absolute;left:-1px;top:22%;bottom:22%;
  width:2px;background:var(--accent);border-radius:0 2px 2px 0;
}
.ni-row1{display:flex;align-items:center;gap:4px;margin-bottom:2px}
.ni-title{
  font-family:'Syne',sans-serif;font-weight:600;font-size:12px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;
}
.ni-pin{font-size:9px;opacity:.55;flex-shrink:0}
.ni-prev{font-size:11px;color:var(--text2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;line-height:1.4;margin-bottom:4px}
.ni-meta{display:flex;align-items:center;justify-content:space-between;gap:4px}
.ni-date{font-size:9.5px;color:var(--text3);flex-shrink:0}
.ni-tags{display:flex;gap:2px;overflow:hidden;flex-wrap:nowrap;max-width:55%}
.ni-tag{font-size:8.5px;padding:1px 5px;border-radius:20px;font-weight:500;white-space:nowrap;flex-shrink:0}
.item-acts{position:absolute;right:6px;top:7px;display:flex;gap:2px;opacity:0;transition:var(--tr)}
.note-item:hover .item-acts{opacity:1}
.item-act{
  background:none;border:none;color:var(--text3);
  cursor:pointer;padding:3px 4px;border-radius:5px;
  transition:var(--tr);font-size:11px;line-height:1;
}
.item-act:hover{color:var(--danger);background:var(--danger-dim)}
.item-act.restore:hover{color:#34d399;background:rgba(52,211,153,.1)}

/* empty state */
.empty-state{text-align:center;padding:24px 14px;color:var(--text3)}
.empty-state p{font-size:12px;line-height:1.6}

/* bin empty btn */
.bin-empty-btn{
  width:100%;margin-bottom:5px;padding:7px;
  background:var(--danger-dim);border:1px dashed rgba(240,82,82,.25);
  color:var(--danger);border-radius:var(--r);
  font-family:'Syne',sans-serif;font-size:11px;font-weight:600;
  cursor:pointer;transition:var(--tr);
}
.bin-empty-btn:hover{background:rgba(240,82,82,.18)}

/* daily badge */
.daily-badge{
  background:var(--accent-dim);border:1px solid var(--accent-glow);
  color:var(--accent);font-size:8px;padding:0 4px;border-radius:3px;
  font-family:'Syne',sans-serif;font-weight:700;letter-spacing:.2px;
  text-transform:uppercase;flex-shrink:0;
}

/* â”€â”€ PANEL PAGES (folders / tags shown inline below notes) â”€â”€ */
.side-panel{
  flex-shrink:0;border-top:1px solid var(--border);
  overflow:hidden;
  transition:max-height .28s cubic-bezier(.4,0,.2,1),opacity .22s ease;
  max-height:0;opacity:0;
}
.side-panel.open{opacity:1}
.side-panel-inner{padding:10px 12px 12px}
.side-panel-hdr{
  font-family:'Syne',sans-serif;font-size:9.5px;font-weight:700;
  letter-spacing:1.2px;text-transform:uppercase;color:var(--text3);
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:8px;
}
.sp-add-btn{
  background:none;border:1px dashed var(--border2);
  color:var(--text3);border-radius:6px;
  padding:2px 8px;font-size:10px;cursor:pointer;
  transition:var(--tr);font-family:'DM Sans',sans-serif;
  display:flex;align-items:center;gap:3px;
}
.sp-add-btn:hover{border-color:var(--accent-glow);color:var(--accent)}

/* folders */
.folder-list{display:flex;flex-direction:column;gap:1px}
.folder-item{
  display:flex;align-items:center;gap:6px;
  padding:5px 8px;border-radius:8px;cursor:pointer;
  transition:var(--tr);font-size:12px;color:var(--text2);position:relative;
}
.folder-item:hover{background:var(--surface2);color:var(--text)}
.folder-item.folder-active{background:var(--surface2);color:var(--accent)}
.folder-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:150px}
.folder-del{
  background:none;border:none;color:var(--text3);cursor:pointer;
  font-size:9.5px;padding:2px 4px;border-radius:4px;
  opacity:0;transition:var(--tr);flex-shrink:0;
}
.folder-item:hover .folder-del{opacity:1}
.folder-del:hover{color:var(--danger)}

/* tags */
.tags-flow{display:flex;flex-wrap:wrap;gap:5px}
.tag-chip{
  display:inline-flex;align-items:center;gap:3px;
  padding:3px 9px;border-radius:20px;font-size:10.5px;font-weight:500;
  cursor:default;transition:var(--tr);max-width:130px;
}
.tag-chip:hover{filter:brightness(1.1)}
.tag-chip-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:90px}
.tag-chip-del{
  background:none;border:none;cursor:pointer;
  font-size:8px;line-height:1;opacity:.5;color:inherit;padding:0;
  display:none;flex-shrink:0;
}
.tag-chip:hover .tag-chip-del{display:inline}
.tag-chip-del:hover{opacity:1}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   EDITOR AREA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.editor-area{display:flex;flex-direction:column;overflow:hidden;background:var(--bg);min-width:0}

.ed-topbar{
  padding:11px 20px;
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:8px;
  background:var(--surface);flex-shrink:0;
}
.title-inp{
  background:none;border:none;color:var(--text);
  font-family:'Syne',sans-serif;font-weight:700;font-size:18px;
  flex:1;outline:none;letter-spacing:-.3px;min-width:0;
}
.title-inp::placeholder{color:var(--text3)}
.topbar-right{display:flex;align-items:center;gap:4px;flex-shrink:0;flex-wrap:nowrap}
.tb-div{width:1px;height:16px;background:var(--border);flex-shrink:0}

/* folder select */
.folder-select{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text2);
  font-size:11px;font-family:'DM Sans',sans-serif;
  padding:5px 8px;outline:none;cursor:pointer;
  max-width:120px;transition:var(--tr);
}
.folder-select:hover,.folder-select:focus{border-color:var(--border2);color:var(--text)}

/* pin */
.pin-btn{
  width:30px;height:30px;border-radius:8px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text3);cursor:pointer;transition:var(--tr);
  display:flex;align-items:center;justify-content:center;font-size:13px;
}
.pin-btn:hover{border-color:var(--accent-glow);color:var(--accent)}
.pin-btn.pinned{color:var(--accent);border-color:var(--accent-glow);background:var(--accent-dim)}

/* tag picker */
.tp-wrap{position:relative}
.tp-btn{
  background:var(--surface2);border:1px solid var(--border);
  border-radius:8px;color:var(--text2);
  padding:5px 8px;cursor:pointer;transition:var(--tr);
  display:flex;align-items:center;gap:3px;
  max-width:150px;overflow:hidden;flex-shrink:0;font-size:11px;
}
.tp-btn:hover,.tp-btn.open{border-color:var(--border2);color:var(--text)}
.tp-tag-pill{display:inline-flex;align-items:center;padding:1px 5px;border-radius:10px;font-size:9.5px;font-weight:500;flex-shrink:0;white-space:nowrap}

/* topbar icon buttons */
.tb-icon{
  width:30px;height:30px;border-radius:8px;
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text3);cursor:pointer;transition:var(--tr);
  display:flex;align-items:center;justify-content:center;font-size:13px;
}
.tb-icon:hover{background:var(--surface3);color:var(--text);border-color:var(--border2)}
.tb-icon.active{color:var(--accent);background:var(--accent-dim);border-color:var(--accent-glow)}

/* save */
.save-btn{
  background:var(--surface2);border:1px solid var(--border);
  color:var(--text2);border-radius:8px;
  padding:5px 11px;font-family:'Syne',sans-serif;font-weight:600;font-size:11px;
  cursor:pointer;transition:var(--tr);display:flex;align-items:center;gap:4px;flex-shrink:0;
}
.save-btn:hover{border-color:var(--border2);color:var(--text)}
.save-btn.saved{color:var(--accent);border-color:var(--accent-glow)}

/* tabs */
.ed-tabs{display:flex;padding:0 20px;border-bottom:1px solid var(--border);background:var(--surface);flex-shrink:0}
.ed-tab{
  background:none;border:none;border-bottom:2px solid transparent;
  color:var(--text3);font-family:'Syne',sans-serif;font-size:10.5px;font-weight:600;
  letter-spacing:.4px;padding:8px 14px;cursor:pointer;transition:var(--tr);text-transform:uppercase;
}
.ed-tab:hover{color:var(--text)}
.ed-tab.active{color:var(--accent);border-bottom-color:var(--accent)}

/* formatting toolbar */
.toolbar{
  padding:5px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:2px;flex-wrap:wrap;
  background:var(--surface);flex-shrink:0;
}
.tb-btn{
  background:none;border:1px solid transparent;
  color:var(--text3);border-radius:7px;
  padding:4px 8px;cursor:pointer;font-size:12px;
  font-family:'DM Sans',sans-serif;font-weight:500;
  transition:var(--tr);line-height:1.3;display:flex;align-items:center;gap:3px;
}
.tb-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--border)}
.tb-sep{width:1px;height:15px;background:var(--border);margin:0 2px;flex-shrink:0}
.tb-hist{
  background:none;border:1px solid var(--border);
  color:var(--text3);border-radius:7px;padding:4px 7px;
  cursor:pointer;font-size:11px;font-family:'DM Sans',sans-serif;
  transition:var(--tr);display:flex;align-items:center;line-height:1;
}
.tb-hist:hover:not(:disabled){background:var(--surface2);color:var(--text)}
.tb-hist:disabled{opacity:.3;cursor:not-allowed}

/* editor body */
.editor{
  flex:1;padding:24px 28px;overflow-y:auto;outline:none;
  font-size:14.5px;line-height:1.9;color:var(--text);
  font-family:'DM Sans',sans-serif;font-weight:300;
  scrollbar-width:thin;scrollbar-color:var(--border) transparent;
  caret-color:var(--accent);
}
.editor::-webkit-scrollbar{width:3px}
.editor::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
.editor:empty::before{content:attr(data-placeholder);color:var(--text3);pointer-events:none;font-style:italic}
.editor b,.editor strong{font-weight:700;color:var(--text)}
.editor i,.editor em{font-style:italic}
.editor u{text-decoration:underline;text-decoration-color:var(--accent-glow)}
.editor h1{font-family:'Syne',sans-serif;font-size:1.9em;font-weight:800;margin:.6em 0 .3em;color:var(--text)}
.editor h2{font-family:'Syne',sans-serif;font-size:1.45em;font-weight:700;margin:.5em 0 .25em}
.editor h3{font-family:'Syne',sans-serif;font-size:1.15em;font-weight:600;margin:.4em 0 .2em}
.editor p{margin:.2em 0}
.editor blockquote{border-left:2px solid var(--accent);padding:6px 14px;color:var(--text2);margin:10px 0;background:var(--accent-dim);border-radius:0 6px 6px 0}
.editor ul,.editor ol{margin:5px 0;padding-left:22px}
.editor li{margin:2px 0}
.editor code{background:var(--surface3);border:1px solid var(--border);border-radius:5px;padding:2px 6px;font-family:monospace;font-size:12px;color:var(--accent2)}
.editor hr{border:none;border-top:1px solid var(--border);margin:14px 0}
.editor a{color:var(--accent2);text-underline-offset:2px}
.editor img{max-width:100%;border-radius:8px;margin:8px 0;display:block;border:1px solid var(--border)}
.editor .checklist-item{display:flex;align-items:flex-start;gap:8px;margin:4px 0;list-style:none}
.editor .checklist-item input[type=checkbox]{width:14px;height:14px;cursor:pointer;accent-color:var(--accent);flex-shrink:0;margin-top:4px}
.editor .checklist-item.done span{text-decoration:line-through;opacity:.45}
.note-link{color:var(--accent2);text-decoration:underline;text-decoration-style:dotted;cursor:pointer}

/* footer */
.ed-footer{
  padding:6px 18px;border-top:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  font-size:10.5px;color:var(--text3);
  background:var(--surface);flex-shrink:0;
}
.footer-left{display:flex;align-items:center;gap:12px}
.wc-goal{cursor:pointer}
.wc-goal.near{color:var(--accent2)}
.wc-goal.done{color:var(--accent)}

/* pomodoro bar */
.pomo-bar{
  padding:7px 18px;border-top:1px solid var(--border);
  display:flex;align-items:center;gap:9px;
  background:var(--surface);flex-shrink:0;
}
.pomo-timer{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:var(--accent);letter-spacing:-.5px;min-width:42px;flex-shrink:0}
.pomo-timer.break{color:#38bdf8}
.pomo-timer.danger{color:var(--danger)}
.pomo-lbl{font-size:10px;color:var(--text3);white-space:nowrap;font-family:'Syne',sans-serif}
.pomo-progress{flex:1;height:3px;background:var(--surface3);border-radius:2px;overflow:hidden;min-width:0}
.pomo-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .5s linear}
.pomo-fill.break{background:#38bdf8}
.pomo-btn{
  background:none;border:1px solid var(--border);border-radius:7px;color:var(--text3);
  padding:3px 9px;font-size:10px;cursor:pointer;transition:var(--tr);
  font-family:'Syne',sans-serif;font-weight:600;white-space:nowrap;flex-shrink:0;
}
.pomo-btn:hover{background:var(--surface2);color:var(--text)}
.pomo-btn.running{color:var(--accent);border-color:var(--accent-glow)}

/* canvas */
.canvas-toolbar{
  padding:7px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:5px;flex-wrap:wrap;
  background:var(--surface);flex-shrink:0;
}
.ct-btn{background:none;border:1px solid transparent;color:var(--text3);border-radius:7px;padding:4px 8px;cursor:pointer;font-size:11px;transition:var(--tr);display:flex;align-items:center;gap:3px}
.ct-btn:hover{background:var(--surface2);color:var(--text);border-color:var(--border)}
.ct-btn.active{background:var(--surface2);border-color:var(--accent-glow);color:var(--accent)}
.ct-color{width:19px;height:19px;border-radius:50%;border:2px solid rgba(255,255,255,.15);cursor:pointer;transition:var(--tr);flex-shrink:0}
.ct-color:hover{transform:scale(1.2)}
.ct-size{background:var(--surface2);border:1px solid var(--border);border-radius:7px;color:var(--text);font-size:11px;padding:3px 6px;outline:none;cursor:pointer;width:74px}
.canvas-wrap{flex:1;overflow:hidden;position:relative;background:var(--bg)}
#drawCanvas{display:block;cursor:crosshair;touch-action:none}

/* no-note */
.no-note{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--text3)}
.no-note-icon{font-size:44px;opacity:.1}
.no-note h2{font-family:'Syne',sans-serif;font-weight:700;font-size:15px;color:var(--text3);opacity:.35}
.no-note p{font-size:12px;text-align:center;max-width:210px;line-height:1.7;opacity:.3}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DROPDOWNS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dropdown{
  position:absolute;background:var(--surface);
  border:1px solid var(--border2);border-radius:var(--r-lg);
  padding:5px;min-width:175px;z-index:300;
  box-shadow:var(--sh-lg);
  animation:dropIn .15s cubic-bezier(.34,1.4,.64,1);
}
@keyframes dropIn{from{opacity:0;transform:translateY(-6px) scale(.96)}to{opacity:1;transform:translateY(0) scale(1)}}
.dd-item{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:8px;cursor:pointer;transition:var(--tr);font-size:12px;color:var(--text)}
.dd-item:hover{background:var(--surface2);color:var(--accent)}
.dd-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.dd-check{margin-left:auto;color:var(--accent);font-size:11px;opacity:0}
.dd-item.sel .dd-check{opacity:1}
.dd-item.sel{background:var(--surface2)}
.dd-new{color:var(--accent);display:flex;align-items:center;gap:5px;padding:7px 9px;border-radius:8px;cursor:pointer;transition:var(--tr);font-size:11.5px}
.dd-new:hover{background:var(--accent-dim)}
.dd-sep{height:1px;background:var(--border);margin:4px 0}
.tp-drop{top:calc(100% + 6px);right:0}
.exp-drop{top:calc(100% + 6px);right:0}

/* link suggest */
.link-suggest{position:fixed;background:var(--surface);border:1px solid var(--border2);border-radius:var(--r);padding:4px;min-width:195px;z-index:400;box-shadow:var(--sh-lg);animation:dropIn .15s ease}
.link-opt{padding:6px 10px;border-radius:7px;cursor:pointer;font-size:12px;transition:var(--tr)}
.link-opt:hover{background:var(--surface2);color:var(--accent)}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERLAYS / MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.72);
  backdrop-filter:blur(7px);z-index:500;
  display:flex;align-items:center;justify-content:center;
  animation:fadeIn .18s ease;padding:20px;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.overlay.hiding{animation:fadeIn .14s ease reverse;pointer-events:none}

.modal{
  background:var(--surface);border:1px solid var(--border2);
  border-radius:18px;padding:24px;
  max-width:430px;width:100%;
  box-shadow:var(--sh-lg);
  animation:mIn .22s cubic-bezier(.34,1.3,.64,1);
  position:relative;overflow:hidden;
  max-height:calc(100vh - 40px);overflow-y:auto;
}
@keyframes mIn{from{opacity:0;transform:scale(.91) translateY(14px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-stripe{position:absolute;top:0;left:0;right:0;height:3px}
.stripe-danger{background:linear-gradient(90deg,var(--danger),#f87171)}
.stripe-purple{background:linear-gradient(90deg,var(--accent2),#a78bfa)}
.stripe-green{background:linear-gradient(90deg,var(--accent),#86efac)}
.stripe-orange{background:linear-gradient(90deg,#f59e0b,#fb923c)}
.stripe-blue{background:linear-gradient(90deg,#38bdf8,var(--accent2))}
.stripe-pink{background:linear-gradient(90deg,#d946ef,var(--accent2))}

.modal-icon{width:42px;height:42px;border-radius:11px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:14px}
.modal h3{font-family:'Syne',sans-serif;font-weight:700;font-size:16px;margin-bottom:5px;color:var(--text)}
.modal .subtitle{color:var(--text2);font-size:12.5px;line-height:1.6}
.note-name-prev{display:block;background:var(--surface2);border:1px solid var(--border);border-radius:7px;padding:7px 10px;font-size:12px;margin:10px 0 16px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:var(--text)}

.f-label{display:block;font-size:9.5px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin:12px 0 5px}
.f-inp{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:9px 11px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;outline:none;transition:var(--tr)}
.f-inp:focus{border-color:var(--accent-glow)}
.f-inp::placeholder{color:var(--text3)}

.m-actions{display:flex;gap:8px;margin-top:18px}
.btn-cancel{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:var(--r);padding:10px;font-family:'Syne',sans-serif;font-weight:600;font-size:13px;cursor:pointer;transition:var(--tr)}
.btn-cancel:hover{background:var(--surface3)}
.btn-danger{flex:1;background:var(--danger);border:none;color:#fff;border-radius:var(--r);padding:10px;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;cursor:pointer;transition:var(--tr)}
.btn-danger:hover{filter:brightness(1.1);transform:translateY(-1px)}
.btn-accent{flex:1;background:var(--accent);border:none;color:#0d0d11;border-radius:var(--r);padding:10px;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;cursor:pointer;transition:var(--tr)}
.btn-accent:hover{filter:brightness(1.08);transform:translateY(-1px)}
.btn-purple{flex:1;background:var(--accent2);border:none;color:#fff;border-radius:var(--r);padding:10px;font-family:'Syne',sans-serif;font-weight:700;font-size:13px;cursor:pointer;transition:var(--tr)}
.btn-purple:hover{filter:brightness(1.1);transform:translateY(-1px)}

/* tag color picker */
.swatches{display:grid;grid-template-columns:repeat(8,1fr);gap:5px;margin-bottom:3px}
.swatch{width:100%;aspect-ratio:1;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:var(--tr)}
.swatch:hover{transform:scale(1.14)}
.swatch.sel{border-color:#fff;box-shadow:0 0 0 2px rgba(255,255,255,.2)}
.color-row{display:flex;align-items:center;gap:7px;margin-top:7px}
.color-dot{width:17px;height:17px;border-radius:50%;flex-shrink:0;border:2px solid rgba(255,255,255,.15)}
.hex-wrap{flex:1;display:flex;align-items:center;gap:6px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:5px 9px;transition:var(--tr)}
.hex-wrap:focus-within{border-color:var(--accent-glow)}
.hex-inp{background:none;border:none;color:var(--text);font-family:monospace;font-size:12px;outline:none;width:68px}
.color-native{width:27px;height:27px;border:1px solid var(--border);background:none;cursor:pointer;padding:2px;border-radius:7px}
.tag-prev-row{display:flex;align-items:center;gap:8px;margin-top:10px;background:var(--surface2);border-radius:var(--r);padding:8px 11px}
.tag-prev-lbl{font-size:11px;color:var(--text3)}
.tag-prev-pill{font-size:11px;padding:2px 9px;border-radius:20px;font-weight:500}

/* icon grid for folders */
.icons-grid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:4px}
.icon-opt{font-size:18px;cursor:pointer;padding:5px;border-radius:7px;border:1px solid transparent;transition:var(--tr)}
.icon-opt:hover{background:var(--surface2)}
.icon-opt.sel{border-color:var(--accent-glow);background:var(--accent-dim)}

/* templates grid */
.tmpl-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:10px;max-height:290px;overflow-y:auto;scrollbar-width:thin}
.tmpl-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px;cursor:pointer;transition:var(--tr)}
.tmpl-card:hover{border-color:var(--accent-glow);background:var(--accent-dim)}
.tmpl-icon{font-size:20px;margin-bottom:5px}
.tmpl-name{font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;margin-bottom:2px}
.tmpl-desc{font-size:10.5px;color:var(--text3);line-height:1.4}

/* stats */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-top:12px}
.stat-card{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px;text-align:center}
.stat-num{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--accent);line-height:1}
.stat-lbl{font-size:9px;color:var(--text3);margin-top:3px;text-transform:uppercase;letter-spacing:.5px}
.heatmap{margin-top:12px;background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px}
.heatmap-title{font-size:9.5px;font-family:'Syne',sans-serif;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-bottom:8px}
.heatmap-grid{display:flex;flex-wrap:wrap;gap:3px}
.hm-cell{width:10px;height:10px;border-radius:2px;background:var(--surface3)}
.hm-cell.l1{background:rgba(184,227,42,.25)}.hm-cell.l2{background:rgba(184,227,42,.5)}.hm-cell.l3{background:rgba(184,227,42,.75)}.hm-cell.l4{background:var(--accent)}

/* shortcuts */
.shortcuts-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:12px;max-height:310px;overflow-y:auto;scrollbar-width:thin}
.sc-row{display:flex;align-items:center;justify-content:space-between;background:var(--surface2);border-radius:7px;padding:7px 10px;font-size:11px}
.sc-action{color:var(--text2)}
.sc-keys{display:flex;gap:2px;align-items:center}
.sc-key{background:var(--surface3);border:1px solid var(--border);border-radius:4px;padding:1px 5px;font-family:monospace;font-size:9.5px;color:var(--text)}

/* AI */
.ai-mode-btns{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px}
.ai-mode-btn{background:var(--surface2);border:1px solid var(--border);color:var(--text3);border-radius:8px;padding:5px 10px;font-size:11px;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer;transition:var(--tr)}
.ai-mode-btn:hover{color:var(--text)}
.ai-mode-btn.active{background:var(--accent-dim);border-color:var(--accent-glow);color:var(--accent)}
.ai-result{background:var(--surface2);border:1px solid var(--border);border-radius:var(--r);padding:12px;min-height:70px;max-height:240px;overflow-y:auto;font-size:13px;line-height:1.7;color:var(--text);margin:10px 0;scrollbar-width:thin;white-space:pre-wrap}
.ai-loading::after{content:'...';animation:dots 1.2s infinite;display:inline-block;width:16px;text-align:left}
@keyframes dots{0%{content:'.'}33%{content:'..'}66%{content:'...'}}

/* toast */
.toast{
  position:fixed;bottom:18px;right:18px;
  background:var(--surface2);border:1px solid var(--border2);
  color:var(--text);padding:8px 14px;border-radius:var(--r);
  font-size:11.5px;font-weight:500;font-family:'Syne',sans-serif;
  box-shadow:var(--sh-lg);z-index:600;
  animation:toastIn .2s cubic-bezier(.34,1.4,.64,1);pointer-events:none;
  display:flex;align-items:center;gap:6px;
}
@keyframes toastIn{from{opacity:0;transform:translateY(8px) scale(.94)}to{opacity:1;transform:translateY(0) scale(1)}}
.toast.hide{animation:toastIn .18s ease reverse}

/* confirm popup */
.confirm-popup{
  position:fixed;background:var(--surface);border:1px solid var(--border2);
  border-radius:11px;padding:12px 13px;min-width:210px;z-index:550;
  box-shadow:var(--sh-lg);animation:dropIn .15s cubic-bezier(.34,1.4,.64,1);
}
.confirm-msg{font-size:12px;color:var(--text2);margin-bottom:10px;line-height:1.5}
.confirm-btns{display:flex;gap:6px}
.confirm-cancel{flex:1;background:var(--surface2);border:1px solid var(--border);color:var(--text);border-radius:7px;padding:6px;font-family:'Syne',sans-serif;font-weight:600;font-size:11px;cursor:pointer;transition:var(--tr)}
.confirm-cancel:hover{background:var(--surface3)}
.confirm-ok{flex:1;background:var(--danger);border:none;color:#fff;border-radius:7px;padding:6px;font-family:'Syne',sans-serif;font-weight:700;font-size:11px;cursor:pointer;transition:var(--tr)}
.confirm-ok:hover{filter:brightness(1.1)}

/* focus mode */
.focus-exit-btn{display:none;position:fixed;top:14px;right:14px;z-index:300;background:var(--accent-dim);border:1px solid var(--accent-glow);color:var(--accent);border-radius:8px;padding:6px 12px;font-size:11px;font-family:'Syne',sans-serif;font-weight:600;cursor:pointer;align-items:center;gap:4px}
.focus-exit-btn:hover{background:rgba(184,227,42,.2)}
body.focus-mode .rail{display:none}
body.focus-mode .sidebar{display:none}
body.focus-mode .app{grid-template-columns:1fr}
body.focus-mode .toolbar,.focus-mode .ed-tabs,.focus-mode .pomo-bar{display:none!important}
body.focus-mode .editor{padding:44px min(90px,10vw);font-size:15.5px}
body.focus-mode .focus-exit-btn{display:flex}
body.focus-mode .ed-topbar{padding:12px 32px}

/* split view */
.split-view{display:grid;grid-template-columns:1fr 1fr;height:100%;overflow:hidden}
.split-pane{display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border)}
.split-pane:last-child{border-right:none}
</style>
</head>
<body>
<div class="orb orb1"></div>
<div class="orb orb2"></div>
<button class="focus-exit-btn" onclick="toggleFocusMode()">âœ• Exit Focus</button>

<div class="app" id="app">

  <!-- â•â•â•â•â•â•â•â•â•â•â• ICON RAIL â•â•â•â•â•â•â•â•â•â•â• -->
  <nav class="rail" id="rail">
    <!-- Logo mark -->
    <div class="rail-logo" onclick="createNote()" title="New Note">
      <svg viewBox="0 0 24 24" fill="none" stroke="#0d0d11" stroke-width="2.8"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
    </div>

    <!-- New note -->
    <button class="rail-btn" onclick="createNote()" title="New Note">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      <span class="tip">New Note</span>
    </button>

    <!-- Templates -->
    <button class="rail-btn" onclick="openTemplates()" title="Templates">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="3" width="8" height="8" rx="1"/><rect x="3" y="13" width="8" height="8" rx="1"/><path d="M13 17h8M17 13v8"/></svg>
      <span class="tip">Templates</span>
    </button>

    <div class="rail-sep"></div>

    <!-- Notes view -->
    <button class="rail-btn active" id="railNotes" onclick="switchView('notes')" title="Notes">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
      <span class="tip">Notes</span>
    </button>

    <!-- Folders -->
    <button class="rail-btn" id="railFolders" onclick="togglePanel('folders')" title="Folders">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
      <span class="tip">Folders</span>
    </button>

    <!-- Tags -->
    <button class="rail-btn" id="railTags" onclick="togglePanel('tags')" title="Tags">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
      <span class="tip">Tags</span>
    </button>

    <!-- Bin -->
    <button class="rail-btn" id="railBin" onclick="switchView('bin')" title="Recycle Bin">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      <span class="tip">Recycle Bin</span>
    </button>

    <div class="rail-sep"></div>

    <!-- Daily note -->
    <button class="rail-btn" onclick="openDailyNote()" title="Today's Daily Note">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      <span class="tip">Daily Note</span>
    </button>

    <!-- Stats -->
    <button class="rail-btn" onclick="openStats()" title="Stats">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      <span class="tip">Stats</span>
    </button>

    <div class="rail-spacer"></div>

    <!-- Shortcuts -->
    <button class="rail-btn" onclick="openShortcuts()" title="Keyboard Shortcuts">
      <svg width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="2" y="6" width="20" height="12" rx="2"/><path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01M8 14h8"/></svg>
      <span class="tip">Shortcuts</span>
    </button>

    <!-- Theme -->
    <button class="rail-btn" id="themeBtn" onclick="toggleTheme()" title="Toggle Theme">
      <svg id="themeIco" width="17" height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
      <span class="tip">Toggle Theme</span>
    </button>
  </nav>

  <!-- â•â•â•â•â•â•â•â•â•â•â• SIDEBAR PANEL â•â•â•â•â•â•â•â•â•â•â• -->
  <aside class="sidebar" id="sidebar">
    <!-- Panel header with contextual title -->
    <div class="panel-hdr">
      <div class="panel-title">
        <span class="panel-title-lbl" id="panelTitleLbl">
          <span class="panel-icon">ğŸ“</span>
          <span id="panelTitleText">Notes</span>
        </span>
        <span class="cnt-pill" id="cnt">0</span>
      </div>
      <button class="btn-new" id="actionBtn" onclick="createNote()">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.8" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        New Note
      </button>
    </div>

    <!-- Search -->
    <div class="sb-search">
      <div class="search-wrap">
        <svg class="search-ico" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input type="text" class="search-inp" id="searchInp" placeholder="Search notesâ€¦" oninput="filterNotes(this.value)">
      </div>
    </div>

    <!-- Sort (hidden for folders/tags/bin panels) -->
    <div class="sort-row" id="sortRow">
      <span class="sort-lbl">Sort:</span>
      <select class="sort-sel" id="sortSel" onchange="renderList()">
        <option value="updated">Updated</option>
        <option value="created">Created</option>
        <option value="title">Title</option>
        <option value="pinned">Pinned first</option>
      </select>
    </div>

    <!-- List header -->
    <div class="list-header" id="listHdr">
      <span id="listHdrText">Notes</span>
    </div>

    <!-- Notes list -->
    <div class="notes-list" id="notesList" style="flex:1;min-height:0"></div>

    <!-- â”€â”€ FOLDERS PANEL (collapsible) â”€â”€ -->
    <div class="side-panel" id="foldersPanel">
      <div class="side-panel-inner">
        <div class="side-panel-hdr">
          <span>Folders</span>
          <button class="sp-add-btn" onclick="openFolderModal()">+ New</button>
        </div>
        <div class="folder-list" id="folderList"></div>
      </div>
    </div>

    <!-- â”€â”€ TAGS PANEL (collapsible) â”€â”€ -->
    <div class="side-panel" id="tagsPanel">
      <div class="side-panel-inner">
        <div class="side-panel-hdr">
          <span>Tags</span>
          <button class="sp-add-btn" onclick="openTagModal()">+ New</button>
        </div>
        <div class="tags-flow" id="tagsList"></div>
      </div>
    </div>
  </aside>

  <!-- â•â•â•â•â•â•â•â•â•â•â• EDITOR â•â•â•â•â•â•â•â•â•â•â• -->
  <main class="editor-area" id="edArea">
    <div class="no-note">
      <div class="no-note-icon">âœ¦</div>
      <h2>Select or create a note</h2>
      <p>Use the sidebar or the + button to begin writing.</p>
    </div>
  </main>
</div>

<script>
/* â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â• */
let notes = JSON.parse(localStorage.getItem('nf_notes')||'[]');
let bin   = JSON.parse(localStorage.getItem('nf_bin')||'[]');
let folders = JSON.parse(localStorage.getItem('nf_folders')||'[]');
const BUILT_TAGS=[
  {id:'personal',label:'Personal',color:'#9b87ff',builtin:true},
  {id:'work',label:'Work',color:'#b8e32a',builtin:true},
  {id:'idea',label:'Idea',color:'#fb923c',builtin:true},
  {id:'misc',label:'Misc',color:'#6b7280',builtin:true}
];
let cTags = JSON.parse(localStorage.getItem('nf_tags')||'[]');
const allTags  = ()=>[...BUILT_TAGS,...cTags];
const tagById  = id=>allTags().find(t=>t.id===id)||BUILT_TAGS[3];
const noteById = id=>notes.find(n=>n.id===id);

let activeId=null, saveTimer=null, curView='notes', activeFolder=null;
let lightMode = localStorage.getItem('nf_theme')==='light';
let splitMode=false, splitSecondId=null, focusMode=false;
let wcGoal = parseInt(localStorage.getItem('nf_wcgoal')||'0');
let canvasColor='#ffffff', brushSize=4, drawTool='pen';
let isDrawing=false, startX=0, startY=0, snapshot=null;
let pomoState={running:false,mode:'work',secs:25*60,interval:null,workMins:25,breakMins:5};
let openPanels={folders:false,tags:false};

const sv = k=>{
  const map={notes:'nf_notes',bin:'nf_bin',folders:'nf_folders',tags:'nf_tags'};
  const data={notes,bin,folders,tags:cTags};
  localStorage.setItem(map[k],JSON.stringify(data[k]));
};

/* â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â• */
const esc=s=>String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
function fd(ts){const d=Date.now()-ts;if(d<60e3)return'just now';if(d<36e5)return~~(d/6e4)+'m ago';if(d<864e5)return~~(d/36e5)+'h ago';return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'});}
function wc(h){const t=h.replace(/<[^>]*>/g,' ').trim();return t?t.split(/\s+/).filter(Boolean).length:0;}
function rt(w){const m=Math.ceil(w/200);return m<1?'<1 min':m+' min read';}
function tCss(c='#888'){const x=c.replace('#','');const r=parseInt(x.slice(0,2),16)||128,g=parseInt(x.slice(2,4),16)||128,b=parseInt(x.slice(4,6),16)||128;return`background:rgba(${r},${g},${b},.18);color:${c};`;}
function getSorted(arr){
  const s=document.getElementById('sortSel')?.value||'updated';const a=[...arr];
  if(s==='updated')a.sort((x,y)=>y.updatedAt-x.updatedAt);
  else if(s==='created')a.sort((x,y)=>y.createdAt-x.createdAt);
  else if(s==='title')a.sort((x,y)=>(x.title||'').localeCompare(y.title||''));
  else if(s==='pinned'){a.sort((x,y)=>y.updatedAt-x.updatedAt);a.sort((x,y)=>(y.pinned?1:0)-(x.pinned?1:0));}
  return a;
}
function todayStr(){return new Date().toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'});}
function todayKey(){const d=new Date();return`daily-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;}
function closeAllDropdowns(){
  document.querySelectorAll('.dropdown').forEach(d=>d.remove());
  document.querySelectorAll('.confirm-popup').forEach(d=>d.remove());
  document.querySelectorAll('.link-suggest').forEach(d=>d.remove());
  document.getElementById('tpBtn')?.classList.remove('open');
}

/* â•â•â•â•â•â•â•â• THEME â•â•â•â•â•â•â•â• */
function toggleTheme(){
  lightMode=!lightMode;
  document.body.classList.toggle('light',lightMode);
  localStorage.setItem('nf_theme',lightMode?'light':'dark');
  updateThemeIcon();
}
function updateThemeIcon(){
  const ico=document.getElementById('themeIco');if(!ico)return;
  ico.innerHTML=lightMode
    ?'<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'
    :'<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>';
}
if(lightMode){document.body.classList.add('light');updateThemeIcon();}

/* â•â•â•â•â•â•â•â• PANEL TOGGLE â•â•â•â•â•â•â•â• */
function togglePanel(name){
  // Toggle open/close
  openPanels[name]=!openPanels[name];
  const panel=document.getElementById(name+'Panel');
  const railBtn=document.getElementById('rail'+name.charAt(0).toUpperCase()+name.slice(1));
  if(openPanels[name]){
    // measure content height
    panel.style.maxHeight='0px';
    panel.style.opacity='0';
    panel.classList.add('open');
    requestAnimationFrame(()=>{
      const inner=panel.querySelector('.side-panel-inner');
      panel.style.maxHeight=(inner.scrollHeight+20)+'px';
      panel.style.opacity='1';
    });
    railBtn?.classList.add('active');
  } else {
    panel.style.maxHeight='0px';
    panel.style.opacity='0';
    panel.classList.remove('open');
    railBtn?.classList.remove('active');
  }
}

/* â•â•â•â•â•â•â•â• VIEW SWITCH â•â•â•â•â•â•â•â• */
function switchView(v){
  curView=v;
  // rail highlights
  ['Notes','Folders','Bin'].forEach(n=>document.getElementById('rail'+n)?.classList.remove('active'));
  if(v==='notes')document.getElementById('railNotes')?.classList.add('active');
  if(v==='bin')document.getElementById('railBin')?.classList.add('active');

  // header text & icon
  const icons={notes:'ğŸ“',bin:'ğŸ—‘ï¸',folders:'ğŸ“'};
  const texts={notes:'Notes',bin:'Recycle Bin',folders:'Folders'};
  document.getElementById('panelTitleText').textContent=texts[v]||'Notes';
  document.querySelector('.panel-icon').textContent=icons[v]||'ğŸ“';

  document.getElementById('sortRow').style.display=v==='bin'?'none':'flex';
  document.getElementById('listHdrText').textContent=texts[v]||'Notes';

  if(v==='bin'&&activeId){activeId=null;showEmpty();}
  renderList();
}

/* â•â•â•â•â•â•â•â• FOLDERS â•â•â•â•â•â•â•â• */
function renderFolders(){
  const el=document.getElementById('folderList');if(!el)return;el.innerHTML='';
  const all=document.createElement('div');all.className='folder-item'+(activeFolder===null?' folder-active':'');
  all.innerHTML='<span>ğŸ“</span><span class="folder-name">All Notes</span>';
  all.onclick=()=>{activeFolder=null;renderList();renderFolders();};
  el.appendChild(all);
  folders.forEach(f=>{
    const nm=f.name.length>18?f.name.slice(0,18)+'â€¦':f.name;
    const d=document.createElement('div');
    d.className='folder-item'+(activeFolder===f.id?' folder-active':'');
    d.innerHTML=`<span>${f.icon||'ğŸ“'}</span><span class="folder-name" title="${esc(f.name)}">${esc(nm)}</span><button class="folder-del" onclick="delFolder('${f.id}',event)">âœ•</button>`;
    d.onclick=e=>{if(e.target.classList.contains('folder-del'))return;activeFolder=f.id;renderList();renderFolders();};
    el.appendChild(d);
  });
}

let selFolderIcon='ğŸ“';
function openFolderModal(){
  closeAllDropdowns();
  const icons=['ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ’¼','ğŸ ','ğŸ¯','ğŸš€','ğŸ’¡','â¤ï¸','ğŸŒ¿','ğŸ”¬','ğŸ¨','ğŸ“š','ğŸ’°','ğŸ‹ï¸','âš¡'];
  const ov=mkOverlay('folderMod');
  ov.innerHTML=`<div class="modal"><div class="modal-stripe stripe-orange"></div>
    <div class="modal-icon" style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25)">ğŸ“</div>
    <h3>New Folder</h3>
    <label class="f-label">Name</label>
    <input class="f-inp" id="fni" maxlength="28" placeholder="e.g. Work Projectsâ€¦">
    <label class="f-label">Icon</label>
    <div class="icons-grid" id="iconGrid">${icons.map(ic=>`<span class="icon-opt" onclick="pickFIcon('${ic}',this)">${ic}</span>`).join('')}</div>
    <div class="m-actions">
      <button class="btn-cancel" onclick="closeModal('folderMod')">Cancel</button>
      <button class="btn-accent" onclick="saveFolder()">Create</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click',e=>{if(e.target===ov)closeModal('folderMod');});
  setTimeout(()=>{document.getElementById('fni')?.focus();pickFIcon('ğŸ“',document.querySelector('#iconGrid .icon-opt'));},60);
}
function pickFIcon(ic,el){selFolderIcon=ic;document.querySelectorAll('#iconGrid .icon-opt').forEach(s=>s.classList.remove('sel'));if(el)el.classList.add('sel');}
function saveFolder(){
  const name=document.getElementById('fni')?.value.trim();
  if(!name){showToast('âš ï¸ Enter a folder name');return;}
  folders.push({id:'f_'+Date.now(),name:name.slice(0,28),icon:selFolderIcon});
  sv('folders');closeModal('folderMod');renderFolders();showToast(`âœ“ Folder "${name}" created`);
  // open folders panel if closed
  if(!openPanels.folders)togglePanel('folders');
}
function delFolder(id,e){
  e&&e.stopPropagation();
  showConfirm(e.target,'Delete this folder? Notes move to All Notes.','Delete',()=>{
    notes.forEach(n=>{if(n.folder===id)delete n.folder;});sv('notes');
    folders=folders.filter(f=>f.id!==id);sv('folders');
    if(activeFolder===id)activeFolder=null;
    renderFolders();renderList();showToast('Folder deleted');
  });
}

/* â•â•â•â•â•â•â•â• TAGS â•â•â•â•â•â•â•â• */
function renderTags(){
  const el=document.getElementById('tagsList');if(!el)return;el.innerHTML='';
  allTags().forEach(t=>{
    const label=t.label.length>14?t.label.slice(0,14)+'â€¦':t.label;
    const c=document.createElement('span');
    c.className='tag-chip';c.style.cssText=tCss(t.color);c.title=t.label;
    c.innerHTML=`<span class="tag-chip-name">${esc(label)}</span>`+
      (!t.builtin?`<button class="tag-chip-del" onclick="removeTag('${t.id}',event)">âœ•</button>`:'');
    el.appendChild(c);
  });
}
function removeTag(id,e){
  e&&e.stopPropagation();cTags=cTags.filter(t=>t.id!==id);sv('tags');
  notes.forEach(n=>{if(n.tags?.includes(id))n.tags=n.tags.filter(x=>x!==id);if(!n.tags?.length)n.tags=['misc'];});sv('notes');
  renderTags();renderList();if(activeId)refreshTagBtn();showToast('Tag removed');
}

const SWATCHES=['#f05252','#fb923c','#facc15','#b8e32a','#34d399','#38bdf8','#7c5cfc','#d946ef','#fb7185','#c4a77a','#a3e4d7','#93c5fd','#a78bfa','#f9a8d4','#94a3b8','#f5f5f5'];
let pColor='#7c5cfc';
function openTagModal(){
  closeAllDropdowns();pColor='#7c5cfc';
  const ov=mkOverlay('tagMod');
  ov.innerHTML=`<div class="modal"><div class="modal-stripe stripe-purple"></div>
    <div class="modal-icon" style="background:var(--accent2-dim);border:1px solid rgba(124,92,252,.3)">ğŸ·ï¸</div>
    <h3>Create New Tag</h3>
    <label class="f-label">Name</label>
    <input class="f-inp" id="tni" maxlength="20" placeholder="e.g. Design, Healthâ€¦" oninput="syncTagPrev()">
    <label class="f-label">Color</label>
    <div class="swatches" id="swG">${SWATCHES.map(c=>`<div class="swatch${c===pColor?' sel':''}" style="background:${c}" data-c="${c}" onclick="pickSw('${c}')"></div>`).join('')}</div>
    <div class="color-row">
      <div class="hex-wrap"><div class="color-dot" id="cdot" style="background:${pColor}"></div><input class="hex-inp" id="hexI" value="${pColor}" maxlength="7" oninput="onHex(this.value)"></div>
      <input type="color" class="color-native" id="natP" value="${pColor}" oninput="onNat(this.value)">
    </div>
    <div class="tag-prev-row"><span class="tag-prev-lbl">Preview:</span><span class="tag-prev-pill" id="prevB" style="${tCss(pColor)}">New Tag</span></div>
    <div class="m-actions">
      <button class="btn-cancel" onclick="closeModal('tagMod')">Cancel</button>
      <button class="btn-purple" onclick="saveTag()">Create Tag</button>
    </div>
  </div>`;
  document.body.appendChild(ov);
  ov.addEventListener('click',e=>{if(e.target===ov)closeModal('tagMod');});
  setTimeout(()=>document.getElementById('tni')?.focus(),60);
}
function pickSw(c){pColor=c;document.querySelectorAll('#swG .swatch').forEach(s=>s.classList.toggle('sel',s.dataset.c===c));syncClr(c);}
function onHex(v){if(/^#[0-9a-fA-F]{6}$/.test(v)){pColor=v;syncClr(v,true);}}
function onNat(v){pColor=v;syncClr(v,false,true);}
function syncClr(c,sh=false,sn=false){
  const d=document.getElementById('cdot'),h=document.getElementById('hexI'),n=document.getElementById('natP');
  if(d)d.style.background=c;if(h&&!sh)h.value=c;if(n&&!sn)n.value=c;
  document.querySelectorAll('#swG .swatch').forEach(s=>s.classList.toggle('sel',s.dataset.c===c));syncTagPrev();
}
function syncTagPrev(){const b=document.getElementById('prevB'),i=document.getElementById('tni');if(!b)return;b.style.cssText=tCss(pColor);b.textContent=i?.value.trim()||'New Tag';}
function saveTag(){
  const name=document.getElementById('tni')?.value.trim();
  if(!name){showToast('âš ï¸ Enter a tag name');return;}
  cTags.push({id:'ct_'+Date.now(),label:name.slice(0,20),color:pColor,builtin:false});
  sv('tags');closeModal('tagMod');renderTags();if(activeId)refreshTagBtn();showToast(`âœ“ Tag "${name}" created`);
  if(!openPanels.tags)togglePanel('tags');
}

/* â•â•â•â•â•â•â•â• NOTES CRUD â•â•â•â•â•â•â•â• */
function createNote(content='',title=''){
  const n={id:Date.now().toString(),title,content,canvasData:'',tags:['misc'],pinned:false,folder:activeFolder||null,createdAt:Date.now(),updatedAt:Date.now()};
  notes.unshift(n);sv('notes');renderList();openNote(n.id);
  setTimeout(()=>document.getElementById('titleInp')?.focus(),60);
  return n;
}
function openNote(id){activeId=id;const n=noteById(id);if(!n)return;if(splitMode)renderSplitView();else renderEditor(n);renderList();}
function showEmpty(){document.getElementById('edArea').innerHTML=`<div class="no-note"><div class="no-note-icon">âœ¦</div><h2>Select or create a note</h2><p>Use the sidebar or the + button to begin writing.</p></div>`;}

/* â•â•â•â•â•â•â•â• RENDER EDITOR â•â•â•â•â•â•â•â• */
function renderEditor(n, paneEl=null){
  const target=paneEl||document.getElementById('edArea');
  const fOpts='<option value="">ğŸ“ No folder</option>'+folders.map(f=>`<option value="${f.id}"${n.folder===f.id?' selected':''}>${f.icon||'ğŸ“'} ${esc(f.name.slice(0,16))}</option>`).join('');
  target.innerHTML=`
  <div class="ed-topbar">
    <input class="title-inp" id="titleInp" placeholder="Untitled Note" value="${esc(n.title)}" oninput="updTitle(this.value)">
    <div class="topbar-right">
      <select class="folder-select" id="noteFolderSel" onchange="changeFolder(this.value)">${fOpts}</select>
      <div class="tb-div"></div>
      <button class="pin-btn${n.pinned?' pinned':''}" id="pinBtn" onclick="togglePin()" title="${n.pinned?'Unpin':'Pin'}">ğŸ“Œ</button>
      <div class="tp-wrap"><button class="tp-btn" id="tpBtn" onclick="toggleTagPicker(event)"></button></div>
      <div class="tb-div"></div>
      <button class="tb-icon${splitMode?' active':''}" onclick="toggleSplit()" title="Split View">â§‰</button>
      <button class="tb-icon" onclick="openAI()" title="AI Assistant">âœ¨</button>
      <div style="position:relative">
        <button class="tb-icon" onclick="toggleExpMenu(event)" title="Export">â¬‡</button>
      </div>
      <div class="tb-div"></div>
      <button class="save-btn" id="saveBtn" onclick="manualSave()">
        <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Save
      </button>
    </div>
  </div>
  <div class="ed-tabs">
    <button class="ed-tab active" id="tabWrite" onclick="switchTab('write')">âœ Write</button>
    <button class="ed-tab" id="tabCanvas" onclick="switchTab('canvas')">ğŸ¨ Canvas</button>
  </div>
  <div id="writePanel" style="display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0">
    <div class="toolbar">
      <button class="tb-btn" onclick="fmt('bold')"><b>B</b></button>
      <button class="tb-btn" onclick="fmt('italic')"><i>I</i></button>
      <button class="tb-btn" onclick="fmt('underline')"><u>U</u></button>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="fb('h1')">H1</button>
      <button class="tb-btn" onclick="fb('h2')">H2</button>
      <button class="tb-btn" onclick="fb('h3')">H3</button>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="fmt('insertUnorderedList')">â€¢ List</button>
      <button class="tb-btn" onclick="fmt('insertOrderedList')">1. List</button>
      <button class="tb-btn" onclick="insChecklist()">â˜‘ Check</button>
      <button class="tb-btn" onclick="fb('blockquote')"><i>" Quote</i></button>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="insHr()">â”€ Hr</button>
      <button class="tb-btn" onclick="insCode()">&lt;/&gt;</button>
      <button class="tb-btn" onclick="insImage()">ğŸ–¼</button>
      <button class="tb-btn" onclick="insLink()">ğŸ”—</button>
      <div class="tb-sep"></div>
      <button class="tb-hist" id="undoBtn" onclick="hUndo()" disabled title="Undo (Ctrl+Z)">â†©</button>
      <button class="tb-hist" id="redoBtn" onclick="hRedo()" disabled title="Redo (Ctrl+Y)">â†ª</button>
      <div class="tb-sep"></div>
      <button class="tb-btn" onclick="toggleFocusMode()" title="Focus (Ctrl+Shift+F)">ğŸ¯</button>
    </div>
    <div class="editor" id="ed" contenteditable="true" spellcheck="true"
      data-placeholder="Start writingâ€¦ Type [[ to link a note"
      oninput="onEd()" onkeyup="checkLink(event)"
      ondrop="onDrop(event)" ondragover="event.preventDefault()"></div>
    <div class="pomo-bar" id="pomoBar">
      <span class="pomo-timer" id="pomoTimer">25:00</span>
      <span class="pomo-lbl" id="pomoLbl">Work Session</span>
      <div class="pomo-progress"><div class="pomo-fill" id="pomoFill" style="width:100%"></div></div>
      <button class="pomo-btn" id="pomoBtnStart" onclick="pomoToggle()">â–¶ Start</button>
      <button class="pomo-btn" onclick="pomoReset()">â†º Reset</button>
      <button class="pomo-btn" onclick="pomoConfig()">âš™</button>
    </div>
    <div class="ed-footer">
      <div class="footer-left">
        <span id="wcEl">0 words</span>
        <span id="rtEl"></span>
        <span class="wc-goal" id="gcEl" style="display:none" onclick="setWcGoal()"></span>
      </div>
      <span id="updEl">${fd(n.updatedAt)}</span>
    </div>
  </div>
  <div id="canvasPanel" style="display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0">
    <div class="canvas-toolbar">
      <button class="ct-btn active" id="ctPen" onclick="setTool('pen')">âœ Pen</button>
      <button class="ct-btn" id="ctEraser" onclick="setTool('eraser')">â¬œ Eraser</button>
      <button class="ct-btn" id="ctLine" onclick="setTool('line')">/Line</button>
      <button class="ct-btn" id="ctRect" onclick="setTool('rect')">â–¡ Rect</button>
      <button class="ct-btn" id="ctCircle" onclick="setTool('circle')">â—‹ Circle</button>
      <div class="tb-sep" style="height:15px"></div>
      ${['#ffffff','#b8e32a','#7c5cfc','#f05252','#fb923c','#38bdf8','#34d399'].map(c=>`<div class="ct-color" style="background:${c}" onclick="setCanvasColor('${c}')"></div>`).join('')}
      <input type="color" class="color-native" id="canvasColorPick" value="${canvasColor}" oninput="setCanvasColor(this.value)">
      <div class="tb-sep" style="height:15px"></div>
      <select class="ct-size" id="ctSz" onchange="setBrushSize(this.value)">
        <option value="2">Fine</option><option value="4" selected>Normal</option>
        <option value="8">Bold</option><option value="16">Thick</option><option value="32">Brush</option>
      </select>
      <div class="tb-sep" style="height:15px"></div>
      <button class="ct-btn" onclick="clearCanvas()">ğŸ—‘ Clear</button>
      <button class="ct-btn" onclick="downloadCanvas()">â†“ PNG</button>
    </div>
    <div class="canvas-wrap" id="canvasWrap"><canvas id="drawCanvas"></canvas></div>
  </div>`;
  const ed=document.getElementById('ed');ed.innerHTML=n.content;
  hPush(n.id,n.content);hUpdBtns();updWC();refreshTagBtn();
  setTimeout(()=>initCanvas(n),50);
  renderPomoUI();
}

/* â•â•â•â•â•â•â•â• TAG PICKER â•â•â•â•â•â•â•â• */
function refreshTagBtn(){
  const btn=document.getElementById('tpBtn');const n=noteById(activeId);if(!btn||!n)return;
  const tags=n.tags||['misc'];
  const pills=tags.slice(0,2).map(tid=>{const t=tagById(tid);return`<span class="tp-tag-pill" style="${tCss(t.color)}">${esc(t.label.slice(0,9))}</span>`;}).join('');
  const more=tags.length>2?`<span style="color:var(--text3);font-size:10px">+${tags.length-2}</span>`:'';
  btn.innerHTML=pills+more+`<svg width="8" height="8" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" style="margin-left:2px;opacity:.45"><polyline points="6 9 12 15 18 9"/></svg>`;
}
function toggleTagPicker(e){
  e&&e.stopPropagation();closeAllDropdowns();
  const btn=document.getElementById('tpBtn');if(!btn)return;
  btn.classList.add('open');
  const n=noteById(activeId);const cur=n?.tags||['misc'];
  const dd=document.createElement('div');dd.id='tpDd';dd.className='dropdown tp-drop';
  allTags().forEach(t=>{
    const sel=cur.includes(t.id);
    const o=document.createElement('div');o.className='dd-item'+(sel?' sel':'');
    o.innerHTML=`<span class="dd-dot" style="background:${t.color}"></span>${esc(t.label)}<span class="dd-check">âœ“</span>`;
    o.onclick=ev=>{ev.stopPropagation();if(!n)return;if(cur.includes(t.id)){n.tags=cur.filter(x=>x!==t.id);if(!n.tags.length)n.tags=['misc'];}else n.tags=[...cur,t.id];n.updatedAt=Date.now();sv('notes');refreshTagBtn();renderList();dd.remove();btn.classList.remove('open');toggleTagPicker();};
    dd.appendChild(o);
  });
  const sep=document.createElement('div');sep.className='dd-sep';
  const nw=document.createElement('div');nw.className='dd-new';nw.innerHTML='<svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> New tagâ€¦';
  nw.onclick=ev=>{ev.stopPropagation();dd.remove();btn.classList.remove('open');openTagModal();};
  dd.appendChild(sep);dd.appendChild(nw);
  btn.parentElement.appendChild(dd);
  setTimeout(()=>{const h=ev=>{if(!dd.contains(ev.target)&&ev.target!==btn){dd.remove();btn.classList.remove('open');document.removeEventListener('click',h);}};document.addEventListener('click',h);},10);
}
function changeFolder(fid){const n=noteById(activeId);if(!n)return;n.folder=fid||null;n.updatedAt=Date.now();sv('notes');renderList();}

/* â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â• */
function toggleExpMenu(e){
  e&&e.stopPropagation();closeAllDropdowns();
  const btn=e.currentTarget;
  const dd=document.createElement('div');dd.id='expDd';dd.className='dropdown exp-drop';
  [['ğŸ“„ PDF','expPDF'],['ğŸ“ Word (.doc)','expWord'],['â¬‡ Markdown','expMD'],['ğŸ“ƒ Plain Text','expTXT']].forEach(([lbl,fn])=>{
    const o=document.createElement('div');o.className='dd-item';o.textContent=lbl;o.onclick=ev=>{ev.stopPropagation();dd.remove();window[fn]();};dd.appendChild(o);
  });
  btn.parentElement.appendChild(dd);
  setTimeout(()=>{const h=ev=>{if(!dd.contains(ev.target)){dd.remove();document.removeEventListener('click',h);}};document.addEventListener('click',h);},10);
}

/* â•â•â•â•â•â•â•â• SPLIT VIEW â•â•â•â•â•â•â•â• */
function toggleSplit(){splitMode=!splitMode;if(!splitMode){splitSecondId=null;if(activeId)openNote(activeId);else showEmpty();}else renderSplitView();}
function renderSplitView(){
  if(!activeId){showEmpty();splitMode=false;return;}
  const area=document.getElementById('edArea');
  area.innerHTML='<div class="split-view" id="sv"><div class="split-pane" id="pane1"></div><div class="split-pane" id="pane2"></div></div>';
  const n1=noteById(activeId);if(n1)renderEditor(n1,document.getElementById('pane1'));
  const p2=document.getElementById('pane2');
  if(splitSecondId){const n2=noteById(splitSecondId);if(n2){renderEditor(n2,p2);return;}}
  p2.innerHTML=`<div class="no-note"><div class="no-note-icon" style="font-size:34px;opacity:.1">â§‰</div><h2 style="font-size:13px">Pick a second note</h2><div style="display:flex;flex-direction:column;gap:4px;width:86%;max-height:55vh;overflow-y:auto;scrollbar-width:thin">${notes.filter(n=>n.id!==activeId).slice(0,10).map(n=>`<div onclick="openSecond('${n.id}')" style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:7px 11px;font-size:11.5px;cursor:pointer;font-family:'Syne',sans-serif;font-weight:600;transition:all .15s" onmouseover="this.style.borderColor='var(--accent-glow)'" onmouseout="this.style.borderColor='var(--border)'">${esc(n.title)||'Untitled'}</div>`).join('')}</div></div>`;
}
function openSecond(id){splitSecondId=id;renderSplitView();}

/* â•â•â•â•â•â•â•â• FOCUS â•â•â•â•â•â•â•â• */
function toggleFocusMode(){focusMode=!focusMode;document.body.classList.toggle('focus-mode',focusMode);}

/* â•â•â•â•â•â•â•â• RENDER LIST â•â•â•â•â•â•â•â• */
function renderList(filter=''){
  const list=document.getElementById('notesList'),cntEl=document.getElementById('cnt');
  if(!list||!cntEl)return;
  const q=(filter||document.getElementById('searchInp')?.value||'').toLowerCase();
  let src=curView==='bin'?bin:notes;
  if(curView==='folders'&&activeFolder)src=notes.filter(n=>n.folder===activeFolder);
  const fil=src.filter(n=>!q||n.title.toLowerCase().includes(q)||n.content.replace(/<[^>]*>/g,'').toLowerCase().includes(q));
  const sorted=getSorted(fil);
  cntEl.textContent=sorted.length;list.innerHTML='';
  if(curView==='bin'&&bin.length){const eb=document.createElement('button');eb.className='bin-empty-btn';eb.textContent='ğŸ—‘ Empty Recycle Bin';eb.onclick=emptyBin;list.appendChild(eb);}
  if(!sorted.length){const e=document.createElement('div');e.className='empty-state';e.innerHTML=q?`<p>No matches for "<strong>${esc(q)}</strong>"</p>`:(curView==='bin'?`<p>Bin is empty</p>`:`<p>No notes yet.<br>Click <strong>New Note</strong> to start.</p>`);list.appendChild(e);return;}
  sorted.forEach((n,i)=>{
    const tags=n.tags||['misc'];
    const el=document.createElement('div');
    el.className='note-item'+(n.id===activeId?' active':'');el.dataset.id=n.id;el.style.animationDelay=(i*14)+'ms';
    const pills=tags.slice(0,2).map(tid=>{const t=tagById(tid);return`<span class="ni-tag" style="${tCss(t.color)}">${esc(t.label.slice(0,8))}</span>`;}).join('');
    const dBadge=n.dailyKey?'<span class="daily-badge">daily</span> ':'';
    const pin=n.pinned?'<span class="ni-pin">ğŸ“Œ</span>':'';
    const prev=n.content.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim().slice(0,60)||'Empty note';
    el.innerHTML=`<div class="ni-row1"><span class="ni-title">${dBadge}${esc(n.title)||'Untitled Note'}</span>${pin}</div><div class="ni-prev">${esc(prev)}</div><div class="ni-meta"><span class="ni-date">${fd(n.updatedAt)}</span><div class="ni-tags">${pills}</div></div>`;
    const acts=document.createElement('div');acts.className='item-acts';
    if(curView==='bin'){acts.innerHTML=`<button class="item-act restore" onclick="restoreNote('${n.id}',event)" title="Restore">â†©</button><button class="item-act" onclick="permDel('${n.id}',event)" title="Delete permanently">âœ•</button>`;}
    else{acts.innerHTML=`<button class="item-act" onclick="askDel('${n.id}',event)" title="Move to bin">âœ•</button>`;el.addEventListener('click',()=>openNote(n.id));}
    el.appendChild(acts);list.appendChild(el);
  });
}
function filterNotes(v){renderList(v);}

/* â•â•â•â•â•â•â•â• EDITOR OPS â•â•â•â•â•â•â•â• */
function updTitle(v){const n=noteById(activeId);if(!n)return;n.title=v;n.updatedAt=Date.now();scheduleSave();const t=document.querySelector(`.note-item[data-id="${activeId}"] .ni-title`);if(t)t.textContent=v||'Untitled Note';}
function onEd(){
  const n=noteById(activeId),ed=document.getElementById('ed');if(!n||!ed)return;
  n.content=ed.innerHTML;n.updatedAt=Date.now();hPush(activeId,ed.innerHTML);
  const p=document.querySelector(`.note-item[data-id="${activeId}"] .ni-prev`);if(p)p.textContent=ed.innerText.replace(/\s+/g,' ').trim().slice(0,60)||'Empty note';
  updWC();scheduleSave();
}
function updWC(){
  const ed=document.getElementById('ed');if(!ed)return;const c=wc(ed.innerHTML);
  const we=document.getElementById('wcEl'),re=document.getElementById('rtEl'),ge=document.getElementById('gcEl');
  if(we)we.textContent=c+' word'+(c!==1?'s':'');
  if(re)re.textContent=rt(c);
  if(ge&&wcGoal){const p=Math.min(100,Math.round(c/wcGoal*100));ge.textContent=`${c}/${wcGoal} (${p}%)`;ge.style.display='inline';ge.className='wc-goal'+(p>=100?' done':p>=80?' near':'');}
  else if(ge)ge.style.display='none';
}
function setWcGoal(){const g=prompt('Word count goal (0 = off):',wcGoal);if(g!==null&&!isNaN(g)){wcGoal=Math.max(0,parseInt(g));localStorage.setItem('nf_wcgoal',wcGoal);updWC();}}
function scheduleSave(){
  clearTimeout(saveTimer);
  const b=document.getElementById('saveBtn');if(b)b.textContent='Savingâ€¦';
  saveTimer=setTimeout(()=>{sv('notes');setSaved();},800);
}
function setSaved(){
  const b=document.getElementById('saveBtn');
  if(b){b.classList.add('saved');b.innerHTML=`<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Saved`;setTimeout(()=>{b.classList.remove('saved');b.innerHTML=`<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save`;},2200);}
  const u=document.getElementById('updEl');if(u)u.textContent='Updated just now';
}
function manualSave(){clearTimeout(saveTimer);sv('notes');setSaved();showToast('âœ“ Note saved');}
function fmt(c){document.execCommand(c,false,null);document.getElementById('ed')?.focus();onEd();}
function fb(t){document.execCommand('formatBlock',false,t);document.getElementById('ed')?.focus();onEd();}
function insHr(){document.execCommand('insertHTML',false,'<hr>');document.getElementById('ed')?.focus();onEd();}
function insCode(){const s=window.getSelection(),t=s?.toString()||'code';document.execCommand('insertHTML',false,`<code>${esc(t)}</code>`);document.getElementById('ed')?.focus();onEd();}
function insChecklist(){document.execCommand('insertHTML',false,'<ul class="checklist"><li class="checklist-item"><input type="checkbox"><span> Task</span></li></ul>');document.getElementById('ed')?.focus();onEd();}
function insLink(){const url=prompt('URL:');if(!url)return;const text=window.getSelection()?.toString()||url;document.execCommand('insertHTML',false,`<a href="${esc(url)}" target="_blank">${esc(text)}</a>`);document.getElementById('ed')?.focus();onEd();}
function insImage(){const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.onchange=e=>{const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=ev=>{document.execCommand('insertHTML',false,`<img src="${ev.target.result}" alt="${esc(f.name)}">`);document.getElementById('ed')?.focus();onEd();};r.readAsDataURL(f);};inp.click();}
function onDrop(e){e.preventDefault();[...e.dataTransfer.files].filter(f=>f.type.startsWith('image/')).forEach(f=>{const r=new FileReader();r.onload=ev=>{document.execCommand('insertHTML',false,`<img src="${ev.target.result}" alt="${esc(f.name)}">`);onEd();};r.readAsDataURL(f);});}

/* tab switch */
function switchTab(t){
  document.getElementById('tabWrite')?.classList.toggle('active',t==='write');
  document.getElementById('tabCanvas')?.classList.toggle('active',t==='canvas');
  document.getElementById('writePanel').style.display=t==='write'?'flex':'none';
  document.getElementById('canvasPanel').style.display=t==='canvas'?'flex':'none';
  if(t==='canvas')setTimeout(resizeCanvas,30);
}

/* pin */
function togglePin(){const n=noteById(activeId);if(!n)return;n.pinned=!n.pinned;n.updatedAt=Date.now();sv('notes');document.getElementById('pinBtn')?.classList.toggle('pinned',n.pinned);showToast(n.pinned?'ğŸ“Œ Pinned':'Unpinned');renderList();}

/* â•â•â•â•â•â•â•â• UNDO/REDO â•â•â•â•â•â•â•â• */
const HM={};let HP=false;
function hGet(id){if(!HM[id])HM[id]={s:[],p:-1};return HM[id];}
function hPush(id,html){if(HP)return;const h=hGet(id);h.s=h.s.slice(0,h.p+1);if(h.s[h.p]===html)return;h.s.push(html);if(h.s.length>80)h.s.shift();h.p=h.s.length-1;hUpdBtns();}
function hUndo(){const h=hGet(activeId);if(h.p<=0)return;h.p--;hApply(h.s[h.p]);}
function hRedo(){const h=hGet(activeId);if(h.p>=h.s.length-1)return;h.p++;hApply(h.s[h.p]);}
function hApply(html){const ed=document.getElementById('ed'),n=noteById(activeId);if(!ed||!n)return;HP=true;ed.innerHTML=html;n.content=html;n.updatedAt=Date.now();sv('notes');updWC();hUpdBtns();HP=false;}
function hUpdBtns(){if(!activeId)return;const h=hGet(activeId);const u=document.getElementById('undoBtn'),r=document.getElementById('redoBtn');if(u)u.disabled=h.p<=0;if(r)r.disabled=h.p>=h.s.length-1;}

/* â•â•â•â•â•â•â•â• DELETE / BIN â•â•â•â•â•â•â•â• */
function askDel(id,e){e&&e.stopPropagation();const n=noteById(id);if(!n)return;showConfirm(e.target,`Move "${(n.title||'Untitled').slice(0,22)}" to bin?`,'Move',()=>moveToBin(id));}
function moveToBin(id){const n=notes.find(x=>x.id===id);if(!n)return;notes=notes.filter(x=>x.id!==id);bin.unshift({...n,deletedAt:Date.now()});sv('notes');sv('bin');if(activeId===id){activeId=null;showEmpty();}renderList();showToast('ğŸ—‘ Moved to bin');}
function restoreNote(id,e){e&&e.stopPropagation();const n=bin.find(x=>x.id===id);if(!n)return;bin=bin.filter(x=>x.id!==id);notes.unshift({...n,updatedAt:Date.now()});delete notes[0].deletedAt;sv('notes');sv('bin');renderList();showToast('â†© Note restored');}
function permDel(id,e){e&&e.stopPropagation();showConfirm(e.target,'Permanently delete? Cannot be undone.','Delete',()=>{bin=bin.filter(x=>x.id!==id);sv('bin');renderList();showToast('Deleted permanently');});}
function emptyBin(){showConfirm(document.querySelector('.bin-empty-btn')||document.body,'Permanently delete ALL notes in bin?','Empty',()=>{bin=[];sv('bin');renderList();showToast('ğŸ—‘ Bin emptied');});}

/* â•â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â•â• */
function initCanvas(n){const c=document.getElementById('drawCanvas');if(!c)return;resizeCanvas();if(n.canvasData){const img=new Image();img.onload=()=>c.getContext('2d').drawImage(img,0,0);img.src=n.canvasData;}}
function resizeCanvas(){const c=document.getElementById('drawCanvas');if(!c)return;const w=document.getElementById('canvasWrap');if(!w)return;const ctx=c.getContext('2d');let old=null;if(c.width>0&&c.height>0)old=c.toDataURL();c.width=w.clientWidth;c.height=w.clientHeight;ctx.fillStyle=lightMode?'#efefe9':'#0d0d11';ctx.fillRect(0,0,c.width,c.height);if(old){const img=new Image();img.onload=()=>ctx.drawImage(img,0,0);img.src=old;}bindCanvas(c);}
function bindCanvas(c){
  c.onpointerdown=e=>{e.preventDefault();isDrawing=true;c.setPointerCapture(e.pointerId);const{x,y}=gPos(c,e);startX=x;startY=y;const ctx=c.getContext('2d');snapshot=ctx.getImageData(0,0,c.width,c.height);ctx.beginPath();ctx.moveTo(x,y);};
  c.onpointermove=e=>{if(!isDrawing)return;e.preventDefault();const{x,y}=gPos(c,e);const ctx=c.getContext('2d');if(drawTool==='pen'||drawTool==='eraser'){ctx.globalCompositeOperation=drawTool==='eraser'?'destination-out':'source-over';ctx.lineWidth=drawTool==='eraser'?brushSize*3:brushSize;ctx.strokeStyle=canvasColor;ctx.lineCap='round';ctx.lineTo(x,y);ctx.stroke();ctx.beginPath();ctx.moveTo(x,y);}else{ctx.putImageData(snapshot,0,0);drawShape(ctx,x,y);}};
  c.onpointerup=e=>{if(!isDrawing)return;isDrawing=false;const{x,y}=gPos(c,e);const ctx=c.getContext('2d');if(drawTool!=='pen'&&drawTool!=='eraser')drawShape(ctx,x,y);ctx.globalCompositeOperation='source-over';saveCanvas();};
}
function gPos(c,e){const r=c.getBoundingClientRect();return{x:(e.clientX-r.left)*(c.width/r.width),y:(e.clientY-r.top)*(c.height/r.height)};}
function drawShape(ctx,ex,ey){ctx.strokeStyle=canvasColor;ctx.lineWidth=brushSize;ctx.lineCap='round';ctx.globalCompositeOperation='source-over';if(drawTool==='line'){ctx.beginPath();ctx.moveTo(startX,startY);ctx.lineTo(ex,ey);ctx.stroke();}else if(drawTool==='rect'){ctx.beginPath();ctx.strokeRect(startX,startY,ex-startX,ey-startY);}else if(drawTool==='circle'){ctx.beginPath();const rx=(ex-startX)/2,ry=(ey-startY)/2;ctx.ellipse(startX+rx,startY+ry,Math.abs(rx),Math.abs(ry),0,0,Math.PI*2);ctx.stroke();}}
function saveCanvas(){const c=document.getElementById('drawCanvas');if(!c)return;const n=noteById(activeId);if(!n)return;n.canvasData=c.toDataURL();sv('notes');}
function setTool(t){drawTool=t;['pen','eraser','line','rect','circle'].forEach(x=>document.getElementById('ct'+x.charAt(0).toUpperCase()+x.slice(1))?.classList.toggle('active',x===t));}
function setCanvasColor(c){canvasColor=c;if(document.getElementById('canvasColorPick'))document.getElementById('canvasColorPick').value=c;}
function setBrushSize(v){brushSize=parseInt(v);}
function clearCanvas(){const c=document.getElementById('drawCanvas');if(!c)return;const ctx=c.getContext('2d');ctx.fillStyle=lightMode?'#efefe9':'#0d0d11';ctx.fillRect(0,0,c.width,c.height);const n=noteById(activeId);if(n){n.canvasData='';sv('notes');}}
function downloadCanvas(){const c=document.getElementById('drawCanvas');if(!c)return;const n=noteById(activeId);const a=document.createElement('a');a.download=(n?.title||'canvas')+'.png';a.href=c.toDataURL();a.click();showToast('âœ“ Canvas saved');}
window.addEventListener('resize',()=>{if(document.getElementById('drawCanvas'))resizeCanvas();});

/* â•â•â•â•â•â•â•â• NOTE LINKING â•â•â•â•â•â•â•â• */
function checkLink(e){
  const ed=document.getElementById('ed');if(!ed)return;
  const sel=window.getSelection();if(!sel.rangeCount)return;
  const range=sel.getRangeAt(0),text=range.startContainer.textContent||'',before=text.slice(0,range.startOffset),match=before.match(/\[\[([^\]]*?)$/);
  document.getElementById('linkSuggest')?.remove();
  if(!match)return;
  const q=match[1].toLowerCase(),matches=notes.filter(n=>n.id!==activeId&&(n.title.toLowerCase().includes(q)||q===''));
  if(!matches.length)return;
  const dd=document.createElement('div');dd.id='linkSuggest';dd.className='link-suggest';
  const rect=range.getBoundingClientRect();dd.style.cssText=`top:${rect.bottom+4}px;left:${rect.left}px`;
  matches.slice(0,6).forEach(n=>{const o=document.createElement('div');o.className='link-opt';o.textContent=n.title||'Untitled';o.onclick=()=>{const r2=sel.getRangeAt(0).cloneRange();r2.setStart(range.startContainer,range.startOffset-match[0].length);r2.setEnd(range.startContainer,range.startOffset);r2.deleteContents();const link=document.createElement('span');link.className='note-link';link.dataset.nid=n.id;link.contentEditable='false';link.textContent='[['+n.title+']]';link.onclick=()=>openNote(n.id);r2.insertNode(link);const after=document.createTextNode(' ');link.parentNode.insertBefore(after,link.nextSibling);const r3=document.createRange();r3.setStartAfter(after);r3.collapse(true);sel.removeAllRanges();sel.addRange(r3);dd.remove();onEd();};dd.appendChild(o);});
  document.body.appendChild(dd);setTimeout(()=>{const h=()=>{dd.remove();document.removeEventListener('click',h);};document.addEventListener('click',h);},10);
}

/* â•â•â•â•â•â•â•â• AI â•â•â•â•â•â•â•â• */
let aiMode='summarize',lastAI='';
function openAI(){
  const n=noteById(activeId);if(!n)return;closeAllDropdowns();
  const ov=mkOverlay('aiMod');
  ov.innerHTML=`<div class="modal" style="max-width:470px"><div class="modal-stripe stripe-green"></div>
    <div class="modal-icon" style="background:var(--accent-dim);border:1px solid var(--accent-glow);font-size:18px">âœ¨</div>
    <h3>AI Writing Assistant</h3>
    <div class="ai-mode-btns">
      <button class="ai-mode-btn active" id="aim-summarize" onclick="setAIM('summarize')">ğŸ“ Summarize</button>
      <button class="ai-mode-btn" id="aim-continue" onclick="setAIM('continue')">âœ Continue</button>
      <button class="ai-mode-btn" id="aim-title" onclick="setAIM('title')">ğŸ· Auto-Title</button>
      <button class="ai-mode-btn" id="aim-improve" onclick="setAIM('improve')">âœ¨ Improve</button>
      <button class="ai-mode-btn" id="aim-bullets" onclick="setAIM('bullets')">â€¢ Key Points</button>
      <button class="ai-mode-btn" id="aim-custom" onclick="setAIM('custom')">ğŸ’¬ Custom</button>
    </div>
    <div id="aiCustRow" style="display:none;margin-bottom:6px">
      <input class="f-inp" id="aiCustInp" placeholder="Ask anything about this noteâ€¦" style="margin-top:6px">
    </div>
    <div class="ai-result" id="aiRes"><span style="color:var(--text3);font-style:italic;font-size:12.5px">Click Run to generateâ€¦</span></div>
    <div class="m-actions">
      <button class="btn-cancel" onclick="closeModal('aiMod')">Close</button>
      <button class="btn-accent" id="aiRunBtn" onclick="runAI()">â–¶ Run</button>
      <button class="btn-purple" id="aiApplyBtn" onclick="applyAI()" style="display:none">Apply</button>
    </div>
  </div>`;
  document.body.appendChild(ov);ov.addEventListener('click',e=>{if(e.target===ov)closeModal('aiMod');});
  aiMode='summarize';lastAI='';
}
function setAIM(m){aiMode=m;document.querySelectorAll('.ai-mode-btn').forEach(b=>b.classList.remove('active'));document.getElementById('aim-'+m)?.classList.add('active');document.getElementById('aiCustRow').style.display=m==='custom'?'block':'none';document.getElementById('aiApplyBtn').style.display='none';document.getElementById('aiRes').innerHTML=`<span style="color:var(--text3);font-style:italic;font-size:12.5px">Click Run to generateâ€¦</span>`;}
async function runAI(){
  const n=noteById(activeId);if(!n)return;
  const btn=document.getElementById('aiRunBtn');btn.disabled=true;btn.textContent='Runningâ€¦';
  document.getElementById('aiRes').innerHTML=`<span class="ai-loading" style="color:var(--text3)">Thinking</span>`;
  document.getElementById('aiApplyBtn').style.display='none';
  const pt=n.content.replace(/<[^>]*>/g,' ').replace(/\s+/g,' ').trim().slice(0,3000);
  const prompts={
    summarize:`Summarize in 3-5 concise sentences.\n\nTitle: "${n.title}"\n\n${pt}`,
    continue:`Continue this note naturally with 2-3 paragraphs in the same style.\n\nTitle: "${n.title}"\n\n${pt}`,
    title:`Suggest 5 creative titles for this note, numbered.\n\n${pt}`,
    improve:`Rewrite this note to be clearer and more engaging. Keep the meaning.\n\n${pt}`,
    bullets:`Extract 5-8 key points as bullet points.\n\n${pt}`,
    custom:(document.getElementById('aiCustInp')?.value||'What is this note about?')+'\n\n'+pt,
  };
  try{
    const res=await fetch('https://api.anthropic.com/v1/messages',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({model:'claude-sonnet-4-20250514',max_tokens:1000,messages:[{role:'user',content:prompts[aiMode]}]})});
    const data=await res.json();
    const text=data.content?.map(i=>i.text||'').join('')||'No response.';
    lastAI=text;document.getElementById('aiRes').textContent=text;
    if(aiMode==='continue'||aiMode==='improve')document.getElementById('aiApplyBtn').style.display='flex';
  }catch(err){document.getElementById('aiRes').textContent='Error: '+err.message;}
  btn.disabled=false;btn.textContent='â–¶ Run';
}
function applyAI(){
  const n=noteById(activeId);if(!n||!lastAI)return;
  if(aiMode==='continue')n.content+=`<hr><p>${lastAI.replace(/\n/g,'</p><p>')}</p>`;
  else if(aiMode==='improve')n.content=`<p>${lastAI.replace(/\n\n/g,'</p><p>').replace(/\n/g,'<br>')}</p>`;
  n.updatedAt=Date.now();sv('notes');const ed=document.getElementById('ed');if(ed)ed.innerHTML=n.content;
  updWC();closeModal('aiMod');showToast('âœ“ AI result applied');
}

/* â•â•â•â•â•â•â•â• TEMPLATES â•â•â•â•â•â•â•â• */
const TEMPLATES=[
  {icon:'ğŸ“‹',name:'Meeting Notes',desc:'Agenda, attendees, actions',content:'<h2>Meeting Notes</h2><p><strong>Date:</strong> '+new Date().toLocaleDateString()+'<br><strong>Attendees:</strong> </p><h3>Agenda</h3><ul><li>Item 1</li></ul><h3>Discussion</h3><p></p><h3>Action Items</h3><ul><li>[ ] Task â€” Owner â€” Due</li></ul>'},
  {icon:'ğŸ““',name:'Daily Journal',desc:'Mood, gratitude, reflection',content:'<h2>ğŸ““ '+new Date().toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'})+'</h2><h3>How I feel</h3><p></p><h3>3 things I\'m grateful for</h3><ul><li></li><li></li><li></li></ul><h3>Goals</h3><ul><li></li></ul><h3>Reflection</h3><p></p>'},
  {icon:'âœ…',name:'Todo List',desc:'Tasks with checkboxes',content:'<h2>âœ… Tasks</h2><ul class="checklist"><li class="checklist-item"><input type="checkbox"><span>Task 1</span></li><li class="checklist-item"><input type="checkbox"><span>Task 2</span></li></ul>'},
  {icon:'ğŸš€',name:'Project Brief',desc:'Goals, scope, timeline',content:'<h2>ğŸš€ Project Brief</h2><h3>Overview</h3><p></p><h3>Goals</h3><ul><li></li></ul><h3>Timeline</h3><ul><li><strong>Start:</strong> </li><li><strong>End:</strong> </li></ul>'},
  {icon:'ğŸ“Š',name:'Weekly Review',desc:'Wins, challenges, next week',content:'<h2>ğŸ“Š Weekly Review</h2><h3>ğŸ† Wins</h3><ul><li></li></ul><h3>ğŸ˜¤ Challenges</h3><ul><li></li></ul><h3>ğŸ¯ Next Week</h3><ul><li></li></ul>'},
  {icon:'ğŸ’¡',name:'Idea Capture',desc:'Problem, solution, next steps',content:'<h2>ğŸ’¡ Idea</h2><h3>The Problem</h3><p></p><h3>The Solution</h3><p></p><h3>Next Steps</h3><ul><li></li></ul>'},
  {icon:'ğŸ“–',name:'Book Notes',desc:'Summary, quotes, takeaways',content:'<h2>ğŸ“– Book Notes</h2><p><strong>Title:</strong> <br><strong>Author:</strong> </p><h3>Summary</h3><p></p><h3>Key Ideas</h3><ul><li></li></ul><h3>Quotes</h3><blockquote></blockquote>'},
  {icon:'ğŸ¯',name:'Goal Setting',desc:'SMART goals framework',content:'<h2>ğŸ¯ Goal</h2><p></p><ul><li><strong>Specific:</strong> </li><li><strong>Measurable:</strong> </li><li><strong>Achievable:</strong> </li><li><strong>Relevant:</strong> </li><li><strong>Time-bound:</strong> </li></ul><h3>Action Plan</h3><ul><li></li></ul>'},
];
function openTemplates(){
  closeAllDropdowns();const ov=mkOverlay('tmplMod');
  ov.innerHTML=`<div class="modal" style="max-width:490px"><div class="modal-stripe stripe-green"></div>
    <div class="modal-icon" style="background:var(--accent-dim);border:1px solid var(--accent-glow)">ğŸ“‹</div>
    <h3>Templates</h3><p class="subtitle">Start with a pre-built structure.</p>
    <div class="tmpl-grid">${TEMPLATES.map((t,i)=>`<div class="tmpl-card" onclick="useTemplate(${i})"><div class="tmpl-icon">${t.icon}</div><div class="tmpl-name">${t.name}</div><div class="tmpl-desc">${t.desc}</div></div>`).join('')}</div>
    <div class="m-actions" style="margin-top:10px"><button class="btn-cancel" onclick="closeModal('tmplMod')">Cancel</button></div>
  </div>`;
  document.body.appendChild(ov);ov.addEventListener('click',e=>{if(e.target===ov)closeModal('tmplMod');});
}
function useTemplate(i){closeModal('tmplMod');const t=TEMPLATES[i];const n={id:Date.now().toString(),title:t.name,content:t.content,canvasData:'',tags:['misc'],pinned:false,folder:activeFolder||null,createdAt:Date.now(),updatedAt:Date.now()};notes.unshift(n);sv('notes');renderList();openNote(n.id);showToast('âœ“ Template applied');}

/* â•â•â•â•â•â•â•â• DAILY NOTE â•â•â•â•â•â•â•â• */
function openDailyNote(){
  const key=todayKey();let n=notes.find(x=>x.dailyKey===key);
  if(!n){n={id:Date.now().toString(),title:'ğŸ“… '+todayStr(),content:'<h2>ğŸ“… '+todayStr()+'</h2><h3>Intentions</h3><p></p><h3>Notes</h3><p></p><h3>Reflection</h3><p></p>',canvasData:'',tags:['personal'],pinned:false,createdAt:Date.now(),updatedAt:Date.now(),dailyKey:key};notes.unshift(n);sv('notes');renderList();}
  openNote(n.id);showToast('ğŸ“… Daily note');
}

/* â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â• */
function openStats(){
  const tw=notes.reduce((s,n)=>s+wc(n.content),0);
  const tc=notes.reduce((s,n)=>s+n.content.replace(/<[^>]*>/g,'').length,0);
  const DAY=864e5,now=Date.now(),am={};
  notes.forEach(n=>{const d=Math.floor(n.updatedAt/DAY);am[d]=(am[d]||0)+1;});
  const cells=Array.from({length:30},(_,i)=>{const d=Math.floor((now-(29-i)*DAY)/DAY);const c=am[d]||0;const l=c===0?'':c===1?'l1':c<=3?'l2':c<=5?'l3':'l4';return`<div class="hm-cell ${l}" title="${c} updates"></div>`;}).join('');
  const ov=mkOverlay('statsMod');
  ov.innerHTML=`<div class="modal" style="max-width:380px"><div class="modal-stripe stripe-blue"></div>
    <div class="modal-icon" style="background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25)">ğŸ“Š</div>
    <h3>Writing Stats</h3>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-num">${notes.length}</div><div class="stat-lbl">Notes</div></div>
      <div class="stat-card"><div class="stat-num">${tw.toLocaleString()}</div><div class="stat-lbl">Words</div></div>
      <div class="stat-card"><div class="stat-num">${notes.filter(n=>n.pinned).length}</div><div class="stat-lbl">Pinned</div></div>
      <div class="stat-card"><div class="stat-num">${folders.length}</div><div class="stat-lbl">Folders</div></div>
      <div class="stat-card"><div class="stat-num">${cTags.length}</div><div class="stat-lbl">Tags</div></div>
      <div class="stat-card"><div class="stat-num">${(tc/1000).toFixed(1)}k</div><div class="stat-lbl">Chars</div></div>
    </div>
    <div class="heatmap"><div class="heatmap-title">30-Day Activity</div><div class="heatmap-grid">${cells}</div></div>
    <div class="m-actions"><button class="btn-cancel" onclick="closeModal('statsMod')">Close</button></div>
  </div>`;
  document.body.appendChild(ov);ov.addEventListener('click',e=>{if(e.target===ov)closeModal('statsMod');});
}

/* â•â•â•â•â•â•â•â• SHORTCUTS â•â•â•â•â•â•â•â• */
const SHORTS=[['New Note','Ctrl+N'],['Save','Ctrl+S'],['Daily Note','Ctrl+D'],['Undo','Ctrl+Z'],['Redo','Ctrl+Y'],['Bold','Ctrl+B'],['Italic','Ctrl+I'],['Underline','Ctrl+U'],['Focus Mode','Ctrl+Shift+F'],['Split View','Ctrl+Shift+S'],['Toggle Theme','Ctrl+Shift+T'],['Shortcuts','?']];
function openShortcuts(){
  const ov=mkOverlay('shortMod');
  ov.innerHTML=`<div class="modal" style="max-width:450px"><div class="modal-stripe stripe-pink"></div>
    <div class="modal-icon" style="background:rgba(217,70,239,.1);border:1px solid rgba(217,70,239,.25)">âŒ¨ï¸</div>
    <h3>Keyboard Shortcuts</h3>
    <div class="shortcuts-grid">${SHORTS.map(([a,k])=>`<div class="sc-row"><span class="sc-action">${a}</span><span class="sc-keys">${k.split('+').map(p=>`<span class="sc-key">${p.trim()}</span>`).join('<span style="color:var(--text3);font-size:9px;padding:0 1px">+</span>')}</span></div>`).join('')}</div>
    <div class="m-actions"><button class="btn-cancel" onclick="closeModal('shortMod')">Close</button></div>
  </div>`;
  document.body.appendChild(ov);ov.addEventListener('click',e=>{if(e.target===ov)closeModal('shortMod');});
}

/* â•â•â•â•â•â•â•â• POMODORO â•â•â•â•â•â•â•â• */
function renderPomoUI(){
  const t=document.getElementById('pomoTimer'),l=document.getElementById('pomoLbl'),f=document.getElementById('pomoFill'),b=document.getElementById('pomoBtnStart');if(!t)return;
  const m=Math.floor(pomoState.secs/60),s=pomoState.secs%60,total=(pomoState.mode==='work'?pomoState.workMins:pomoState.breakMins)*60;
  t.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
  t.className='pomo-timer'+(pomoState.mode==='break'?' break':pomoState.secs<60?' danger':'');
  if(l)l.textContent=pomoState.mode==='work'?'Work Session':'Break Time';
  if(f){f.style.width=(pomoState.secs/total*100)+'%';f.className='pomo-fill'+(pomoState.mode==='break'?' break':'');}
  if(b){b.className='pomo-btn'+(pomoState.running?' running':'');b.textContent=pomoState.running?'â¸ Pause':'â–¶ Start';}
}
function pomoToggle(){
  pomoState.running=!pomoState.running;
  if(pomoState.running){pomoState.interval=setInterval(()=>{pomoState.secs--;if(pomoState.secs<=0){clearInterval(pomoState.interval);pomoState.running=false;if(pomoState.mode==='work'){pomoState.mode='break';pomoState.secs=pomoState.breakMins*60;showToast('â˜• Break time!');}else{pomoState.mode='work';pomoState.secs=pomoState.workMins*60;showToast('ğŸ’ª Work session!');}}renderPomoUI();},1000);}
  else clearInterval(pomoState.interval);
  renderPomoUI();
}
function pomoReset(){clearInterval(pomoState.interval);pomoState.running=false;pomoState.secs=(pomoState.mode==='work'?pomoState.workMins:pomoState.breakMins)*60;renderPomoUI();}
function pomoConfig(){const w=prompt('Work minutes:',pomoState.workMins),b=prompt('Break minutes:',pomoState.breakMins);if(w&&!isNaN(w))pomoState.workMins=Math.max(1,parseInt(w));if(b&&!isNaN(b))pomoState.breakMins=Math.max(1,parseInt(b));pomoReset();showToast('â± Updated');}

/* â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â• */
function expPDF(){const n=noteById(activeId);if(!n)return;const w=window.open('','_blank');w.document.write(`<!DOCTYPE html><html><head><title>${esc(n.title||'Note')}</title><link href="https://fonts.googleapis.com/css2?family=Syne:wght@700&family=DM+Sans:wght@300;400&display=swap" rel="stylesheet"><style>body{font-family:'DM Sans',sans-serif;max-width:720px;margin:50px auto;color:#111;line-height:1.8;font-size:14px;padding:0 20px}h1,h2,h3{font-family:'Syne',sans-serif}blockquote{border-left:3px solid #888;padding-left:14px;color:#555}code{background:#f0f0f0;padding:2px 5px;border-radius:4px;font-family:monospace}img{max-width:100%;border-radius:6px}@media print{body{margin:0}}</style></head><body><h1>${esc(n.title)||'Untitled'}</h1><p style="color:#888;font-size:11px;margin-bottom:20px">${new Date(n.updatedAt).toLocaleString()}</p>${n.content}</body></html>`);w.document.close();setTimeout(()=>w.print(),500);showToast('âœ“ PDF ready');}
function expWord(){const n=noteById(activeId);if(!n)return;const title=n.title||'Untitled';const html=`<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>${esc(title)}</title></head><body><h1>${esc(title)}</h1><p style="color:#888">${new Date(n.updatedAt).toLocaleString()}</p>${n.content}</body></html>`;const blob=new Blob(['\ufeff'+html],{type:'application/msword'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=title+'.doc';a.click();URL.revokeObjectURL(url);showToast('âœ“ Word doc downloaded');}
function expMD(){const n=noteById(activeId);if(!n)return;let md=`# ${n.title||'Untitled'}\n\n`;const div=document.createElement('div');div.innerHTML=n.content;function toMd(node){let t='';node.childNodes.forEach(ch=>{if(ch.nodeType===3){t+=ch.textContent;}else if(ch.tagName){const tag=ch.tagName.toLowerCase(),inner=toMd(ch);if(tag==='h1')t+=`\n# ${inner}\n`;else if(tag==='h2')t+=`\n## ${inner}\n`;else if(tag==='h3')t+=`\n### ${inner}\n`;else if(tag==='b'||tag==='strong')t+=`**${inner}**`;else if(tag==='i'||tag==='em')t+=`*${inner}*`;else if(tag==='code')t+=`\`${inner}\``;else if(tag==='blockquote')t+=`\n> ${inner.trim()}\n`;else if(tag==='li')t+=`- ${inner}\n`;else if(tag==='ul'||tag==='ol')t+=`\n${inner}`;else if(tag==='hr')t+=`\n---\n`;else if(tag==='br')t+=`\n`;else if(tag==='img')t+=`\n![img](${ch.src})\n`;else if(tag==='p')t+=`\n${inner}\n`;else t+=inner;}});return t;}md+=toMd(div);const blob=new Blob([md],{type:'text/markdown'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=(n.title||'note')+'.md';a.click();URL.revokeObjectURL(url);showToast('âœ“ Markdown exported');}
function expTXT(){const n=noteById(activeId);if(!n)return;const div=document.createElement('div');div.innerHTML=n.content;const txt=(n.title||'Untitled')+'\n'+'â”€'.repeat(38)+'\n\n'+div.innerText;const blob=new Blob([txt],{type:'text/plain'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=(n.title||'note')+'.txt';a.click();URL.revokeObjectURL(url);showToast('âœ“ Text exported');}

/* â•â•â•â•â•â•â•â• MODAL / TOAST HELPERS â•â•â•â•â•â•â•â• */
function mkOverlay(id){document.getElementById(id)?.remove();const ov=document.createElement('div');ov.className='overlay';ov.id=id;return ov;}
function closeModal(id){const el=document.getElementById(id);if(!el)return;el.classList.add('hiding');setTimeout(()=>el.remove(),155);}
function showToast(msg){document.querySelector('.toast')?.remove();const t=document.createElement('div');t.className='toast';t.textContent=msg;document.body.appendChild(t);setTimeout(()=>{t.classList.add('hide');setTimeout(()=>t.remove(),240);},2400);}
function showConfirm(anchor,msg,okLbl,onOk){
  closeAllDropdowns();
  const p=document.createElement('div');p.className='confirm-popup';
  const rect=(anchor||document.body).getBoundingClientRect();
  p.style.cssText=`top:${Math.min(rect.bottom+6,window.innerHeight-120)}px;left:${Math.max(4,Math.min(rect.left,window.innerWidth-230))}px`;
  p.innerHTML=`<div class="confirm-msg">${esc(msg)}</div><div class="confirm-btns"><button class="confirm-cancel" onclick="this.closest('.confirm-popup').remove()">Cancel</button><button class="confirm-ok" id="cfmOk">${esc(okLbl)}</button></div>`;
  document.body.appendChild(p);
  p.querySelector('#cfmOk').onclick=()=>{onOk();p.remove();};
  setTimeout(()=>{const h=ev=>{if(!p.contains(ev.target)){p.remove();document.removeEventListener('click',h);}};document.addEventListener('click',h);},10);
}

/* â•â•â•â•â•â•â•â• KEYBOARD SHORTCUTS â•â•â•â•â•â•â•â• */
document.addEventListener('keydown',e=>{
  const mod=e.ctrlKey||e.metaKey;
  if(mod&&!e.shiftKey&&e.key.toLowerCase()==='s'){e.preventDefault();if(activeId)manualSave();}
  if(mod&&!e.shiftKey&&e.key.toLowerCase()==='n'){e.preventDefault();createNote();}
  if(mod&&!e.shiftKey&&e.key.toLowerCase()==='d'){e.preventDefault();openDailyNote();}
  if(mod&&e.shiftKey&&e.key.toLowerCase()==='f'){e.preventDefault();if(activeId)toggleFocusMode();}
  if(mod&&e.shiftKey&&e.key.toLowerCase()==='s'){e.preventDefault();if(activeId)toggleSplit();}
  if(mod&&e.shiftKey&&e.key.toLowerCase()==='t'){e.preventDefault();toggleTheme();}
  if(e.key==='?'&&!mod&&!document.activeElement.matches('input,textarea,[contenteditable]'))openShortcuts();
  if(e.key==='Escape'){closeAllDropdowns();document.querySelectorAll('.overlay').forEach(o=>closeModal(o.id));}
  const ed=document.getElementById('ed');
  if(ed&&(document.activeElement===ed||ed.contains(document.activeElement))){
    if(mod&&!e.shiftKey&&e.key.toLowerCase()==='z'){e.preventDefault();hUndo();}
    if(mod&&(e.key.toLowerCase()==='y'||(e.shiftKey&&e.key.toLowerCase()==='z'))){e.preventDefault();hRedo();}
    if(mod&&!e.shiftKey&&e.key.toLowerCase()==='b'){e.preventDefault();fmt('bold');}
    if(mod&&!e.shiftKey&&e.key.toLowerCase()==='i'){e.preventDefault();fmt('italic');}
    if(mod&&!e.shiftKey&&e.key.toLowerCase()==='u'){e.preventDefault();fmt('underline');}
  }
});

/* â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â• */
notes.forEach(n=>{if(!n.tags){n.tags=n.tag?[n.tag]:['misc'];delete n.tag;}});sv('notes');
renderTags();renderFolders();renderList();

if(!notes.length){
  notes=[
    {id:'1',title:'Welcome to Noteflux âœ¦',content:'<h2>Welcome! âœ¦</h2><p>Here\'s what\'s available:</p><ul><li>ğŸ“‹ <strong>Templates</strong> â€” hit the grid icon in the rail</li><li>ğŸ“ <strong>Folders</strong> â€” click the folder icon in the rail to expand the panel</li><li>ğŸ· <strong>Tags</strong> â€” click the tag icon to manage your tags</li><li>â§‰ <strong>Split View</strong> â€” view two notes side by side (Ctrl+Shift+S)</li><li>âœ¨ <strong>AI Assistant</strong> â€” in the editor topbar</li><li>ğŸ¯ <strong>Focus Mode</strong> â€” Ctrl+Shift+F</li><li>â± <strong>Pomodoro Timer</strong> â€” bottom of the editor</li><li>ğŸ“… <strong>Daily Note</strong> â€” calendar icon in the rail</li></ul>',canvasData:'',tags:['personal'],pinned:true,createdAt:Date.now()-86400000,updatedAt:Date.now()-3600000},
    {id:'2',title:'Project Ideas',content:'<h3>Q2 Roadmap</h3><p>Some thoughts on what to tackle next quarter.</p><blockquote>Always build with the user in mind.</blockquote>',canvasData:'',tags:['idea','work'],pinned:false,createdAt:Date.now()-172800000,updatedAt:Date.now()-7200000},
  ];
  sv('notes');renderList();
}
</script>
</body>
</html>
