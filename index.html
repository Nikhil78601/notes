<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>Noteflux</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&family=Lora:ital,wght@0,400;0,600;1,400&family=JetBrains+Mono:wght@400;500&family=Merriweather:ital,wght@0,300;0,400;1,300&display=swap"
    rel="stylesheet">
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    :root {
      --bg: #0d0d11;
      --surface: #141418;
      --surface2: #1c1c22;
      --surface3: #242430;
      --surface4: #2e2e3c;
      --border: rgba(255, 255, 255, .065);
      --border2: rgba(255, 255, 255, .11);
      --accent: #b8e32a;
      --accent-dim: rgba(184, 227, 42, .11);
      --accent-glow: rgba(184, 227, 42, .28);
      --accent2: #7c5cfc;
      --accent2-dim: rgba(124, 92, 252, .12);
      --text: #e2e2ea;
      --text2: #8e8ea8;
      --text3: #55556a;
      --danger: #f05252;
      --danger-dim: rgba(240, 82, 82, .1);
      --tr: .17s cubic-bezier(.4, 0, .2, 1);
      --r: 10px;
      --r-lg: 15px;
      --rail: 56px;
      --sidebar: 260px;
      --sh: 0 4px 20px rgba(0, 0, 0, .5);
      --sh-lg: 0 16px 60px rgba(0, 0, 0, .65);
      --editor-font: 'DM Sans', sans-serif;
      --editor-max-width: none;
    }

    .light {
      --bg: #efefe9;
      --surface: #fafafa;
      --surface2: #f2f2ec;
      --surface3: #e8e8e2;
      --surface4: #deded8;
      --border: rgba(0, 0, 0, .07);
      --border2: rgba(0, 0, 0, .13);
      --accent: #5a9900;
      --accent-dim: rgba(90, 153, 0, .1);
      --accent-glow: rgba(90, 153, 0, .22);
      --accent2: #5134d0;
      --accent2-dim: rgba(81, 52, 208, .1);
      --text: #17171f;
      --text2: #5c5c72;
      --text3: #9898aa;
      --danger: #d92626;
      --danger-dim: rgba(217, 38, 38, .08);
      --sh: 0 4px 20px rgba(0, 0, 0, .08);
      --sh-lg: 0 16px 60px rgba(0, 0, 0, .14);
    }

    .sepia {
      --bg: #f4ecd8;
      --surface: #fdf6e3;
      --surface2: #f0e8d0;
      --surface3: #e8ddc4;
      --surface4: #ddd1b4;
      --border: rgba(100, 70, 20, .1);
      --border2: rgba(100, 70, 20, .18);
      --accent: #8b5e2a;
      --accent-dim: rgba(139, 94, 42, .1);
      --accent-glow: rgba(139, 94, 42, .22);
      --accent2: #7c3a7a;
      --accent2-dim: rgba(124, 58, 122, .1);
      --text: #2d1f0e;
      --text2: #6b4c2a;
      --text3: #a08060;
      --danger: #c44;
      --danger-dim: rgba(204, 68, 68, .08);
      --sh: 0 4px 20px rgba(100, 70, 20, .12);
      --sh-lg: 0 16px 60px rgba(100, 70, 20, .2);
    }

    html,
    body {
      height: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      overflow: hidden
    }

    .orb {
      position: fixed;
      border-radius: 50%;
      filter: blur(90px);
      pointer-events: none;
      z-index: 0
    }

    .orb1 {
      top: -20%;
      left: 10%;
      width: 50vw;
      height: 50vw;
      background: radial-gradient(circle, rgba(124, 92, 252, .07), transparent 70%)
    }

    .orb2 {
      bottom: -15%;
      right: 5%;
      width: 40vw;
      height: 40vw;
      background: radial-gradient(circle, rgba(184, 227, 42, .05), transparent 70%)
    }

    .app {
      display: grid;
      grid-template-columns: var(--rail) var(--sidebar) 1fr;
      height: 100vh;
      position: relative;
      z-index: 1
    }

    /* RAIL */
    .rail {
      width: var(--rail);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0;
      gap: 2px;
      overflow: hidden;
      z-index: 10;
      flex-shrink: 0
    }

    .rail-streak {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1px;
      cursor: pointer;
      padding: 4px 0;
      margin-bottom: 4px
    }

    .rail-streak-icon {
      font-size: 14px;
      line-height: 1
    }

    .rail-streak-num {
      font-family: 'Syne', sans-serif;
      font-size: 9px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1
    }

    .rail-btn {
      width: 38px;
      height: 38px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: none;
      color: var(--text3);
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 17px;
      flex-shrink: 0;
      position: relative
    }

    .rail-btn:hover {
      background: var(--surface2);
      color: var(--text);
      border-color: var(--border)
    }

    .rail-btn.active {
      background: var(--surface2);
      color: var(--accent);
      border-color: var(--accent-dim)
    }

    .rail-btn .tip {
      position: absolute;
      left: calc(100% + 10px);
      background: var(--surface3);
      border: 1px solid var(--border2);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 600;
      padding: 4px 9px;
      border-radius: 7px;
      white-space: nowrap;
      pointer-events: none;
      opacity: 0;
      transition: opacity .15s;
      box-shadow: var(--sh);
      z-index: 200
    }

    .rail-btn:hover .tip {
      opacity: 1
    }

    .rail-sep {
      width: 26px;
      height: 1px;
      background: var(--border);
      margin: 4px 0;
      flex-shrink: 0
    }

    .rail-spacer {
      flex: 1
    }

    /* SIDEBAR */
    .sidebar {
      width: var(--sidebar);
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex-shrink: 0
    }

    .panel-hdr {
      padding: 24px 14px 10px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0
    }

    .panel-title {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: .2px;
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px
    }

    .panel-title-lbl {
      display: flex;
      align-items: center;
      gap: 7px
    }

    .panel-icon {
      font-size: 15px
    }

    .cnt-pill {
      background: var(--surface3);
      border-radius: 5px;
      padding: 1px 6px;
      font-size: 10px;
      color: var(--text2)
    }

    .btn-new {
      width: 100%;
      padding: 9px 10px;
      background: var(--accent);
      color: #0d0d11;
      border: none;
      border-radius: var(--r);
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px
    }

    .btn-new:hover {
      filter: brightness(1.08);
      transform: translateY(-1px);
      box-shadow: 0 6px 18px var(--accent-glow)
    }

    .sb-search {
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0
    }

    .search-wrap {
      position: relative
    }

    .search-ico {
      position: absolute;
      left: 9px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text3);
      pointer-events: none
    }

    .search-inp {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 7px 28px 7px 30px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 12.5px;
      outline: none;
      transition: var(--tr)
    }

    .search-inp::placeholder {
      color: var(--text3)
    }

    .search-inp:focus {
      border-color: var(--accent-glow)
    }

    .search-clear {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 12px;
      padding: 2px;
      display: none;
      line-height: 1
    }

    .search-clear.vis {
      display: block
    }

    .sort-row {
      padding: 6px 12px 4px;
      display: flex;
      align-items: center;
      gap: 6px;
      flex-shrink: 0
    }

    .sort-lbl {
      font-size: 11px;
      color: var(--text3);
      flex-shrink: 0
    }

    .sort-sel {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-size: 11px;
      font-family: 'DM Sans', sans-serif;
      padding: 3px 6px;
      outline: none;
      cursor: pointer;
      flex: 1
    }

    .list-header {
      padding: 8px 14px 4px;
      font-family: 'Syne', sans-serif;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--text3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0
    }

    .tag-filter-strip {
      padding: 4px 10px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 4px;
      overflow-x: auto;
      flex-shrink: 0;
      scrollbar-width: none
    }

    .tag-filter-strip::-webkit-scrollbar {
      display: none
    }

    .tag-filter-chip {
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      border: 1px solid transparent;
      transition: var(--tr)
    }

    .tag-filter-chip.active {
      border-color: currentColor;
      filter: brightness(1.1)
    }

    .sel-banner {
      display: none;
      padding: 6px 12px;
      background: var(--accent-dim);
      border-bottom: 1px solid var(--accent-glow);
      flex-shrink: 0;
      align-items: center;
      gap: 6px
    }

    .sel-banner.vis {
      display: flex
    }

    .sel-banner-txt {
      font-size: 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      color: var(--accent);
      flex: 1
    }

    .sel-banner-btn {
      background: none;
      border: 1px solid var(--border2);
      color: var(--text2);
      border-radius: 7px;
      padding: 3px 9px;
      font-size: 10.5px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: var(--tr)
    }

    .sel-banner-btn:hover {
      color: var(--text);
      background: var(--surface2)
    }

    .sel-banner-btn.danger:hover {
      color: var(--danger);
      background: var(--danger-dim);
      border-color: rgba(240, 82, 82, .3)
    }

    .notes-list {
      flex: 1;
      overflow-y: auto;
      padding: 2px 8px 8px;
      min-height: 0;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent
    }

    .notes-list::-webkit-scrollbar {
      width: 3px
    }

    .notes-list::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px
    }

    /* NOTE ITEMS */
    .note-item {
      padding: 9px 10px;
      border-radius: var(--r);
      cursor: pointer;
      transition: var(--tr);
      margin-bottom: 2px;
      border: 1px solid transparent;
      position: relative;
      animation: itemIn .18s ease both
    }

    @keyframes itemIn {
      from {
        opacity: 0;
        transform: translateX(-4px)
      }

      to {
        opacity: 1;
        transform: translateX(0)
      }
    }

    .note-item:hover {
      background: var(--surface2)
    }

    .note-item.active {
      background: var(--surface2);
      border-color: var(--border)
    }

    .note-item.active::before {
      content: '';
      position: absolute;
      left: -1px;
      top: 22%;
      bottom: 22%;
      width: 2px;
      background: var(--accent);
      border-radius: 0 2px 2px 0
    }

    .note-item.selected {
      background: var(--accent-dim) !important;
      border-color: var(--accent-glow) !important
    }

    .note-item.locked-note .ni-title::after {
      content: ' ðŸ”’';
      font-size: 9px;
      opacity: .6
    }

    .note-item.dragging {
      opacity: .4;
      transform: scale(.97)
    }

    .note-item.drag-over {
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .note-sel-cb {
      display: none;
      width: 14px;
      height: 14px;
      flex-shrink: 0;
      accent-color: var(--accent);
      margin-right: 2px
    }

    .sel-mode .note-sel-cb {
      display: block
    }

    .ni-row1 {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 2px
    }

    .ni-title {
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 1
    }

    .ni-pin {
      font-size: 9px;
      opacity: .55;
      flex-shrink: 0
    }

    .ni-drag-handle {
      font-size: 11px;
      opacity: 0;
      cursor: grab;
      color: var(--text3);
      flex-shrink: 0;
      padding: 0 2px;
      transition: opacity .15s;
      user-select: none
    }

    .note-item:hover .ni-drag-handle {
      opacity: 1
    }

    .ni-prev {
      font-size: 11px;
      color: var(--text2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      line-height: 1.4;
      margin-bottom: 4px
    }

    .ni-meta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 4px
    }

    .ni-date {
      font-size: 9.5px;
      color: var(--text3);
      flex-shrink: 0
    }

    .ni-tags {
      display: flex;
      gap: 2px;
      overflow: hidden;
      flex-wrap: nowrap;
      max-width: 55%
    }

    .ni-tag {
      font-size: 8.5px;
      padding: 1px 5px;
      border-radius: 20px;
      font-weight: 500;
      white-space: nowrap;
      flex-shrink: 0
    }

    .item-acts {
      position: absolute;
      right: 6px;
      top: 7px;
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: var(--tr)
    }

    .note-item:hover .item-acts {
      opacity: 1
    }

    .sel-mode .item-acts {
      display: none
    }

    .item-act {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      padding: 3px 4px;
      border-radius: 5px;
      transition: var(--tr);
      font-size: 11px;
      line-height: 1
    }

    .item-act:hover {
      color: var(--danger);
      background: var(--danger-dim)
    }

    .item-act.dup:hover {
      color: var(--accent2);
      background: var(--accent2-dim)
    }

    .item-act.restore:hover {
      color: #34d399;
      background: rgba(52, 211, 153, .1)
    }

    .empty-state {
      text-align: center;
      padding: 24px 14px;
      color: var(--text3)
    }

    .empty-state p {
      font-size: 12px;
      line-height: 1.6
    }

    .bin-empty-btn {
      width: 100%;
      margin-bottom: 5px;
      padding: 7px;
      background: var(--danger-dim);
      border: 1px dashed rgba(240, 82, 82, .25);
      color: var(--danger);
      border-radius: var(--r);
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--tr)
    }

    .bin-empty-btn:hover {
      background: rgba(240, 82, 82, .18)
    }

    .daily-badge {
      background: var(--accent-dim);
      border: 1px solid var(--accent-glow);
      color: var(--accent);
      font-size: 8px;
      padding: 0 4px;
      border-radius: 3px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      letter-spacing: .2px;
      text-transform: uppercase;
      flex-shrink: 0
    }

    .folder-cnt-badge {
      font-size: 8.5px;
      color: var(--text3);
      margin-left: auto;
      flex-shrink: 0
    }

    /* HOVER PREVIEW */
    .note-hover-preview {
      position: fixed;
      z-index: 800;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r-lg);
      padding: 14px 16px;
      width: 260px;
      max-height: 200px;
      overflow: hidden;
      box-shadow: var(--sh-lg);
      pointer-events: none;
      animation: dropIn .15s ease both;
      font-size: 12.5px;
      line-height: 1.7;
      color: var(--text2)
    }

    .nhp-title {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 13px;
      color: var(--text);
      margin-bottom: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    .nhp-body {
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 5;
      -webkit-box-orient: vertical
    }

    /* PANELS */
    .side-panel {
      flex-shrink: 0;
      border-top: 1px solid var(--border);
      overflow: hidden;
      transition: max-height .28s cubic-bezier(.4, 0, .2, 1), opacity .22s ease;
      max-height: 0;
      opacity: 0
    }

    .side-panel.open {
      opacity: 1
    }

    .side-panel-inner {
      padding: 10px 12px 12px
    }

    .side-panel-hdr {
      font-family: 'Syne', sans-serif;
      font-size: 9.5px;
      font-weight: 700;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      color: var(--text3);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px
    }

    .sp-add-btn {
      background: none;
      border: 1px dashed var(--border2);
      color: var(--text3);
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 10px;
      cursor: pointer;
      transition: var(--tr);
      font-family: 'DM Sans', sans-serif;
      display: flex;
      align-items: center;
      gap: 3px
    }

    .sp-add-btn:hover {
      border-color: var(--accent-glow);
      color: var(--accent)
    }

    .folder-list {
      display: flex;
      flex-direction: column;
      gap: 1px
    }

    .folder-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 5px 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--tr);
      font-size: 12px;
      color: var(--text2)
    }

    .folder-item:hover {
      background: var(--surface2);
      color: var(--text)
    }

    .folder-item.folder-active {
      background: var(--surface2);
      color: var(--accent)
    }

    .folder-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 110px
    }

    .folder-del {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 9.5px;
      padding: 2px 4px;
      border-radius: 4px;
      opacity: 0;
      transition: var(--tr);
      flex-shrink: 0
    }

    .folder-item:hover .folder-del {
      opacity: 1
    }

    .folder-del:hover {
      color: var(--danger)
    }

    .tags-flow {
      display: flex;
      flex-wrap: wrap;
      gap: 5px
    }

    .tag-chip {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 3px 9px;
      border-radius: 20px;
      font-size: 10.5px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--tr);
      max-width: 130px
    }

    .tag-chip:hover {
      filter: brightness(1.1)
    }

    .tag-chip.tag-active {
      outline: 2px solid currentColor;
      outline-offset: 1px
    }

    .tag-chip-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 90px
    }

    .tag-chip-del {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 8px;
      line-height: 1;
      opacity: .5;
      color: inherit;
      padding: 0;
      display: none;
      flex-shrink: 0
    }

    .tag-chip:hover .tag-chip-del {
      display: inline
    }

    .tag-chip-del:hover {
      opacity: 1
    }

    /* EDITOR */
    .editor-area {
      display: flex;
      flex-direction: column;
      overflow: hidden;
      background: var(--bg);
      min-width: 0;
      flex: 1
    }

    .ed-topbar {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      flex-shrink: 0;
      flex-wrap: wrap
    }

    .title-inp {
      background: none;
      border: none;
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 18px;
      flex: 1;
      outline: none;
      letter-spacing: -.3px;
      min-width: 120px
    }

    .title-inp::placeholder {
      color: var(--text3)
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap
    }

    .tb-div {
      width: 1px;
      height: 16px;
      background: var(--border);
      flex-shrink: 0
    }

    .folder-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      font-size: 11px;
      font-family: 'DM Sans', sans-serif;
      padding: 5px 8px;
      outline: none;
      cursor: pointer;
      max-width: 110px;
      transition: var(--tr)
    }

    .folder-select:hover,
    .folder-select:focus {
      border-color: var(--border2);
      color: var(--text)
    }

    .pin-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text3);
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px
    }

    .pin-btn:hover {
      border-color: var(--accent-glow);
      color: var(--accent)
    }

    .pin-btn.pinned {
      color: var(--accent);
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .lock-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text3);
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px
    }

    .lock-btn:hover {
      border-color: var(--border2);
      color: var(--text)
    }

    .lock-btn.locked {
      color: var(--accent2);
      border-color: var(--accent2-dim);
      background: var(--accent2-dim)
    }

    .tp-wrap {
      position: relative
    }

    .tp-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text2);
      padding: 5px 8px;
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      gap: 3px;
      max-width: 140px;
      overflow: hidden;
      flex-shrink: 0;
      font-size: 11px
    }

    .tp-btn:hover,
    .tp-btn.open {
      border-color: var(--border2);
      color: var(--text)
    }

    .tp-tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 1px 5px;
      border-radius: 10px;
      font-size: 9.5px;
      font-weight: 500;
      flex-shrink: 0;
      white-space: nowrap
    }

    .tb-icon {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text3);
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px
    }

    .tb-icon:hover {
      background: var(--surface3);
      color: var(--text);
      border-color: var(--border2)
    }

    .tb-icon.active {
      color: var(--accent);
      background: var(--accent-dim);
      border-color: var(--accent-glow)
    }

    .note-color-dot {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, .2);
      cursor: pointer;
      transition: var(--tr);
      flex-shrink: 0
    }

    .note-color-dot:hover {
      transform: scale(1.15);
      border-color: rgba(255, 255, 255, .5)
    }

    .save-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text2);
      border-radius: 8px;
      padding: 5px 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 11px;
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0
    }

    .save-btn:hover {
      border-color: var(--border2);
      color: var(--text)
    }

    .save-btn.saved {
      color: var(--accent);
      border-color: var(--accent-glow)
    }

    .locked-banner {
      padding: 8px 16px;
      background: var(--accent2-dim);
      border-bottom: 1px solid rgba(124, 92, 252, .25);
      display: none;
      align-items: center;
      gap: 8px;
      flex-shrink: 0
    }

    .locked-banner.vis {
      display: flex
    }

    .locked-banner-text {
      font-size: 12px;
      color: var(--accent2);
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      flex: 1
    }

    .locked-banner-btn {
      background: var(--accent2-dim);
      border: 1px solid rgba(124, 92, 252, .3);
      color: var(--accent2);
      border-radius: 7px;
      padding: 4px 10px;
      font-size: 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: var(--tr)
    }

    .locked-banner-btn:hover {
      background: rgba(124, 92, 252, .2)
    }

    .ed-tabs {
      display: flex;
      padding: 0 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0
    }

    .ed-tab {
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text3);
      font-family: 'Syne', sans-serif;
      font-size: 10.5px;
      font-weight: 600;
      letter-spacing: .4px;
      padding: 8px 14px;
      cursor: pointer;
      transition: var(--tr);
      text-transform: uppercase
    }

    .ed-tab:hover {
      color: var(--text)
    }

    .ed-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent)
    }

    /* SPLIT VIEW */
    .split-view-container {
      display: flex;
      flex: 1;
      overflow: hidden;
      min-height: 0
    }

    .split-pane {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      min-width: 0
    }

    .split-pane+.split-pane {
      border-left: 1px solid var(--border)
    }

    .split-divider {
      width: 4px;
      background: var(--border);
      cursor: col-resize;
      flex-shrink: 0;
      transition: background .15s;
      position: relative
    }

    .split-divider:hover,
    .split-divider.dragging {
      background: var(--accent-glow)
    }

    .split-pane-header {
      padding: 6px 12px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: var(--text2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0
    }

    .split-close-btn {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 12px;
      padding: 2px 5px;
      border-radius: 5px
    }

    .split-close-btn:hover {
      color: var(--danger);
      background: var(--danger-dim)
    }

    /* TOOLBAR */
    .toolbar {
      padding: 4px 8px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 2px;
      flex-wrap: wrap;
      background: var(--surface);
      flex-shrink: 0
    }

    .tb-btn {
      background: none;
      border: 1px solid transparent;
      color: var(--text3);
      border-radius: 7px;
      padding: 4px 7px;
      cursor: pointer;
      font-size: 11.5px;
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      transition: var(--tr);
      line-height: 1.3;
      display: flex;
      align-items: center;
      gap: 3px
    }

    .tb-btn:hover {
      background: var(--surface2);
      color: var(--text);
      border-color: var(--border)
    }

    .tb-btn.toggled {
      background: var(--accent-dim);
      color: var(--accent);
      border-color: var(--accent-glow)
    }

    .tb-sep {
      width: 1px;
      height: 15px;
      background: var(--border);
      margin: 0 2px;
      flex-shrink: 0
    }

    .tb-hist {
      background: none;
      border: 1px solid var(--border);
      color: var(--text3);
      border-radius: 7px;
      padding: 4px 7px;
      cursor: pointer;
      font-size: 11px;
      font-family: 'DM Sans', sans-serif;
      transition: var(--tr);
      display: flex;
      align-items: center;
      line-height: 1
    }

    .tb-hist:hover:not(:disabled) {
      background: var(--surface2);
      color: var(--text)
    }

    .tb-hist:disabled {
      opacity: .3;
      cursor: not-allowed
    }

    .fs-sel,
    .font-sel {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-size: 11px;
      font-family: 'DM Sans', sans-serif;
      padding: 3px 5px;
      outline: none;
      cursor: pointer
    }

    .fs-sel {
      width: 65px
    }

    .font-sel {
      width: 75px
    }

    /* MOBILE TOOLBAR - collapsible */
    .toolbar-wrap {
      position: relative;
      flex-shrink: 0
    }

    .toolbar-overflow {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      z-index: 50;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 4px 8px;
      flex-wrap: wrap;
      gap: 2px;
      box-shadow: var(--sh)
    }

    .toolbar-overflow.vis {
      display: flex
    }

    .toolbar-more-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text3);
      border-radius: 7px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      transition: var(--tr);
      flex-shrink: 0
    }

    .toolbar-more-btn:hover,
    .toolbar-more-btn.active {
      background: var(--surface3);
      color: var(--text)
    }

    /* FIND BAR */
    .find-bar {
      display: none;
      padding: 6px 16px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap
    }

    .find-bar.vis {
      display: flex
    }

    .find-inp,
    .replace-inp {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 12px;
      padding: 5px 10px;
      outline: none;
      transition: var(--tr)
    }

    .find-inp {
      width: 140px
    }

    .replace-inp {
      width: 120px
    }

    .find-inp:focus,
    .replace-inp:focus {
      border-color: var(--accent-glow)
    }

    .find-count {
      font-size: 11px;
      color: var(--text3);
      min-width: 50px
    }

    .find-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text2);
      border-radius: 7px;
      padding: 4px 9px;
      font-size: 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: var(--tr)
    }

    .find-btn:hover {
      background: var(--surface3);
      color: var(--text)
    }

    .find-close {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 14px;
      padding: 2px 4px;
      margin-left: auto
    }

    .find-close:hover {
      color: var(--text)
    }

    mark.hlfnd {
      background: rgba(184, 227, 42, .35);
      border-radius: 2px;
      color: inherit
    }

    mark.hlfnd.active {
      background: rgba(184, 227, 42, .7)
    }

    /* EDITOR BODY */
    .editor {
      flex: 1;
      padding: 22px 24px;
      overflow-y: auto;
      outline: none;
      font-size: 14.5px;
      line-height: 1.9;
      color: var(--text);
      font-family: var(--editor-font);
      font-weight: 300;
      scrollbar-width: thin;
      scrollbar-color: var(--border) transparent;
      caret-color: var(--accent)
    }

    .editor::-webkit-scrollbar {
      width: 3px
    }

    .editor::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 2px
    }

    .editor:empty::before {
      content: attr(data-placeholder);
      color: var(--text3);
      pointer-events: none;
      font-style: italic
    }

    .editor-inner {
      max-width: var(--editor-max-width);
      margin: 0 auto;
      width: 100%
    }

    .editor b,
    .editor strong {
      font-weight: 700;
      color: var(--text)
    }

    .editor i,
    .editor em {
      font-style: italic
    }

    .editor u {
      text-decoration: underline;
      text-decoration-color: var(--accent-glow)
    }

    .editor h1 {
      font-family: 'Syne', sans-serif;
      font-size: 1.9em;
      font-weight: 800;
      margin: .6em 0 .3em;
      color: var(--text)
    }

    .editor h2 {
      font-family: 'Syne', sans-serif;
      font-size: 1.45em;
      font-weight: 700;
      margin: .5em 0 .25em
    }

    .editor h3 {
      font-family: 'Syne', sans-serif;
      font-size: 1.15em;
      font-weight: 600;
      margin: .4em 0 .2em
    }

    .editor p {
      margin: .2em 0
    }

    .editor blockquote {
      border-left: 2px solid var(--accent);
      padding: 6px 14px;
      color: var(--text2);
      margin: 10px 0;
      background: var(--accent-dim);
      border-radius: 0 6px 6px 0
    }

    .editor ul,
    .editor ol {
      margin: 5px 0;
      padding-left: 22px
    }

    .editor li {
      margin: 2px 0
    }

    .editor code {
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 2px 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      color: var(--accent2)
    }

    .editor pre {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 14px 16px;
      margin: 10px 0;
      overflow-x: auto
    }

    .editor pre code {
      background: none;
      border: none;
      padding: 0;
      font-size: 12.5px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace
    }

    .editor hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 14px 0
    }

    .editor a {
      color: var(--accent2);
      text-underline-offset: 2px
    }

    .editor img {
      max-width: 100%;
      border-radius: 8px;
      margin: 8px 0;
      display: block;
      border: 1px solid var(--border);
      cursor: pointer;
      transition: border-color .15s
    }

    .editor img.img-selected {
      border-color: var(--accent);
      outline: 2px solid var(--accent-glow)
    }

    .img-resize-wrap {
      display: inline-block;
      position: relative;
      max-width: 100%;
      margin: 8px 0
    }

    .img-resize-wrap img {
      display: block;
      margin: 0
    }

    .img-resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--accent);
      border: 2px solid #0d0d11;
      border-radius: 50%;
      cursor: nwse-resize;
      bottom: -5px;
      right: -5px;
      z-index: 10
    }

    .editor table {
      border-collapse: collapse;
      width: 100%;
      margin: 10px 0;
      font-size: 13px
    }

    .editor td,
    .editor th {
      border: 1px solid var(--border);
      padding: 6px 10px;
      min-width: 60px
    }

    .editor th {
      background: var(--surface2);
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 11px;
      letter-spacing: .3px
    }

    .editor .cl-list {
      list-style: none;
      padding: 0;
      margin: 4px 0
    }

    .editor .cl-item {
      display: flex;
      align-items: flex-start;
      gap: 8px;
      margin: 3px 0;
      padding: 2px 0
    }

    .editor .cl-item input[type=checkbox] {
      width: 14px;
      height: 14px;
      cursor: pointer;
      accent-color: var(--accent);
      flex-shrink: 0;
      margin-top: 4px
    }

    .editor .cl-item.done>.cl-text {
      text-decoration: line-through;
      opacity: .45
    }

    .editor .cl-text {
      flex: 1;
      outline: none
    }

    body.typewriter-mode .editor {
      padding-top: 40vh
    }

    /* FOOTER */
    .ed-footer {
      padding: 6px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 10.5px;
      color: var(--text3);
      background: var(--surface);
      flex-shrink: 0;
      flex-wrap: wrap;
      gap: 4px
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: 12px
    }

    .wc-goal {
      cursor: pointer
    }

    .wc-goal.near {
      color: var(--accent2)
    }

    .wc-goal.done {
      color: var(--accent)
    }

    .footer-dates {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 10px
    }

    .footer-settings {
      display: flex;
      align-items: center;
      gap: 4px
    }

    .footer-icon-btn {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      padding: 2px 5px;
      border-radius: 5px;
      font-size: 11px;
      transition: var(--tr)
    }

    .footer-icon-btn:hover {
      color: var(--text);
      background: var(--surface2)
    }

    .footer-icon-btn.active {
      color: var(--accent)
    }

    /* POMODORO */
    .pomo-bar {
      padding: 6px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface);
      flex-shrink: 0;
      flex-wrap: wrap;
      overflow: hidden;
      transition: max-height .25s ease, opacity .2s ease;
      max-height: 50px;
      opacity: 1
    }

    .pomo-bar.collapsed {
      max-height: 0;
      opacity: 0;
      border: none;
      padding: 0
    }

    .pomo-timer {
      font-family: 'Syne', sans-serif;
      font-size: 15px;
      font-weight: 800;
      color: var(--accent);
      letter-spacing: -.5px;
      min-width: 40px;
      flex-shrink: 0
    }

    .pomo-timer.break {
      color: #38bdf8
    }

    .pomo-timer.danger {
      color: var(--danger)
    }

    .pomo-lbl {
      font-size: 10px;
      color: var(--text3);
      white-space: nowrap;
      font-family: 'Syne', sans-serif
    }

    .pomo-sessions {
      font-size: 9px;
      color: var(--text3);
      font-family: 'Syne', sans-serif
    }

    .pomo-progress {
      flex: 1;
      height: 3px;
      background: var(--surface3);
      border-radius: 2px;
      overflow: hidden;
      min-width: 60px
    }

    .pomo-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 2px;
      transition: width .5s linear
    }

    .pomo-fill.break {
      background: #38bdf8
    }

    .pomo-btn {
      background: none;
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text3);
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      transition: var(--tr);
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      white-space: nowrap;
      flex-shrink: 0
    }

    .pomo-btn:hover {
      background: var(--surface2);
      color: var(--text)
    }

    .pomo-btn.running {
      color: var(--accent);
      border-color: var(--accent-glow)
    }

    .pomo-mini {
      display: none;
      align-items: center;
      gap: 5px;
      font-size: 10.5px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      cursor: pointer
    }

    .pomo-mini.vis {
      display: flex
    }

    .pomo-mini-time {
      color: var(--accent)
    }

    /* CANVAS */
    .canvas-toolbar {
      padding: 6px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      background: var(--surface);
      flex-shrink: 0
    }

    .ct-btn {
      background: none;
      border: 1px solid transparent;
      color: var(--text3);
      border-radius: 7px;
      padding: 4px 8px;
      cursor: pointer;
      font-size: 11px;
      transition: var(--tr);
      display: flex;
      align-items: center;
      gap: 3px
    }

    .ct-btn:hover {
      background: var(--surface2);
      color: var(--text);
      border-color: var(--border)
    }

    .ct-btn.active {
      background: var(--surface2);
      border-color: var(--accent-glow);
      color: var(--accent)
    }

    .ct-color {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, .15);
      cursor: pointer;
      transition: var(--tr);
      flex-shrink: 0
    }

    .ct-color:hover {
      transform: scale(1.2)
    }

    .ct-size {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-size: 11px;
      padding: 3px 6px;
      outline: none;
      cursor: pointer;
      width: 70px
    }

    .canvas-wrap {
      flex: 1;
      overflow: hidden;
      position: relative;
      background: var(--bg)
    }

    #drawCanvas {
      display: block;
      cursor: crosshair;
      touch-action: none
    }

    /* NO NOTE */
    .no-note {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0;
      padding: 24px
    }

    .no-note-icon {
      font-size: 42px;
      opacity: .12;
      margin-bottom: 10px
    }

    .no-note h2 {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 16px;
      color: var(--text);
      opacity: .35;
      margin-bottom: 6px
    }

    .no-note-sub {
      font-size: 12px;
      text-align: center;
      color: var(--text3);
      margin-bottom: 24px;
      opacity: .6
    }

    .no-note-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      width: 100%;
      max-width: 340px
    }

    .no-note-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: var(--tr);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px
    }

    .no-note-card:hover {
      border-color: var(--accent-glow);
      background: var(--accent-dim);
      transform: translateY(-1px)
    }

    .no-note-card-icon {
      font-size: 22px
    }

    .no-note-card-label {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 11px;
      color: var(--text)
    }

    .no-note-card-desc {
      font-size: 10px;
      color: var(--text3);
      line-height: 1.4
    }

    /* DROPDOWNS/MODALS */
    .dropdown {
      position: absolute;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: var(--r-lg);
      padding: 5px;
      min-width: 170px;
      z-index: 300;
      box-shadow: var(--sh-lg);
      animation: dropIn .15s cubic-bezier(.34, 1.4, .64, 1)
    }

    @keyframes dropIn {
      from {
        opacity: 0;
        transform: translateY(-6px) scale(.96)
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1)
      }
    }

    .dd-item {
      display: flex;
      align-items: center;
      gap: 7px;
      padding: 7px 9px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--tr);
      font-size: 12px;
      color: var(--text)
    }

    .dd-item:hover {
      background: var(--surface2);
      color: var(--accent)
    }

    .dd-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0
    }

    .dd-check {
      margin-left: auto;
      color: var(--accent);
      font-size: 11px;
      opacity: 0
    }

    .dd-item.sel .dd-check {
      opacity: 1
    }

    .dd-item.sel {
      background: var(--surface2)
    }

    .dd-new {
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 5px;
      padding: 7px 9px;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--tr);
      font-size: 11.5px
    }

    .dd-new:hover {
      background: var(--accent-dim)
    }

    .dd-sep {
      height: 1px;
      background: var(--border);
      margin: 4px 0
    }

    .tp-drop {
      top: calc(100% + 6px);
      right: 0
    }

    .exp-drop {
      top: calc(100% + 6px);
      right: 0
    }

    .ctx-menu {
      position: fixed;
      z-index: 500;
      min-width: 170px
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .72);
      backdrop-filter: blur(7px);
      z-index: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn .18s ease;
      padding: 16px
    }

    @keyframes fadeIn {
      from {
        opacity: 0
      }

      to {
        opacity: 1
      }
    }

    .overlay.hiding {
      animation: fadeIn .14s ease reverse;
      pointer-events: none
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 18px;
      padding: 22px;
      max-width: 430px;
      width: 100%;
      box-shadow: var(--sh-lg);
      animation: mIn .22s cubic-bezier(.34, 1.3, .64, 1);
      position: relative;
      overflow: hidden;
      max-height: calc(100vh - 32px);
      overflow-y: auto
    }

    @keyframes mIn {
      from {
        opacity: 0;
        transform: scale(.91) translateY(14px)
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0)
      }
    }

    .modal-stripe {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px
    }

    .stripe-danger {
      background: linear-gradient(90deg, var(--danger), #f87171)
    }

    .stripe-purple {
      background: linear-gradient(90deg, var(--accent2), #a78bfa)
    }

    .stripe-green {
      background: linear-gradient(90deg, var(--accent), #86efac)
    }

    .stripe-orange {
      background: linear-gradient(90deg, #f59e0b, #fb923c)
    }

    .stripe-blue {
      background: linear-gradient(90deg, #38bdf8, var(--accent2))
    }

    .stripe-pink {
      background: linear-gradient(90deg, #d946ef, var(--accent2))
    }

    .modal-icon {
      width: 42px;
      height: 42px;
      border-radius: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-bottom: 14px
    }

    .modal h3 {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 16px;
      margin-bottom: 5px;
      color: var(--text)
    }

    .modal .subtitle {
      color: var(--text2);
      font-size: 12.5px;
      line-height: 1.6
    }

    .f-label {
      display: block;
      font-size: 9.5px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text3);
      margin: 12px 0 5px
    }

    .f-inp {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 9px 11px;
      color: var(--text);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px;
      outline: none;
      transition: var(--tr)
    }

    .f-inp:focus {
      border-color: var(--accent-glow)
    }

    .f-inp::placeholder {
      color: var(--text3)
    }

    .f-textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 9px 11px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
      outline: none;
      transition: var(--tr);
      resize: vertical;
      min-height: 120px
    }

    .f-textarea:focus {
      border-color: var(--accent-glow)
    }

    .m-actions {
      display: flex;
      gap: 8px;
      margin-top: 18px
    }

    .btn-cancel {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: var(--r);
      padding: 10px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      transition: var(--tr)
    }

    .btn-cancel:hover {
      background: var(--surface3)
    }

    .btn-danger {
      flex: 1;
      background: var(--danger);
      border: none;
      color: #fff;
      border-radius: var(--r);
      padding: 10px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: var(--tr)
    }

    .btn-danger:hover {
      filter: brightness(1.1);
      transform: translateY(-1px)
    }

    .btn-accent {
      flex: 1;
      background: var(--accent);
      border: none;
      color: #0d0d11;
      border-radius: var(--r);
      padding: 10px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: var(--tr)
    }

    .btn-accent:hover {
      filter: brightness(1.08);
      transform: translateY(-1px)
    }

    .btn-purple {
      flex: 1;
      background: var(--accent2);
      border: none;
      color: #fff;
      border-radius: var(--r);
      padding: 10px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      transition: var(--tr)
    }

    .btn-purple:hover {
      filter: brightness(1.1);
      transform: translateY(-1px)
    }

    .num-row {
      display: flex;
      gap: 12px;
      margin-top: 10px
    }

    .num-group {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .num-lbl {
      font-size: 9.5px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text3)
    }

    .num-inp {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 10px;
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-size: 20px;
      font-weight: 800;
      outline: none;
      text-align: center;
      transition: var(--tr);
      width: 100%
    }

    .num-inp:focus {
      border-color: var(--accent-glow)
    }

    .swatches {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 5px;
      margin-bottom: 3px
    }

    .swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--tr)
    }

    .swatch:hover {
      transform: scale(1.14)
    }

    .swatch.sel {
      border-color: #fff;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, .2)
    }

    .color-row {
      display: flex;
      align-items: center;
      gap: 7px;
      margin-top: 7px
    }

    .color-dot {
      width: 17px;
      height: 17px;
      border-radius: 50%;
      flex-shrink: 0;
      border: 2px solid rgba(255, 255, 255, .15)
    }

    .hex-wrap {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 5px 9px;
      transition: var(--tr)
    }

    .hex-wrap:focus-within {
      border-color: var(--accent-glow)
    }

    .hex-inp {
      background: none;
      border: none;
      color: var(--text);
      font-family: monospace;
      font-size: 12px;
      outline: none;
      width: 68px
    }

    .color-native {
      width: 27px;
      height: 27px;
      border: 1px solid var(--border);
      background: none;
      cursor: pointer;
      padding: 2px;
      border-radius: 7px
    }

    .tag-prev-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
      background: var(--surface2);
      border-radius: var(--r);
      padding: 8px 11px
    }

    .tag-prev-lbl {
      font-size: 11px;
      color: var(--text3)
    }

    .tag-prev-pill {
      font-size: 11px;
      padding: 2px 9px;
      border-radius: 20px;
      font-weight: 500
    }

    .icons-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 4px
    }

    .icon-opt {
      font-size: 18px;
      cursor: pointer;
      padding: 5px;
      border-radius: 7px;
      border: 1px solid transparent;
      transition: var(--tr)
    }

    .icon-opt:hover {
      background: var(--surface2)
    }

    .icon-opt.sel {
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .note-color-swatches {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 6px
    }

    .nc-sw {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: var(--tr)
    }

    .nc-sw:hover {
      transform: scale(1.18)
    }

    .nc-sw.sel {
      border-color: #fff;
      box-shadow: 0 0 0 2px rgba(255, 255, 255, .25)
    }

    .tmpl-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 7px;
      margin-top: 10px;
      max-height: 320px;
      overflow-y: auto;
      scrollbar-width: thin
    }

    .tmpl-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px;
      cursor: pointer;
      transition: var(--tr)
    }

    .tmpl-card:hover {
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .tmpl-card.custom-tmpl {
      border-color: rgba(124, 92, 252, .3)
    }

    .tmpl-card.custom-tmpl:hover {
      border-color: var(--accent2);
      background: var(--accent2-dim)
    }

    .tmpl-icon {
      font-size: 20px;
      margin-bottom: 5px
    }

    .tmpl-name {
      font-family: 'Syne', sans-serif;
      font-size: 11.5px;
      font-weight: 700;
      margin-bottom: 2px
    }

    .tmpl-desc {
      font-size: 10.5px;
      color: var(--text3);
      line-height: 1.4
    }

    .tmpl-del {
      float: right;
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      font-size: 10px;
      padding: 2px;
      margin-top: -2px
    }

    .tmpl-del:hover {
      color: var(--danger)
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 7px;
      margin-top: 12px
    }

    .stat-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px;
      text-align: center
    }

    .stat-num {
      font-family: 'Syne', sans-serif;
      font-size: 22px;
      font-weight: 800;
      color: var(--accent);
      line-height: 1
    }

    .stat-lbl {
      font-size: 9px;
      color: var(--text3);
      margin-top: 3px;
      text-transform: uppercase;
      letter-spacing: .5px
    }

    .heatmap {
      margin-top: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px
    }

    .heatmap-title {
      font-size: 9.5px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 8px
    }

    .heatmap-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 3px
    }

    .hm-cell {
      width: 10px;
      height: 10px;
      border-radius: 2px;
      background: var(--surface3);
      cursor: default;
      position: relative
    }

    .hm-cell.l1 {
      background: rgba(184, 227, 42, .25)
    }

    .hm-cell.l2 {
      background: rgba(184, 227, 42, .5)
    }

    .hm-cell.l3 {
      background: rgba(184, 227, 42, .75)
    }

    .hm-cell.l4 {
      background: var(--accent)
    }

    .hm-cell[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: calc(100% + 4px);
      left: 50%;
      transform: translateX(-50%);
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 5px;
      padding: 2px 6px;
      font-size: 9px;
      white-space: nowrap;
      color: var(--text);
      box-shadow: var(--sh);
      pointer-events: none;
      z-index: 100
    }

    .streak-row {
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text2)
    }

    .streak-num {
      font-family: 'Syne', sans-serif;
      font-size: 18px;
      font-weight: 800;
      color: var(--accent)
    }

    .shortcuts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 5px;
      margin-top: 12px;
      max-height: 300px;
      overflow-y: auto;
      scrollbar-width: thin
    }

    .sc-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface2);
      border-radius: 7px;
      padding: 7px 10px;
      font-size: 11px
    }

    .sc-action {
      color: var(--text2)
    }

    .sc-keys {
      display: flex;
      gap: 2px;
      align-items: center
    }

    .sc-key {
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 1px 5px;
      font-family: monospace;
      font-size: 9.5px;
      color: var(--text)
    }

    .ai-mode-btns {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-bottom: 8px
    }

    .ai-mode-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text3);
      border-radius: 8px;
      padding: 5px 10px;
      font-size: 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      cursor: pointer;
      transition: var(--tr)
    }

    .ai-mode-btn:hover {
      color: var(--text)
    }

    .ai-mode-btn.active {
      background: var(--accent-dim);
      border-color: var(--accent-glow);
      color: var(--accent)
    }

    .ai-result {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px;
      min-height: 70px;
      max-height: 220px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.7;
      color: var(--text);
      margin: 10px 0;
      scrollbar-width: thin;
      white-space: pre-wrap
    }

    @keyframes dots {
      0% {
        content: '.'
      }

      33% {
        content: '..'
      }

      66% {
        content: '...'
      }
    }

    .ai-loading::after {
      content: '...';
      animation: dots 1.2s infinite;
      display: inline-block;
      width: 16px
    }

    .import-drop {
      border: 2px dashed var(--border2);
      border-radius: var(--r);
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--tr);
      margin-top: 10px
    }

    .import-drop:hover,
    .import-drop.drag {
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .import-drop p {
      font-size: 12px;
      color: var(--text3);
      margin-top: 6px
    }

    .pomo-cfg-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface2);
      border-radius: var(--r);
      padding: 10px 14px;
      margin-top: 8px
    }

    .pomo-cfg-lbl {
      font-size: 12px;
      color: var(--text2)
    }

    .pomo-num {
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-size: 14px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      padding: 4px 8px;
      outline: none;
      width: 60px;
      text-align: center
    }

    .toast {
      position: fixed;
      bottom: 18px;
      right: 18px;
      background: var(--surface2);
      border: 1px solid var(--border2);
      color: var(--text);
      padding: 8px 14px;
      border-radius: var(--r);
      font-size: 11.5px;
      font-weight: 500;
      font-family: 'Syne', sans-serif;
      box-shadow: var(--sh-lg);
      z-index: 700;
      animation: toastIn .2s cubic-bezier(.34, 1.4, .64, 1);
      pointer-events: none;
      display: flex;
      align-items: center;
      gap: 6px
    }

    @keyframes toastIn {
      from {
        opacity: 0;
        transform: translateY(8px) scale(.94)
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1)
      }
    }

    .toast.hide {
      animation: toastIn .18s ease reverse
    }

    .confirm-popup {
      position: fixed;
      background: var(--surface);
      border: 1px solid var(--border2);
      border-radius: 11px;
      padding: 12px 13px;
      min-width: 210px;
      z-index: 650;
      box-shadow: var(--sh-lg);
      animation: dropIn .15s cubic-bezier(.34, 1.4, .64, 1)
    }

    .confirm-msg {
      font-size: 12px;
      color: var(--text2);
      margin-bottom: 10px;
      line-height: 1.5
    }

    .confirm-btns {
      display: flex;
      gap: 6px
    }

    .confirm-cancel {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-radius: 7px;
      padding: 6px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 11px;
      cursor: pointer;
      transition: var(--tr)
    }

    .confirm-cancel:hover {
      background: var(--surface3)
    }

    .confirm-ok {
      flex: 1;
      background: var(--danger);
      border: none;
      color: #fff;
      border-radius: 7px;
      padding: 6px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 11px;
      cursor: pointer;
      transition: var(--tr)
    }

    .confirm-ok:hover {
      filter: brightness(1.1)
    }

    .focus-exit-btn {
      display: none;
      position: fixed;
      bottom: 50px;
      right: 14px;
      z-index: 300;
      background: var(--accent-dim);
      border: 1px solid var(--accent-glow);
      color: var(--accent);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 11px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      cursor: pointer;
      align-items: center;
      gap: 4px
    }

    .focus-exit-btn:hover {
      background: rgba(184, 227, 42, .2)
    }

    body.focus-mode .rail,
    .focus-mode .sidebar {
      display: none
    }

    body.focus-mode .app {
      grid-template-columns: 1fr
    }

    body.focus-mode .toolbar,
    .focus-mode .ed-tabs,
    .focus-mode .pomo-bar,
    .focus-mode .find-bar {
      display: none !important
    }

    body.focus-mode .editor {
      padding: 44px min(90px, 10vw);
      font-size: 15.5px
    }

    body.focus-mode .focus-exit-btn {
      display: flex
    }

    body.focus-mode .ed-topbar {
      padding: 12px 32px
    }

    .ni-title-edit {
      background: var(--surface3);
      border: 1px solid var(--accent-glow);
      border-radius: 5px;
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 12px;
      padding: 1px 5px;
      outline: none;
      width: 100%
    }

    .note-item.kbd-focus {
      outline: 2px solid var(--accent-glow);
      outline-offset: 1px
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 12px
    }

    .theme-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: var(--tr);
      text-align: center
    }

    .theme-card:hover {
      border-color: var(--accent-glow)
    }

    .theme-card.active {
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .theme-preview {
      width: 100%;
      height: 36px;
      border-radius: 6px;
      margin-bottom: 6px
    }

    .theme-name {
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 700
    }

    .setting-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface2);
      border-radius: var(--r);
      padding: 10px 14px;
      margin-top: 8px
    }

    .setting-label {
      font-size: 12px;
      color: var(--text2)
    }

    .setting-select {
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 7px;
      color: var(--text);
      font-size: 11px;
      padding: 4px 7px;
      outline: none;
      cursor: pointer
    }

    .ai-setup-banner {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 12px;
      margin-bottom: 10px;
      font-size: 12px;
      color: var(--text2);
      line-height: 1.6
    }

    .ai-setup-banner strong {
      color: var(--text)
    }

    .ai-key-row {
      display: flex;
      gap: 6px;
      margin-top: 8px
    }

    .ai-key-inp {
      flex: 1;
      background: var(--surface3);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-family: monospace;
      font-size: 12px;
      padding: 7px 10px;
      outline: none;
      transition: var(--tr)
    }

    .ai-key-inp:focus {
      border-color: var(--accent-glow)
    }

    .ai-key-btn {
      background: var(--accent);
      border: none;
      color: #0d0d11;
      border-radius: 8px;
      padding: 7px 14px;
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap
    }

    .ai-key-clear {
      background: var(--danger-dim);
      border: 1px solid rgba(240, 82, 82, .3);
      color: var(--danger);
      border-radius: 8px;
      padding: 7px 10px;
      font-size: 11px;
      cursor: pointer;
      white-space: nowrap
    }

    /* MOBILE TOPBAR */
    .mobile-topbar {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 52px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      z-index: 200;
      padding: 0 14px;
      align-items: center;
      gap: 10px
    }

    .mobile-menu-btn {
      background: none;
      border: none;
      color: var(--text2);
      cursor: pointer;
      font-size: 20px;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center
    }

    .mobile-logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 16px;
      color: var(--text);
      flex: 1
    }

    /* MOBILE ACTION BUTTON */
    .mobile-action-btn {
      background: var(--accent);
      border: none;
      color: #0d0d11;
      width: 36px;
      height: 36px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: var(--tr);
      flex-shrink: 0;
      box-shadow: 0 3px 10px var(--accent-glow)
    }

    .mobile-action-btn:hover {
      filter: brightness(1.08)
    }

    /* MOBILE QUICK MENU */
    .mobile-quick-menu {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border2);
      border-radius: 20px 20px 0 0;
      z-index: 1200;
      padding: 0 16px 24px;
      box-shadow: 0 -20px 60px rgba(0, 0, 0, .6);
      transform: translateY(100%);
      transition: transform .3s cubic-bezier(.4, 0, .2, 1)
    }

    .mobile-quick-menu.open {
      transform: translateY(0)
    }

    .mqm-handle {
      width: 36px;
      height: 4px;
      background: var(--border2);
      border-radius: 2px;
      margin: 12px auto 16px
    }

    .mqm-title {
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 12px;
      text-align: center
    }

    .mqm-streak {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: var(--accent-dim);
      border: 1px solid var(--accent-glow);
      border-radius: 12px;
      padding: 10px 16px;
      margin-bottom: 12px;
      cursor: pointer
    }

    .mqm-streak-icon {
      font-size: 18px
    }

    .mqm-streak-text {
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 14px;
      color: var(--accent)
    }

    .mqm-streak-sub {
      font-size: 10px;
      color: var(--text2);
      font-family: 'Syne', sans-serif
    }

    .mqm-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px
    }

    .mqm-item {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 12px;
      cursor: pointer;
      transition: var(--tr);
      display: flex;
      align-items: center;
      gap: 10px
    }

    .mqm-item:hover,
    .mqm-item:active {
      border-color: var(--accent-glow);
      background: var(--accent-dim)
    }

    .mqm-item-icon {
      font-size: 22px;
      flex-shrink: 0
    }

    .mqm-item-text {
      font-family: 'Syne', sans-serif;
      font-size: 12px;
      font-weight: 700;
      color: var(--text)
    }

    .mqm-item-sub {
      font-size: 10px;
      color: var(--text3);
      margin-top: 1px
    }

    .mqm-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .5);
      z-index: 1100;
      display: none
    }

    .mqm-backdrop.vis {
      display: block
    }

    /* MOBILE BOTTOM NAV */
    .mobile-bottom-nav {
      display: none;
      position: sticky;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--surface);
      border-top: 1px solid var(--border);
      padding: 8px 4px 4px;
      flex-shrink: 0;
      z-index: 10
    }

    .mbn-items {
      display: flex;
      justify-content: space-around;
      align-items: center
    }

    .mbn-btn {
      background: none;
      border: none;
      color: var(--text3);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      padding: 4px 8px;
      border-radius: 8px;
      transition: var(--tr);
      font-size: 9px;
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      flex: 1
    }

    .mbn-btn:hover,
    .mbn-btn.active {
      color: var(--accent)
    }

    .mbn-btn-icon {
      font-size: 18px;
      line-height: 1
    }

    /* MOBILE SIDEBAR */
    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .6);
      z-index: 999;
      backdrop-filter: blur(2px)
    }

    .mobile-overlay.vis {
      display: block
    }

    .sidebar-close-btn {
      display: none;
      position: absolute;
      top: 14px;
      right: 14px;
      background: var(--surface3);
      border: 1px solid var(--border);
      color: var(--text2);
      width: 30px;
      height: 30px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      align-items: center;
      justify-content: center;
      z-index: 10
    }

    /* CONFETTI */
    .confetti-piece {
      position: fixed;
      width: 8px;
      height: 8px;
      border-radius: 2px;
      pointer-events: none;
      z-index: 900;
      animation: confettiFall 2.5s ease-in forwards
    }

    @keyframes confettiFall {
      0% {
        transform: translateY(-20px) rotate(0deg);
        opacity: 1
      }

      100% {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0
      }
    }

    /* RESPONSIVE */
    @media(max-width:900px) {
      :root {
        --rail: 0px;
        --sidebar: 240px
      }

      .rail {
        display: none
      }

      .app {
        grid-template-columns: var(--sidebar) 1fr
      }
    }

    @media(max-width:620px) {
      .panel-title {
        justify-content: normal;
        gap: 20px
      }

      .tmpl-grid {
        grid-template-columns: 1fr
      }

      .app {
        grid-template-columns: 1fr
      }

      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 80vw !important;
        height: 100vh !important;
        max-height: 100vh !important;
        z-index: 1000;
        border-right: none;
        transform: translateX(-100%);
        transition: transform .3s cubic-bezier(.4, 0, .2, 1);
        overflow-y: auto;
        display: flex;
        flex-direction: column
      }

      .sidebar.mobile-open {
        transform: translateX(0)
      }

      .editor-area {
        grid-column: 1;
        padding-top: 52px
      }

      .mobile-topbar {
        display: flex !important
      }

      .ed-topbar {
        flex-wrap: wrap
      }

      .title-inp {
        font-size: 16px
      }

      .find-inp {
        width: 110px
      }

      .replace-inp {
        width: 90px
      }

      .no-note-actions {
        grid-template-columns: 1fr 1fr
      }

      .mobile-bottom-nav {
        display: block
      }

      .sidebar-close-btn {
        display: flex
      }

      /* Compact toolbar on mobile */
      .toolbar .fs-sel,
      .toolbar .font-sel {
        display: none
      }

      .tb-overflow-group {
        display: none
      }
    }
  </style>
</head>

<body>
  <div class="orb orb1"></div>
  <div class="orb orb2"></div>
  <button class="focus-exit-btn" id="focusExitBtn" onclick="toggleFocusMode()">âœ• Exit Focus</button>

  <!-- MOBILE QUICK MENU BACKDROP -->
  <div class="mqm-backdrop" id="mqmBackdrop" onclick="closeMobileQuickMenu()"></div>

  <!-- MOBILE QUICK MENU -->
  <div class="mobile-quick-menu" id="mobileQuickMenu">
    <div class="mqm-handle"></div>
    <div class="mqm-title">Quick Actions</div>
    <div class="mqm-streak" onclick="closeMobileQuickMenu();openStats()">
      <span class="mqm-streak-icon">ðŸ”¥</span>
      <div>
        <div class="mqm-streak-text" id="mqmStreakNum">0 day streak</div>
        <div class="mqm-streak-sub">Tap to see stats</div>
      </div>
    </div>
    <div class="mqm-grid">
      <div class="mqm-item" onclick="closeMobileQuickMenu();createNote()">
        <span class="mqm-item-icon">âœï¸</span>
        <div>
          <div class="mqm-item-text">New Note</div>
          <div class="mqm-item-sub">Start writing</div>
        </div>
      </div>
      <div class="mqm-item" onclick="closeMobileQuickMenu();openTemplates()">
        <span class="mqm-item-icon">ðŸ“‹</span>
        <div>
          <div class="mqm-item-text">Template</div>
          <div class="mqm-item-sub">Use a structure</div>
        </div>
      </div>
      <div class="mqm-item" onclick="closeMobileQuickMenu();openDailyNote()">
        <span class="mqm-item-icon">ðŸ“…</span>
        <div>
          <div class="mqm-item-text">Daily Note</div>
          <div class="mqm-item-sub">Today's journal</div>
        </div>
      </div>
      <div class="mqm-item" onclick="closeMobileQuickMenu();openImport()">
        <span class="mqm-item-icon">ðŸ“¥</span>
        <div>
          <div class="mqm-item-text">Import</div>
          <div class="mqm-item-sub">.md or .txt files</div>
        </div>
      </div>
    </div>
  </div>

  <div class="app" id="app">
    <!-- RAIL -->
    <nav class="rail" id="rail">
      <div class="rail-streak" onclick="openStats()" title="Writing streak" style="margin-bottom:8px;margin-top:4px">
        <div class="rail-streak-icon">ðŸ”¥</div>
        <div class="rail-streak-num" id="railStreakNum">0</div>
      </div>
      <button class="rail-btn" onclick="createNote()"><svg width="17" height="17" fill="none" stroke="currentColor"
          stroke-width="2.2" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg><span class="tip">New Note</span></button>
      <button class="rail-btn" onclick="openTemplates()"><svg width="17" height="17" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="3" width="8" height="8" rx="1" />
          <rect x="13" y="3" width="8" height="8" rx="1" />
          <rect x="3" y="13" width="8" height="8" rx="1" />
          <path d="M13 17h8M17 13v8" />
        </svg><span class="tip">Templates</span></button>
      <div class="rail-sep"></div>
      <button class="rail-btn active" id="railNotes" onclick="switchView('notes')"><svg width="17" height="17"
          fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
          <polyline points="14 2 14 8 20 8" />
          <line x1="16" y1="13" x2="8" y2="13" />
          <line x1="16" y1="17" x2="8" y2="17" />
        </svg><span class="tip">All Notes</span></button>
      <button class="rail-btn" id="railFolders" onclick="togglePanel('folders')"><svg width="17" height="17" fill="none"
          stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
        </svg><span class="tip">Folders</span></button>
      <button class="rail-btn" id="railTags" onclick="togglePanel('tags')"><svg width="17" height="17" fill="none"
          stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" />
          <line x1="7" y1="7" x2="7.01" y2="7" />
        </svg><span class="tip">Tags</span></button>
      <button class="rail-btn" id="railBin" onclick="switchView('bin')"><svg width="17" height="17" fill="none"
          stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <polyline points="3 6 5 6 21 6" />
          <path d="M19 6l-1 14H6L5 6" />
          <path d="M10 11v6M14 11v6" />
          <path d="M9 6V4h6v2" />
        </svg><span class="tip">Recycle Bin</span></button>
      <div class="rail-sep"></div>
      <button class="rail-btn" onclick="openDailyNote()"><svg width="17" height="17" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg><span class="tip">Daily Note</span></button>
      <button class="rail-btn" onclick="openImport()"><svg width="17" height="17" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
          <polyline points="17 8 12 3 7 8" />
          <line x1="12" y1="3" x2="12" y2="15" />
        </svg><span class="tip">Import</span></button>
      <button class="rail-btn" id="railSplitBtn" onclick="toggleSplitView()" title="Split View"><svg width="17"
          height="17" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <rect x="3" y="3" width="18" height="18" rx="2" />
          <line x1="12" y1="3" x2="12" y2="21" />
        </svg><span class="tip">Split View</span></button>
      <div class="rail-spacer"></div>
      <button class="rail-btn" onclick="openShortcuts()"><svg width="17" height="17" fill="none" stroke="currentColor"
          stroke-width="2" viewBox="0 0 24 24">
          <rect x="2" y="6" width="20" height="12" rx="2" />
          <path d="M6 10h.01M10 10h.01M14 10h.01M18 10h.01M8 14h8" />
        </svg><span class="tip">Shortcuts</span></button>
      <button class="rail-btn" id="themeBtn" onclick="openThemeModal()"><svg id="themeIco" width="17" height="17"
          fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />
        </svg><span class="tip">Theme</span></button>
    </nav>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="sidebar">
      <button class="sidebar-close-btn" onclick="toggleMobileSidebar()">âœ•</button>
      <div class="panel-hdr">
        <div class="panel-title">
          <span class="panel-title-lbl"><span class="panel-icon">ðŸ“</span><span id="panelTitleText">Notes</span></span>
          <span class="cnt-pill" id="cnt">0</span>
        </div>
        <button class="btn-new" onclick="createNote()">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.8" viewBox="0 0 24 24">
            <line x1="12" y1="5" x2="12" y2="19" />
            <line x1="5" y1="12" x2="19" y2="12" />
          </svg>
          New Note
        </button>
      </div>
      <div class="sb-search">
        <div class="search-wrap">
          <svg class="search-ico" width="13" height="13" fill="none" stroke="currentColor" stroke-width="2"
            viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8" />
            <path d="m21 21-4.35-4.35" />
          </svg>
          <input type="text" class="search-inp" id="searchInp" placeholder="Search notesâ€¦"
            oninput="onSearch(this.value)">
          <button class="search-clear" id="searchClear" onclick="clearSearch()">âœ•</button>
        </div>
      </div>
      <div class="sort-row" id="sortRow">
        <span class="sort-lbl">Sort:</span>
        <select class="sort-sel" id="sortSel" onchange="renderList()">
          <option value="updated">Updated</option>
          <option value="created">Created</option>
          <option value="title">Title</option>
          <option value="pinned">Pinned first</option>
          <option value="manual">Manual order</option>
        </select>
      </div>
      <div class="tag-filter-strip" id="tagFilterStrip"></div>
      <div class="sel-banner" id="selBanner">
        <span class="sel-banner-txt" id="selCount">0 selected</span>
        <button class="sel-banner-btn" onclick="selMoveFolder()">ðŸ“ Move</button>
        <button class="sel-banner-btn danger" onclick="selDelete()">ðŸ—‘ Delete</button>
        <button class="sel-banner-btn" onclick="exitSelMode()">âœ• Cancel</button>
      </div>
      <div class="list-header"><span id="listHdrText">Notes</span></div>
      <div class="notes-list" id="notesList" style="flex:1;min-height:0" tabindex="0"></div>

      <!-- Mobile Bottom Nav inside sidebar -->
      <div class="mobile-bottom-nav" id="mobileSidebarNav">
        <div class="mbn-items">
          <button class="mbn-btn active" id="mbnNotes" onclick="switchView('notes');mbnActive('mbnNotes')">
            <span class="mbn-btn-icon">ðŸ“</span>Notes
          </button>
          <button class="mbn-btn" id="mbnFolders" onclick="togglePanel('folders');mbnActive('mbnFolders')">
            <span class="mbn-btn-icon">ðŸ“</span>Folders
          </button>
          <button class="mbn-btn" id="mbnTags" onclick="togglePanel('tags');mbnActive('mbnTags')">
            <span class="mbn-btn-icon">ðŸ·</span>Tags
          </button>
          <button class="mbn-btn" id="mbnBin" onclick="switchView('bin');mbnActive('mbnBin')">
            <span class="mbn-btn-icon">ðŸ—‘</span>Bin
          </button>
        </div>
      </div>

      <div class="side-panel" id="foldersPanel">
        <div class="side-panel-inner">
          <div class="side-panel-hdr"><span>Folders</span><button class="sp-add-btn" onclick="openFolderModal()">+
              New</button></div>
          <div class="folder-list" id="folderList"></div>
        </div>
      </div>
      <div class="side-panel" id="tagsPanel">
        <div class="side-panel-inner">
          <div class="side-panel-hdr"><span>Tags</span><button class="sp-add-btn" onclick="openTagModal()">+
              New</button></div>
          <div class="tags-flow" id="tagsList"></div>
        </div>
      </div>
    </aside>

    <div class="mobile-overlay" id="mobileOverlay" onclick="toggleMobileSidebar()"></div>

    <!-- MOBILE TOPBAR -->
    <div class="mobile-topbar" id="mobileTopbar">
      <button class="mobile-menu-btn" onclick="toggleMobileSidebar()">â˜°</button>
      <span class="mobile-logo">âœ¦ Noteflux</span>
      <button class="mobile-menu-btn" onclick="cycleTheme()" title="Change theme">ðŸŒ—</button>
      <button class="mobile-action-btn" onclick="openMobileQuickMenu()" title="Quick actions">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24">
          <line x1="12" y1="5" x2="12" y2="19" />
          <line x1="5" y1="12" x2="19" y2="12" />
        </svg>
      </button>
    </div>

    <!-- EDITOR -->
    <main class="editor-area" id="edArea">
      <div class="no-note">
        <div class="no-note-icon">âœ¦</div>
        <h2>Welcome to Noteflux</h2>
        <p class="no-note-sub">Select a note or get started below</p>
        <div class="no-note-actions">
          <div class="no-note-card" onclick="createNote()">
            <div class="no-note-card-icon">âœï¸</div>
            <div class="no-note-card-label">New Note</div>
            <div class="no-note-card-desc">Start writing something new</div>
          </div>
          <div class="no-note-card" onclick="openTemplates()">
            <div class="no-note-card-icon">ðŸ“‹</div>
            <div class="no-note-card-label">Templates</div>
            <div class="no-note-card-desc">Meeting notes, journals & more</div>
          </div>
          <div class="no-note-card" onclick="openDailyNote()">
            <div class="no-note-card-icon">ðŸ“…</div>
            <div class="no-note-card-label">Daily Note</div>
            <div class="no-note-card-desc">Today's journal entry</div>
          </div>
          <div class="no-note-card" onclick="openImport()">
            <div class="no-note-card-icon">ðŸ“¥</div>
            <div class="no-note-card-label">Import</div>
            <div class="no-note-card-desc">Bring in .md or .txt files</div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* â•â•â•â•â•â•â•â•â•â•â• STATE â•â•â•â•â•â•â•â•â•â•â• */
    let notes = JSON.parse(localStorage.getItem('nf_notes') || '[]');
    let bin = JSON.parse(localStorage.getItem('nf_bin') || '[]');
    let folders = JSON.parse(localStorage.getItem('nf_folders') || '[]');
    let customTemplates = JSON.parse(localStorage.getItem('nf_custom_templates') || '[]');
    let noteOrder = JSON.parse(localStorage.getItem('nf_note_order') || '[]');
    const BUILT_TAGS = [{ id: 'personal', label: 'Personal', color: '#9b87ff', builtin: true }, { id: 'work', label: 'Work', color: '#b8e32a', builtin: true }, { id: 'idea', label: 'Idea', color: '#fb923c', builtin: true }, { id: 'misc', label: 'Misc', color: '#6b7280', builtin: true }];
    let cTags = JSON.parse(localStorage.getItem('nf_tags') || '[]');
    const allTags = () => [...BUILT_TAGS, ...cTags];
    const tagById = id => allTags().find(t => t.id === id) || BUILT_TAGS[3];
    const noteById = id => notes.find(n => n.id === id);

    let activeId = null, curView = 'notes', activeFolder = null, activeTagFilter = null;
    let currentTheme = localStorage.getItem('nf_theme') || 'dark';
    let focusMode = false;
    let wcGoal = parseInt(localStorage.getItem('nf_wcgoal') || '0');
    let canvasColor = '#ffffff', brushSize = 4, drawTool = 'pen';
    let isDrawing = false, startX = 0, startY = 0, snapshot = null;
    let pomoState = { running: false, mode: 'work', secs: 25 * 60, interval: null, workMins: 25, breakMins: 5, sessions: 0 };
    let pomoCollapsed = localStorage.getItem('nf_pomo_collapsed') === 'true';
    let openPanels = { folders: false, tags: false };
    let findMatches = [], findIdx = 0;
    let kbdIdx = -1;
    let selMode = false, selIds = new Set();
    let typewriterMode = false;
    let editorLineWidth = localStorage.getItem('nf_linewidth') || 'none';
    let editorFontFamily = localStorage.getItem('nf_fontfamily') || "'DM Sans',sans-serif";
    let hoverTimer = null, hoverPreview = null;
    let milestones = JSON.parse(localStorage.getItem('nf_milestones') || '{}');
    const NOTE_COLORS = ['', '#f05252', '#fb923c', '#facc15', '#b8e32a', '#34d399', '#38bdf8', '#7c5cfc', '#d946ef', '#94a3b8'];
    let resizingImg = null, resizeStartX = 0, resizeStartW = 0;
    let splitActive = false, splitNoteId = null;
    let aiApiKey = localStorage.getItem('nf_ai_key') || '';

    // Drag & drop state
    let dragSrcId = null;

    const sv = k => { const map = { notes: 'nf_notes', bin: 'nf_bin', folders: 'nf_folders', tags: 'nf_tags', ctemplates: 'nf_custom_templates', order: 'nf_note_order' }; const data = { notes, bin, folders, tags: cTags, ctemplates: customTemplates, order: noteOrder }; localStorage.setItem(map[k], JSON.stringify(data[k])); };

    /* â•â•â•â•â•â•â•â•â•â•â• UTILS â•â•â•â•â•â•â•â•â•â•â• */
    const esc = s => String(s || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    function fd(ts) { const d = Date.now() - ts; if (d < 60e3) return 'just now'; if (d < 36e5) return ~~(d / 6e4) + 'm ago'; if (d < 864e5) return ~~(d / 36e5) + 'h ago'; return new Date(ts).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); }
    function wc(h) { const t = h.replace(/<[^>]*>/g, ' ').trim(); return t ? t.split(/\s+/).filter(Boolean).length : 0; }
    function rt(w) { const m = Math.ceil(w / 200); return m < 1 ? '<1 min' : m + ' min read'; }
    function tCss(c = '#888') { const x = c.replace('#', ''); const r = parseInt(x.slice(0, 2), 16) || 128, g = parseInt(x.slice(2, 4), 16) || 128, b = parseInt(x.slice(4, 6), 16) || 128; return `background:rgba(${r},${g},${b},.18);color:${c};`; }
    function getSorted(arr) {
      const s = document.getElementById('sortSel')?.value || 'updated'; const a = [...arr];
      if (s === 'manual') {
        const idxMap = {}; noteOrder.forEach((id, i) => idxMap[id] = i);
        a.sort((x, y) => { const ix = idxMap[x.id] ?? 999999, iy = idxMap[y.id] ?? 999999; return ix - iy; });
        return a;
      }
      if (s === 'updated') a.sort((x, y) => y.updatedAt - x.updatedAt);
      else if (s === 'created') a.sort((x, y) => y.createdAt - x.createdAt);
      else if (s === 'title') a.sort((x, y) => (x.title || '').localeCompare(y.title || ''));
      else if (s === 'pinned') { a.sort((x, y) => y.updatedAt - x.updatedAt); a.sort((x, y) => (y.pinned ? 1 : 0) - (x.pinned ? 1 : 0)); }
      return a;
    }
    function todayStr() { return new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); }
    function todayKey() { const d = new Date(); return `daily-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`; }
    function closeAllDropdowns() { document.querySelectorAll('.dropdown,.ctx-menu').forEach(d => d.remove()); document.querySelectorAll('.confirm-popup').forEach(d => d.remove()); document.getElementById('tpBtn')?.classList.remove('open'); removeHoverPreview(); }

    /* â•â•â•â•â•â•â•â•â•â•â• THEME â•â•â•â•â•â•â•â•â•â•â• */
    function applyTheme(t) { currentTheme = t; document.body.classList.remove('light', 'sepia'); if (t === 'light') document.body.classList.add('light'); if (t === 'sepia') document.body.classList.add('sepia'); localStorage.setItem('nf_theme', t); updateThemeIcon(); }
    function cycleTheme() { const order = ['dark', 'light', 'sepia']; const i = (order.indexOf(currentTheme) + 1) % 3; applyTheme(order[i]); }
    function openThemeModal() { const ov = mkOverlay('themeMod'); ov.innerHTML = `<div class="modal" style="max-width:360px"><div class="modal-stripe stripe-purple"></div><div class="modal-icon" style="background:var(--accent2-dim);border:1px solid rgba(124,92,252,.3)">ðŸŽ¨</div><h3>Theme</h3><div class="theme-grid"><div class="theme-card${currentTheme === 'dark' ? ' active' : ''}" onclick="applyTheme('dark');closeModal('themeMod')"><div class="theme-preview" style="background:linear-gradient(135deg,#0d0d11,#1c1c22)"></div><div class="theme-name">Dark</div></div><div class="theme-card${currentTheme === 'light' ? ' active' : ''}" onclick="applyTheme('light');closeModal('themeMod')"><div class="theme-preview" style="background:linear-gradient(135deg,#efefe9,#f2f2ec)"></div><div class="theme-name">Light</div></div><div class="theme-card${currentTheme === 'sepia' ? ' active' : ''}" onclick="applyTheme('sepia');closeModal('themeMod')"><div class="theme-preview" style="background:linear-gradient(135deg,#f4ecd8,#fdf6e3)"></div><div class="theme-name">Sepia</div></div></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('themeMod')">Close</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('themeMod'); }); }
    function updateThemeIcon() { const ico = document.getElementById('themeIco'); if (!ico) return; if (currentTheme === 'light') ico.innerHTML = '<circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>'; else if (currentTheme === 'sepia') ico.innerHTML = '<circle cx="12" cy="12" r="5"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>'; else ico.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>'; }
    applyTheme(currentTheme);

    /* â•â•â•â•â•â•â•â•â•â•â• MOBILE â•â•â•â•â•â•â•â•â•â•â• */
    function toggleMobileSidebar() { const sb = document.getElementById('sidebar'), ov = document.getElementById('mobileOverlay'); const isOpen = sb.classList.contains('mobile-open'); if (isOpen) { sb.classList.remove('mobile-open'); ov.classList.remove('vis'); } else { sb.classList.add('mobile-open'); ov.classList.add('vis'); } }
    function closeMobileSidebar() { document.getElementById('sidebar')?.classList.remove('mobile-open'); document.getElementById('mobileOverlay')?.classList.remove('vis'); }
    function openMobileQuickMenu() { document.getElementById('mobileQuickMenu').classList.add('open'); document.getElementById('mqmBackdrop').classList.add('vis'); updateMqmStreak(); }
    function closeMobileQuickMenu() { document.getElementById('mobileQuickMenu').classList.remove('open'); document.getElementById('mqmBackdrop').classList.remove('vis'); }
    function updateMqmStreak() { const s = calcStreak(); const el = document.getElementById('mqmStreakNum'); if (el) el.textContent = s + ' day streak'; }
    function mbnActive(id) { document.querySelectorAll('.mbn-btn').forEach(b => b.classList.remove('active')); document.getElementById(id)?.classList.add('active'); }

    /* â•â•â•â•â•â•â•â•â•â•â• PANELS â•â•â•â•â•â•â•â•â•â•â• */
    function togglePanel(name) { openPanels[name] = !openPanels[name]; const panel = document.getElementById(name + 'Panel'); const railBtn = document.getElementById('rail' + name.charAt(0).toUpperCase() + name.slice(1)); if (openPanels[name]) { panel.classList.add('open'); requestAnimationFrame(() => { panel.style.maxHeight = '600px'; panel.style.opacity = '1'; }); railBtn?.classList.add('active'); } else { panel.style.maxHeight = '0'; panel.style.opacity = '0'; panel.classList.remove('open'); railBtn?.classList.remove('active'); } }

    /* â•â•â•â•â•â•â•â•â•â•â• VIEW â•â•â•â•â•â•â•â•â•â•â• */
    function switchView(v) { if (selMode) exitSelMode(); curView = v; activeFolder = null; activeTagFilter = null;['Notes', 'Bin'].forEach(n => document.getElementById('rail' + n)?.classList.remove('active')); if (v === 'notes') document.getElementById('railNotes')?.classList.add('active'); if (v === 'bin') document.getElementById('railBin')?.classList.add('active'); const icons = { notes: 'ðŸ“', bin: 'ðŸ—‘ï¸' }; const texts = { notes: 'Notes', bin: 'Recycle Bin' }; document.getElementById('panelTitleText').textContent = texts[v] || 'Notes'; document.querySelector('.panel-icon').textContent = icons[v] || 'ðŸ“'; document.getElementById('sortRow').style.display = v === 'bin' ? 'none' : 'flex'; document.getElementById('listHdrText').textContent = texts[v] || 'Notes'; if (v === 'bin' && activeId) { activeId = null; showEmpty(); } kbdIdx = -1; renderList(); renderTagFilterStrip(); }

    /* â•â•â•â•â•â•â•â•â•â•â• TAG FILTER STRIP â•â•â•â•â•â•â•â•â•â•â• */
    function renderTagFilterStrip() { const strip = document.getElementById('tagFilterStrip'); if (!strip) return; if (curView !== 'notes') { strip.innerHTML = ''; return; } const chips = allTags().map(t => { const active = activeTagFilter === t.id; return `<span class="tag-filter-chip${active ? ' active' : ''}" style="${tCss(t.color)}" onclick="toggleTagFilter('${t.id}')">${esc(t.label)}</span>`; }).join(''); strip.innerHTML = chips + (activeTagFilter ? `<span class="tag-filter-chip" style="background:var(--surface3);color:var(--text3)" onclick="toggleTagFilter(null)">âœ• All</span>` : ''); }
    function toggleTagFilter(id) { activeTagFilter = activeTagFilter === id ? null : id; renderList(); renderTagFilterStrip(); }

    /* â•â•â•â•â•â•â•â•â•â•â• SELECTION MODE â•â•â•â•â•â•â•â•â•â•â• */
    function enterSelMode() { selMode = true; selIds = new Set(); document.getElementById('notesList').classList.add('sel-mode'); document.getElementById('selBanner').classList.add('vis'); updateSelBanner(); }
    function exitSelMode() { selMode = false; selIds = new Set(); document.getElementById('notesList').classList.remove('sel-mode'); document.getElementById('selBanner').classList.remove('vis'); document.querySelectorAll('.note-item').forEach(el => el.classList.remove('selected')); document.querySelectorAll('.note-sel-cb').forEach(cb => cb.checked = false); }
    function toggleSel(id) { if (selIds.has(id)) { selIds.delete(id); } else { selIds.add(id); } const el = document.querySelector(`.note-item[data-id="${id}"]`); if (el) { el.classList.toggle('selected', selIds.has(id)); const cb = el.querySelector('.note-sel-cb'); if (cb) cb.checked = selIds.has(id); } updateSelBanner(); }
    function updateSelBanner() { document.getElementById('selCount').textContent = selIds.size + ' selected'; }
    function selMoveFolder() { if (!selIds.size) { showToast('No notes selected'); return; } const ov = mkOverlay('moveMod'); const fOpts = folders.map(f => `<div class="dd-item" onclick="execMoveToFolder('${f.id}')"><span>${f.icon || 'ðŸ“'}</span>${esc(f.name)}</div>`).join(''); ov.innerHTML = `<div class="modal" style="max-width:350px"><div class="modal-stripe stripe-orange"></div><div class="modal-icon" style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25)">ðŸ“</div><h3>Move ${selIds.size} Note${selIds.size > 1 ? 's' : ''} to Folder</h3><div style="margin-top:10px;display:flex;flex-direction:column;gap:2px"><div class="dd-item" onclick="execMoveToFolder(null)"><span>ðŸ“</span>All Notes (no folder)</div>${fOpts || '<p style="color:var(--text3);font-size:12px;padding:8px">No folders yet.</p>'}</div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('moveMod')">Cancel</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('moveMod'); }); }
    function execMoveToFolder(fid) { selIds.forEach(id => { const n = noteById(id); if (n) { n.folder = fid || null; n.updatedAt = Date.now(); } }); sv('notes'); closeModal('moveMod'); exitSelMode(); renderList(); renderFolders(); showToast(`âœ“ Moved notes`); }
    function selDelete() { if (!selIds.size) { showToast('No notes selected'); return; } showConfirm(document.getElementById('selBanner'), `Move ${selIds.size} note${selIds.size > 1 ? 's' : ''} to bin?`, 'Move', () => { selIds.forEach(id => { const n = notes.find(x => x.id === id); if (n) { notes = notes.filter(x => x.id !== id); bin.unshift({ ...n, deletedAt: Date.now() }); } }); sv('notes'); sv('bin'); if (selIds.has(activeId)) { activeId = null; showEmpty(); } exitSelMode(); renderList(); showToast(`ðŸ—‘ Moved to bin`); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• FOLDERS â•â•â•â•â•â•â•â•â•â•â• */
    function renderFolders() { const el = document.getElementById('folderList'); if (!el) return; el.innerHTML = ''; const all = document.createElement('div'); all.className = 'folder-item' + (activeFolder === null ? ' folder-active' : ''); all.innerHTML = `<span>ðŸ“</span><span class="folder-name">All Notes</span><span class="folder-cnt-badge">${notes.length}</span>`; all.onclick = () => { activeFolder = null; curView = 'notes'; renderList(); renderFolders(); }; el.appendChild(all); folders.forEach(f => { const cnt = notes.filter(n => n.folder === f.id).length; const d = document.createElement('div'); d.className = 'folder-item' + (activeFolder === f.id ? ' folder-active' : ''); d.innerHTML = `<span>${f.icon || 'ðŸ“'}</span><span class="folder-name" title="${esc(f.name)}">${esc(f.name.slice(0, 16))}</span><span class="folder-cnt-badge">${cnt}</span><button class="folder-del" onclick="delFolder('${f.id}',event)">âœ•</button>`; d.onclick = e => { if (e.target.classList.contains('folder-del')) return; activeFolder = f.id; curView = 'notes'; renderList(); renderFolders(); }; el.appendChild(d); }); }
    let selFolderIcon = 'ðŸ“';
    function openFolderModal() { closeAllDropdowns(); const icons = ['ðŸ“', 'ðŸ“‚', 'ðŸ—‚ï¸', 'ðŸ’¼', 'ðŸ ', 'ðŸŽ¯', 'ðŸš€', 'ðŸ’¡', 'â¤ï¸', 'ðŸŒ¿', 'ðŸ”¬', 'ðŸŽ¨', 'ðŸ“š', 'ðŸ’°', 'ðŸ‹ï¸', 'âš¡']; const ov = mkOverlay('folderMod'); ov.innerHTML = `<div class="modal"><div class="modal-stripe stripe-orange"></div><div class="modal-icon" style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25)">ðŸ“</div><h3>New Folder</h3><label class="f-label">Name</label><input class="f-inp" id="fni" maxlength="28" placeholder="e.g. Work Projectsâ€¦"><label class="f-label">Icon</label><div class="icons-grid" id="iconGrid">${icons.map(ic => `<span class="icon-opt" onclick="pickFIcon('${ic}',this)">${ic}</span>`).join('')}</div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('folderMod')">Cancel</button><button class="btn-accent" onclick="saveFolder()">Create</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('folderMod'); }); setTimeout(() => { document.getElementById('fni')?.focus(); pickFIcon('ðŸ“', document.querySelector('#iconGrid .icon-opt')); }, 60); }
    function pickFIcon(ic, el) { selFolderIcon = ic; document.querySelectorAll('#iconGrid .icon-opt').forEach(s => s.classList.remove('sel')); if (el) el.classList.add('sel'); }
    function saveFolder() { const name = document.getElementById('fni')?.value.trim(); if (!name) { showToast('âš ï¸ Enter a folder name'); return; } folders.push({ id: 'f_' + Date.now(), name: name.slice(0, 28), icon: selFolderIcon }); sv('folders'); closeModal('folderMod'); renderFolders(); showToast(`âœ“ Folder "${name}" created`); if (!openPanels.folders) togglePanel('folders'); }
    function delFolder(id, e) { e && e.stopPropagation(); showConfirm(e.target, 'Delete folder? Notes stay in All Notes.', 'Delete', () => { notes.forEach(n => { if (n.folder === id) delete n.folder; }); sv('notes'); folders = folders.filter(f => f.id !== id); sv('folders'); if (activeFolder === id) activeFolder = null; renderFolders(); renderList(); showToast('Folder deleted'); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• TAGS â•â•â•â•â•â•â•â•â•â•â• */
    function renderTags() { const el = document.getElementById('tagsList'); if (!el) return; el.innerHTML = ''; allTags().forEach(t => { const active = activeTagFilter === t.id; const c = document.createElement('span'); c.className = 'tag-chip' + (active ? ' tag-active' : ''); c.style.cssText = tCss(t.color); c.title = t.label; c.innerHTML = `<span class="tag-chip-name">${esc(t.label.slice(0, 14))}</span>` + (!t.builtin ? `<button class="tag-chip-del" onclick="removeTag('${t.id}',event)">âœ•</button>` : ''); c.onclick = e => { if (!e.target.classList.contains('tag-chip-del')) toggleTagFilter(t.id); }; el.appendChild(c); }); }
    function removeTag(id, e) { e && e.stopPropagation(); cTags = cTags.filter(t => t.id !== id); sv('tags'); notes.forEach(n => { if (n.tags?.includes(id)) n.tags = n.tags.filter(x => x !== id); if (!n.tags?.length) n.tags = ['misc']; }); sv('notes'); renderTags(); renderList(); refreshTagBtn(); showToast('Tag removed'); }
    const SWATCHES = ['#f05252', '#fb923c', '#facc15', '#b8e32a', '#34d399', '#38bdf8', '#7c5cfc', '#d946ef', '#fb7185', '#c4a77a', '#a3e4d7', '#93c5fd', '#a78bfa', '#f9a8d4', '#94a3b8', '#f5f5f5'];
    let pColor = '#7c5cfc';
    function openTagModal() { closeAllDropdowns(); pColor = '#7c5cfc'; const ov = mkOverlay('tagMod'); ov.innerHTML = `<div class="modal"><div class="modal-stripe stripe-purple"></div><div class="modal-icon" style="background:var(--accent2-dim);border:1px solid rgba(124,92,252,.3)">ðŸ·ï¸</div><h3>Create New Tag</h3><label class="f-label">Name</label><input class="f-inp" id="tni" maxlength="20" placeholder="e.g. Design, Healthâ€¦" oninput="syncTagPrev()"><label class="f-label">Color</label><div class="swatches" id="swG">${SWATCHES.map(c => `<div class="swatch${c === pColor ? ' sel' : ''}" style="background:${c}" data-c="${c}" onclick="pickSw('${c}')"></div>`).join('')}</div><div class="color-row"><div class="hex-wrap"><div class="color-dot" id="cdot" style="background:${pColor}"></div><input class="hex-inp" id="hexI" value="${pColor}" maxlength="7" oninput="onHex(this.value)"></div><input type="color" class="color-native" id="natP" value="${pColor}" oninput="onNat(this.value)"></div><div class="tag-prev-row"><span class="tag-prev-lbl">Preview:</span><span class="tag-prev-pill" id="prevB" style="${tCss(pColor)}">New Tag</span></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('tagMod')">Cancel</button><button class="btn-purple" onclick="saveTag()">Create Tag</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('tagMod'); }); setTimeout(() => document.getElementById('tni')?.focus(), 60); }
    function pickSw(c) { pColor = c; document.querySelectorAll('#swG .swatch').forEach(s => s.classList.toggle('sel', s.dataset.c === c)); syncClr(c); }
    function onHex(v) { if (/^#[0-9a-fA-F]{6}$/.test(v)) { pColor = v; syncClr(v, true); } }
    function onNat(v) { pColor = v; syncClr(v, false, true); }
    function syncClr(c, sh = false, sn = false) { const d = document.getElementById('cdot'), h = document.getElementById('hexI'), n = document.getElementById('natP'); if (d) d.style.background = c; if (h && !sh) h.value = c; if (n && !sn) n.value = c; document.querySelectorAll('#swG .swatch').forEach(s => s.classList.toggle('sel', s.dataset.c === c)); syncTagPrev(); }
    function syncTagPrev() { const b = document.getElementById('prevB'), i = document.getElementById('tni'); if (!b) return; b.style.cssText = tCss(pColor); b.textContent = i?.value.trim() || 'New Tag'; }
    function saveTag() { const name = document.getElementById('tni')?.value.trim(); if (!name) { showToast('âš ï¸ Enter a tag name'); return; } cTags.push({ id: 'ct_' + Date.now(), label: name.slice(0, 20), color: pColor, builtin: false }); sv('tags'); closeModal('tagMod'); renderTags(); renderTagFilterStrip(); refreshTagBtn(); showToast(`âœ“ Tag "${name}" created`); if (!openPanels.tags) togglePanel('tags'); }

    /* â•â•â•â•â•â•â•â•â•â•â• HOVER PREVIEW â•â•â•â•â•â•â•â•â•â•â• */
    function removeHoverPreview() { if (hoverPreview) { hoverPreview.remove(); hoverPreview = null; } clearTimeout(hoverTimer); }
    function showHoverPreview(e, n) { removeHoverPreview(); hoverTimer = setTimeout(() => { const prev = document.createElement('div'); prev.className = 'note-hover-preview'; const bodyText = n.content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim().slice(0, 300); prev.innerHTML = `<div class="nhp-title">${esc(n.title) || 'Untitled'}</div><div class="nhp-body">${esc(bodyText)}</div>`; const rect = { x: e.clientX + 14, y: e.clientY }; if (rect.x + 270 > window.innerWidth) rect.x = e.clientX - 280; prev.style.cssText = `left:${rect.x}px;top:${Math.min(rect.y, window.innerHeight - 210)}px`; document.body.appendChild(prev); hoverPreview = prev; }, 500); }

    /* â•â•â•â•â•â•â•â•â•â•â• CRUD â•â•â•â•â•â•â•â•â•â•â• */
    function createNote(content = '', title = '') { const n = { id: Date.now().toString(), title, content, canvasData: '', tags: ['misc'], pinned: false, locked: false, color: '', folder: activeFolder || null, createdAt: Date.now(), updatedAt: Date.now() }; notes.unshift(n); noteOrder.unshift(n.id); sv('notes'); sv('order'); renderList(); openNote(n.id); setTimeout(() => document.getElementById('titleInp')?.focus(), 60); closeMobileSidebar(); checkMilestones(); return n; }
    function openNote(id) { activeId = id; const n = noteById(id); if (!n) return; renderEditor(n); renderList(); }
    function showEmpty() { document.getElementById('edArea').innerHTML = `<div class="no-note"><div class="no-note-icon">âœ¦</div><h2>Welcome to Noteflux</h2><p class="no-note-sub">Select a note or get started below</p><div class="no-note-actions"><div class="no-note-card" onclick="createNote()"><div class="no-note-card-icon">âœï¸</div><div class="no-note-card-label">New Note</div><div class="no-note-card-desc">Start writing something new</div></div><div class="no-note-card" onclick="openTemplates()"><div class="no-note-card-icon">ðŸ“‹</div><div class="no-note-card-label">Templates</div><div class="no-note-card-desc">Meeting notes, journals & more</div></div><div class="no-note-card" onclick="openDailyNote()"><div class="no-note-card-icon">ðŸ“…</div><div class="no-note-card-label">Daily Note</div><div class="no-note-card-desc">Today's journal entry</div></div><div class="no-note-card" onclick="openImport()"><div class="no-note-card-icon">ðŸ“¥</div><div class="no-note-card-label">Import</div><div class="no-note-card-desc">Bring in .md or .txt files</div></div></div></div>`; }
    function duplicateNote(id, e) { e && e.stopPropagation(); const n = noteById(id); if (!n) return; const d = { ...n, id: Date.now().toString(), title: (n.title || 'Untitled') + ' (copy)', createdAt: Date.now(), updatedAt: Date.now(), canvasData: '', pinned: false }; notes.unshift(d); noteOrder.unshift(d.id); sv('notes'); sv('order'); renderList(); openNote(d.id); showToast('âœ“ Duplicated'); }

    /* â•â•â•â•â•â•â•â•â•â•â• DRAG & DROP REORDERING â•â•â•â•â•â•â•â•â•â•â• */
    function onDragStart(e, id) { dragSrcId = id; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', id); document.querySelector(`.note-item[data-id="${id}"]`)?.classList.add('dragging'); }
    function onDragOver(e, id) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; document.querySelectorAll('.note-item.drag-over').forEach(el => el.classList.remove('drag-over')); if (id !== dragSrcId) document.querySelector(`.note-item[data-id="${id}"]`)?.classList.add('drag-over'); }
    function onDragLeave(e, id) { document.querySelector(`.note-item[data-id="${id}"]`)?.classList.remove('drag-over'); }
    function onDrop(e, id) {
      e.preventDefault(); document.querySelectorAll('.note-item.drag-over,.note-item.dragging').forEach(el => el.classList.remove('drag-over', 'dragging')); if (!dragSrcId || dragSrcId === id) return;
      // reorder notes array
      const srcIdx = notes.findIndex(n => n.id === dragSrcId); const dstIdx = notes.findIndex(n => n.id === id); if (srcIdx < 0 || dstIdx < 0) return;
      const [removed] = notes.splice(srcIdx, 1); notes.splice(dstIdx, 0, removed);
      // update manual order
      noteOrder = notes.map(n => n.id);
      sv('notes'); sv('order');
      // switch sort to manual
      const sel = document.getElementById('sortSel'); if (sel) sel.value = 'manual';
      renderList(); dragSrcId = null;
    }
    function onDragEnd(e) { document.querySelectorAll('.note-item.drag-over,.note-item.dragging').forEach(el => el.classList.remove('drag-over', 'dragging')); dragSrcId = null; }

    /* â•â•â•â•â•â•â•â•â•â•â• MILESTONES â•â•â•â•â•â•â•â•â•â•â• */
    function checkMilestones() { const checks = [{ key: 'first_note', msg: 'ðŸŽ‰ First note created!', condition: () => notes.length >= 1 }, { key: 'ten_notes', msg: 'ðŸŒŸ 10 notes milestone!', condition: () => notes.length >= 10 }, { key: 'hundred_notes', msg: 'ðŸ† 100 notes!', condition: () => notes.length >= 100 }]; checks.forEach(c => { if (!milestones[c.key] && c.condition()) { milestones[c.key] = true; localStorage.setItem('nf_milestones', JSON.stringify(milestones)); setTimeout(() => { showToast(c.msg); fireConfetti(); }, 300); } }); const totalWords = notes.reduce((s, n) => s + wc(n.content), 0); const wordChecks = [{ key: '1k_words', n: 1000, msg: 'âœï¸ 1,000 words written!' }, { key: '10k_words', n: 10000, msg: 'ðŸ“š 10,000 words!' }, { key: '50k_words', n: 50000, msg: 'ðŸš€ 50,000 words!' }]; wordChecks.forEach(c => { if (!milestones[c.key] && totalWords >= c.n) { milestones[c.key] = true; localStorage.setItem('nf_milestones', JSON.stringify(milestones)); setTimeout(() => { showToast(c.msg); fireConfetti(); }, 300); } }); }
    function fireConfetti() { const colors = ['#b8e32a', '#7c5cfc', '#f05252', '#fb923c', '#38bdf8', '#34d399']; for (let i = 0; i < 40; i++) { const el = document.createElement('div'); el.className = 'confetti-piece'; el.style.cssText = `left:${20 + Math.random() * 60}%;top:-10px;background:${colors[~~(Math.random() * colors.length)]};animation-delay:${Math.random() * .5}s;animation-duration:${2 + Math.random() * 1.5}s;transform:rotate(${Math.random() * 360}deg)`; document.body.appendChild(el); setTimeout(() => el.remove(), 3500); } }

    /* â•â•â•â•â•â•â•â•â•â•â• RENDER LIST â•â•â•â•â•â•â•â•â•â•â• */
    function renderList(filter = '') {
      const list = document.getElementById('notesList'), cntEl = document.getElementById('cnt');
      if (!list || !cntEl) return;
      const q = (filter || document.getElementById('searchInp')?.value || '').toLowerCase();
      let src = curView === 'bin' ? bin : notes;
      if (activeFolder) src = notes.filter(n => n.folder === activeFolder);
      if (activeTagFilter) src = src.filter(n => (n.tags || []).includes(activeTagFilter));
      const fil = src.filter(n => !q || n.title.toLowerCase().includes(q) || n.content.replace(/<[^>]*>/g, '').toLowerCase().includes(q));
      const sorted = getSorted(fil);
      cntEl.textContent = sorted.length; list.innerHTML = '';
      if (curView === 'bin' && bin.length) { const eb = document.createElement('button'); eb.className = 'bin-empty-btn'; eb.textContent = 'ðŸ—‘ Empty Recycle Bin'; eb.onclick = emptyBin; list.appendChild(eb); }
      if (!sorted.length) { const e = document.createElement('div'); e.className = 'empty-state'; e.innerHTML = q ? `<p>No matches for "<strong>${esc(q)}</strong>"</p>` : (curView === 'bin' ? '<p>Bin is empty</p>' : '<p>No notes yet.<br>Click <strong>New Note</strong> to start.</p>'); list.appendChild(e); return; }
      sorted.forEach((n, i) => {
        const tags = n.tags || ['misc'];
        const el = document.createElement('div');
        el.className = 'note-item' + (n.id === activeId ? ' active' : '') + (selIds.has(n.id) ? ' selected' : '') + (n.locked ? ' locked-note' : '');
        el.dataset.id = n.id; el.dataset.idx = i; el.style.animationDelay = (i * 10) + 'ms';
        if (n.color) el.style.borderLeft = `3px solid ${n.color}`;
        el.draggable = curView !== 'bin';
        const pills = tags.slice(0, 2).map(tid => { const t = tagById(tid); return `<span class="ni-tag" style="${tCss(t.color)}">${esc(t.label.slice(0, 8))}</span>`; }).join('');
        const dBadge = n.dailyKey ? '<span class="daily-badge">daily</span> ' : '';
        const pin = n.pinned ? '<span class="ni-pin">ðŸ“Œ</span>' : '';
        const prev = n.content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim().slice(0, 60) || 'Empty note';
        const dragHandle = curView !== 'bin' ? '<span class="ni-drag-handle" title="Drag to reorder">â ¿</span>' : '';
        el.innerHTML = `<input type="checkbox" class="note-sel-cb" ${selIds.has(n.id) ? 'checked' : ''} onclick="handleCbClick(event,'${n.id}')">
      <div class="ni-row1">${dragHandle}<span class="ni-title">${dBadge}${esc(n.title) || 'Untitled Note'}</span>${pin}</div>
      <div class="ni-prev">${esc(prev)}</div>
      <div class="ni-meta"><span class="ni-date">${fd(n.updatedAt)}</span><div class="ni-tags">${pills}</div></div>`;
        const acts = document.createElement('div'); acts.className = 'item-acts';
        if (curView === 'bin') {
          acts.innerHTML = `<button class="item-act restore" onclick="restoreNote('${n.id}',event)" title="Restore">â†©</button><button class="item-act" onclick="permDel('${n.id}',event)" title="Delete forever">âœ•</button>`;
        } else {
          acts.innerHTML = `<button class="item-act dup" onclick="duplicateNote('${n.id}',event)" title="Duplicate">â§‰</button><button class="item-act" onclick="askDel('${n.id}',event)" title="Move to bin">âœ•</button>`;
          el.addEventListener('click', e => { if (e.target.type === 'checkbox' || e.target.classList.contains('item-act') || e.target.classList.contains('ni-drag-handle')) return; if (selMode) { toggleSel(n.id); return; } openNote(n.id); closeMobileSidebar(); removeHoverPreview(); });
          el.addEventListener('mouseenter', e => { if (!selMode && n.id !== activeId) showHoverPreview(e, n); });
          el.addEventListener('mouseleave', () => removeHoverPreview());
          el.addEventListener('dblclick', e => { if (!e.target.classList.contains('item-act') && e.target.type !== 'checkbox') startRename(el, n.id); });
          el.addEventListener('contextmenu', e => { e.preventDefault(); removeHoverPreview(); showCtxMenu(e, n.id); });
          // Drag events
          el.addEventListener('dragstart', e => onDragStart(e, n.id));
          el.addEventListener('dragover', e => onDragOver(e, n.id));
          el.addEventListener('dragleave', e => onDragLeave(e, n.id));
          el.addEventListener('drop', e => onDrop(e, n.id));
          el.addEventListener('dragend', e => onDragEnd(e));
        }
        el.appendChild(acts); list.appendChild(el);
      });
      kbdIdx = -1;
      document.getElementById('notesList').classList.toggle('sel-mode', selMode);
      updateRailStreak();
    }
    function handleCbClick(e, id) { e.stopPropagation(); if (!selMode) enterSelMode(); toggleSel(id); }
    function updateRailStreak() { const s = calcStreak(); const el = document.getElementById('railStreakNum'); if (el) el.textContent = s; }

    /* â•â•â•â•â•â•â•â•â•â•â• SEARCH â•â•â•â•â•â•â•â•â•â•â• */
    function onSearch(v) { document.getElementById('searchClear').classList.toggle('vis', !!v); renderList(v); }
    function clearSearch() { document.getElementById('searchInp').value = ''; document.getElementById('searchClear').classList.remove('vis'); renderList(''); }

    /* â•â•â•â•â•â•â•â•â•â•â• INLINE RENAME â•â•â•â•â•â•â•â•â•â•â• */
    function startRename(el, id) { const n = noteById(id); if (!n) return; const titleEl = el.querySelector('.ni-title'); const old = titleEl.textContent; const inp = document.createElement('input'); inp.className = 'ni-title-edit'; inp.value = n.title || ''; inp.maxLength = 80; titleEl.replaceWith(inp); inp.focus(); inp.select(); const finish = () => { const v = inp.value.trim() || 'Untitled Note'; n.title = v; n.updatedAt = Date.now(); sv('notes'); renderList(); if (activeId === id) { const ti = document.getElementById('titleInp'); if (ti) ti.value = v; } }; inp.addEventListener('blur', finish); inp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); finish(); } if (e.key === 'Escape') { inp.value = old; finish(); } }); inp.addEventListener('click', e => e.stopPropagation()); }

    /* â•â•â•â•â•â•â•â•â•â•â• CONTEXT MENU â•â•â•â•â•â•â•â•â•â•â• */
    function showCtxMenu(e, id) { closeAllDropdowns(); const n = noteById(id); if (!n) return; const dd = document.createElement('div'); dd.className = 'dropdown ctx-menu'; dd.style.cssText = `left:${Math.min(e.clientX, window.innerWidth - 190)}px;top:${Math.min(e.clientY, window.innerHeight - 260)}px`; const items = [['â˜‘ Select', () => { enterSelMode(); toggleSel(id); }], ['âœï¸ Rename', () => { const el = document.querySelector(`.note-item[data-id="${id}"]`); if (el) startRename(el, id); }], ['â§‰ Duplicate', () => duplicateNote(id)], [n.pinned ? 'ðŸ“Œ Unpin' : 'ðŸ“Œ Pin', () => togglePin(id)], [n.locked ? 'ðŸ”“ Unlock' : 'ðŸ”’ Lock', () => toggleLock(id)], ['ðŸªŸ Open in Split', () => openSplitNote(id)], ['separator'], ['ðŸ—‘ Move to Bin', () => moveToBin(id)]]; items.forEach(([lbl, fn]) => { if (lbl === 'separator') { const s = document.createElement('div'); s.className = 'dd-sep'; dd.appendChild(s); return; } const o = document.createElement('div'); o.className = 'dd-item'; o.textContent = lbl; o.onclick = () => { dd.remove(); fn(); }; dd.appendChild(o); }); document.body.appendChild(dd); setTimeout(() => { const h = ev => { if (!dd.contains(ev.target)) { dd.remove(); document.removeEventListener('click', h); } }; document.addEventListener('click', h); }, 10); }

    /* â•â•â•â•â•â•â•â•â•â•â• SPLIT VIEW â•â•â•â•â•â•â•â•â•â•â• */
    function toggleSplitView() {
      splitActive = !splitActive;
      document.getElementById('railSplitBtn')?.classList.toggle('active', splitActive);
      if (splitActive) {
        if (activeId) openSplitNote(activeId);
        else showToast('Open a note first, then enable split view');
      } else {
        closeSplitView();
      }
    }
    function openSplitNote(id) {
      splitActive = true; splitNoteId = id;
      document.getElementById('railSplitBtn')?.classList.add('active');
      renderSplitView();
      showToast('ðŸªŸ Split view opened');
    }
    function closeSplitView() {
      splitActive = false; splitNoteId = null;
      document.getElementById('railSplitBtn')?.classList.remove('active');
      if (activeId) { const n = noteById(activeId); if (n) renderEditor(n); } else showEmpty();
    }
    function renderSplitView() {
      if (!splitNoteId) return;
      const mainN = noteById(activeId); const splitN = noteById(splitNoteId); if (!splitN) return;
      const edArea = document.getElementById('edArea');
      edArea.innerHTML = `<div class="split-view-container" id="splitContainer">
      <div class="split-pane" id="splitPaneLeft" style="flex:1">
        <div class="split-pane-header"><span>${esc(mainN?.title || 'No note selected')}</span></div>
        <div id="splitEditorLeft" style="flex:1;overflow:auto;padding:16px 20px;font-size:14px;line-height:1.8;color:var(--text);font-family:var(--editor-font)">
          ${mainN ? mainN.content : '<p style="color:var(--text3);font-style:italic">Click a note to view it here</p>'}
        </div>
      </div>
      <div class="split-divider" id="splitDivider"></div>
      <div class="split-pane" id="splitPaneRight" style="flex:1">
        <div class="split-pane-header">
          <span>${esc(splitN.title || 'Untitled')}</span>
          <button class="split-close-btn" onclick="closeSplitView()" title="Close split view">âœ• Close split</button>
        </div>
        <div id="splitEditorRight" style="flex:1;overflow:auto;padding:16px 20px;font-size:14px;line-height:1.8;color:var(--text);font-family:var(--editor-font)">
          ${splitN.content || '<p style="color:var(--text3);font-style:italic">Empty note</p>'}
        </div>
      </div>
    </div>`;
      initSplitDivider();
    }
    function initSplitDivider() {
      const divider = document.getElementById('splitDivider'); if (!divider) return;
      let dragging = false, startX2 = 0, leftW = 0;
      divider.addEventListener('mousedown', e => { dragging = true; startX2 = e.clientX; const left = document.getElementById('splitPaneLeft'); leftW = left.offsetWidth; divider.classList.add('dragging'); e.preventDefault(); });
      document.addEventListener('mousemove', e => { if (!dragging) return; const container = document.getElementById('splitContainer'); if (!container) return; const totalW = container.offsetWidth - 4; const newLeft = Math.max(200, Math.min(totalW - 200, leftW + (e.clientX - startX2))); const left = document.getElementById('splitPaneLeft'); const right = document.getElementById('splitPaneRight'); if (left) left.style.flex = 'none', left.style.width = newLeft + 'px'; if (right) right.style.flex = '1'; });
      document.addEventListener('mouseup', () => { dragging = false; divider?.classList.remove('dragging'); });
    }

    /* â•â•â•â•â•â•â•â•â•â•â• EDITOR â•â•â•â•â•â•â•â•â•â•â• */
    function renderEditor(n) {
      if (splitActive && splitNoteId) { renderSplitView(); return; }
      const target = document.getElementById('edArea');
      const fOpts = '<option value="">ðŸ“ No folder</option>' + folders.map(f => `<option value="${f.id}"${n.folder === f.id ? ' selected' : ''}>${f.icon || 'ðŸ“'} ${esc(f.name.slice(0, 14))}</option>`).join('');
      const nc = n.color || 'var(--surface3)'; const isLocked = n.locked || false;
      target.innerHTML = `
    <div class="ed-topbar">
      <input class="title-inp" id="titleInp" placeholder="Untitled Note" value="${esc(n.title)}" oninput="updTitle(this.value)" ${isLocked ? 'readonly' : ''}>
      <div class="topbar-right">
        <select class="folder-select" onchange="changeFolder(this.value)" ${isLocked ? 'disabled' : ''}>${fOpts}</select>
        <div class="tb-div"></div>
        <button class="pin-btn${n.pinned ? ' pinned' : ''}" id="pinBtn" onclick="togglePin()" title="${n.pinned ? 'Unpin' : 'Pin'}">ðŸ“Œ</button>
        <button class="lock-btn${isLocked ? ' locked' : ''}" id="lockBtn" onclick="toggleLock()" title="${isLocked ? 'Unlock note' : 'Lock note'}">${isLocked ? 'ðŸ”’' : 'ðŸ”“'}</button>
        <div class="tp-wrap"><button class="tp-btn" id="tpBtn" onclick="toggleTagPicker(event)"></button></div>
        <div style="position:relative"><div class="note-color-dot" id="noteColorDot" style="background:${nc}" onclick="openNoteColorPicker()" title="Note color"></div></div>
        <div class="tb-div"></div>
        <button class="tb-icon" onclick="openAI()" title="AI Assistant">âœ¨</button>
        <div style="position:relative"><button class="tb-icon" onclick="toggleExpMenu(event)" title="Export">â¬‡</button></div>
        <button class="tb-icon${splitActive ? ' active' : ''}" onclick="toggleSplitView()" title="Split View">âŠŸ</button>
        <div class="tb-div"></div>
        <button class="save-btn" id="saveBtn" onclick="manualSave()">
          <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
          Save
        </button>
      </div>
    </div>
    <div class="locked-banner${isLocked ? ' vis' : ''}" id="lockedBanner">
      <span class="locked-banner-text">ðŸ”’ This note is locked â€” read only</span>
      <button class="locked-banner-btn" onclick="toggleLock()">Unlock</button>
    </div>
    <div class="ed-tabs">
      <button class="ed-tab active" id="tabWrite" onclick="switchTab('write')">âœ Write</button>
      <button class="ed-tab" id="tabCanvas" onclick="switchTab('canvas')">ðŸŽ¨ Canvas</button>
    </div>
    <div id="writePanel" style="display:flex;flex-direction:column;flex:1;overflow:hidden;min-height:0">
      <div class="toolbar-wrap">
        <div class="toolbar" ${isLocked ? 'style="pointer-events:none;opacity:.5"' : ''}>
          <button class="tb-btn" id="tbBold" onclick="fmt('bold')" title="Bold (Alt+B)"><b>B</b></button>
          <button class="tb-btn" id="tbItalic" onclick="fmt('italic')" title="Italic (Alt+I)"><i>I</i></button>
          <button class="tb-btn" id="tbUnderline" onclick="fmt('underline')" title="Underline (Alt+U)"><u>U</u></button>
          <button class="tb-btn" onclick="fmt('strikethrough')" title="Strikethrough"><s>S</s></button>
          <div class="tb-sep"></div>
          <button class="tb-btn" onclick="fb('h1')">H1</button>
          <button class="tb-btn" onclick="fb('h2')">H2</button>
          <button class="tb-btn" onclick="fb('h3')">H3</button>
          <div class="tb-sep"></div>
          <button class="tb-btn" onclick="fmt('insertUnorderedList')">â€¢ List</button>
          <button class="tb-btn" onclick="fmt('insertOrderedList')">1.</button>
          <button class="tb-btn" onclick="insChecklist()">â˜‘</button>
          <button class="tb-btn" id="tbQuote" onclick="toggleBlockquote()"><i>"</i></button>
          <div class="tb-sep"></div>
          <button class="tb-btn" onclick="insHr()">â”€</button>
          <button class="tb-btn" onclick="insCode()">&lt;/&gt;</button>
          <button class="tb-btn" onclick="openTableModal()">âŠž</button>
          <button class="tb-btn" onclick="insImage()">ðŸ–¼</button>
          <button class="tb-btn" onclick="insLink()">ðŸ”—</button>
          <div class="tb-sep tb-overflow-group"></div>
          <select class="fs-sel tb-overflow-group" onchange="applyFontSize(this.value)" title="Font size">
            <option value="">Size</option>
            <option value="12px">12</option><option value="14px">14</option><option value="16px">16</option>
            <option value="18px">18</option><option value="20px">20</option><option value="24px">24</option>
          </select>
          <select class="font-sel tb-overflow-group" onchange="applyEditorFont(this.value)" title="Font family">
            <option value="'DM Sans',sans-serif">Sans</option>
            <option value="'Lora',serif">Serif</option>
            <option value="'Merriweather',serif">Merri</option>
            <option value="'JetBrains Mono',monospace">Mono</option>
          </select>
          <input type="color" class="tb-overflow-group" id="txtColorPick" title="Text color" style="width:24px;height:24px;border:1px solid var(--border);border-radius:6px;padding:2px;background:var(--surface2);cursor:pointer;outline:none" value="#b8e32a" oninput="applyTxtColor(this.value)">
          <div class="tb-sep tb-overflow-group"></div>
          <button class="tb-hist tb-overflow-group" id="undoBtn" onclick="hUndo()" disabled title="Undo">â†©</button>
          <button class="tb-hist tb-overflow-group" id="redoBtn" onclick="hRedo()" disabled title="Redo">â†ª</button>
          <div class="tb-sep"></div>
          <button class="tb-btn" onclick="toggleFind()" title="Find & Replace">ðŸ”</button>
          <button class="tb-btn" onclick="pasteAsPlainText()" title="Paste plain">âŽ˜</button>
          <button class="tb-btn" onclick="toggleFocusMode()" title="Focus Mode">ðŸŽ¯</button>
          <button class="toolbar-more-btn" id="toolbarMoreBtn" onclick="toggleToolbarOverflow()" title="More options">Â·Â·Â·</button>
        </div>
        <div class="toolbar-overflow" id="toolbarOverflow" ${isLocked ? 'style="pointer-events:none;opacity:.5"' : ''}>
          <select class="fs-sel" onchange="applyFontSize(this.value)" title="Font size">
            <option value="">Size</option>
            <option value="12px">12px</option><option value="14px">14px</option><option value="16px">16px</option>
            <option value="18px">18px</option><option value="20px">20px</option><option value="24px">24px</option>
          </select>
          <select class="font-sel" onchange="applyEditorFont(this.value)" title="Font family">
            <option value="'DM Sans',sans-serif">DM Sans</option>
            <option value="'Lora',serif">Lora</option>
            <option value="'Merriweather',serif">Merriweather</option>
            <option value="'JetBrains Mono',monospace">Mono</option>
          </select>
          <input type="color" id="txtColorPick2" title="Text color" style="width:24px;height:24px;border:1px solid var(--border);border-radius:6px;padding:2px;background:var(--surface2);cursor:pointer;outline:none" value="#b8e32a" oninput="applyTxtColor(this.value)">
          <button class="tb-hist" id="undoBtn2" onclick="hUndo()" disabled title="Undo">â†© Undo</button>
          <button class="tb-hist" id="redoBtn2" onclick="hRedo()" disabled title="Redo">â†ª Redo</button>
        </div>
      </div>
      <div class="find-bar" id="findBar">
        <input class="find-inp" id="findInp" placeholder="Findâ€¦" oninput="doFind()" onkeydown="findKey(event)">
        <input class="replace-inp" id="replaceInp" placeholder="Replaceâ€¦">
        <span class="find-count" id="findCount"></span>
        <button class="find-btn" onclick="findPrev()">â†‘</button>
        <button class="find-btn" onclick="findNext()">â†“</button>
        <button class="find-btn" onclick="doReplace()">Replace</button>
        <button class="find-btn" onclick="doReplaceAll()">All</button>
        <button class="find-close" onclick="closeFind()">âœ•</button>
      </div>
      <div class="editor" id="ed" contenteditable="${isLocked ? 'false' : 'true'}" spellcheck="true"
        data-placeholder="Start writing hereâ€¦"
        oninput="onEd()"
        onkeydown="onEdKeyDown(event)"
        ondrop="onDropFile(event)" ondragover="event.preventDefault()"
        onpaste="onEdPaste(event)"
        onkeyup="scrollTypewriter()"
        onclick="handleEditorClick(event)"></div>
      <div class="pomo-bar${pomoCollapsed ? ' collapsed' : ''}" id="pomoBar">
        <span class="pomo-timer" id="pomoTimer">25:00</span>
        <span class="pomo-lbl" id="pomoLbl">Work Session</span>
        <span class="pomo-sessions" id="pomoSessions"></span>
        <div class="pomo-progress"><div class="pomo-fill" id="pomoFill" style="width:100%"></div></div>
        <button class="pomo-btn" id="pomoBtnStart" onclick="pomoToggle()">â–¶ Start</button>
        <button class="pomo-btn" onclick="pomoReset()">â†º</button>
        <button class="pomo-btn" onclick="pomoConfig()">âš™</button>
      </div>
      <div class="ed-footer">
        <div class="footer-left">
          <span id="wcEl">0 words</span>
          <span id="rtEl"></span>
          <span class="wc-goal" id="gcEl" style="display:none" onclick="setWcGoal()"></span>
          <span class="pomo-mini" id="pomoMini" onclick="togglePomoCollapse()" title="Expand timer">â± <span class="pomo-mini-time" id="pomoMiniTime">25:00</span></span>
        </div>
        <div class="footer-settings">
          <button class="footer-icon-btn${typewriterMode ? ' active' : ''}" onclick="toggleTypewriter()" title="Typewriter mode">âŒ¨</button>
          <button class="footer-icon-btn" onclick="openEditorSettings()" title="Editor settings">âš™</button>
          <button class="footer-icon-btn" onclick="togglePomoCollapse()" title="Toggle timer">â±</button>
        </div>
        <div class="footer-dates">
          <span>ðŸ“… ${new Date(n.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
          <span id="updEl">${fd(n.updatedAt)}</span>
        </div>
      </div>
    </div>
    <div id="canvasPanel" style="display:none;flex:1;flex-direction:column;overflow:hidden;min-height:0">
      <div class="canvas-toolbar">
        <button class="ct-btn active" id="ctPen" onclick="setTool('pen')">âœ Pen</button>
        <button class="ct-btn" id="ctEraser" onclick="setTool('eraser')">â¬œ Erase</button>
        <button class="ct-btn" id="ctLine" onclick="setTool('line')">/Line</button>
        <button class="ct-btn" id="ctRect" onclick="setTool('rect')">â–¡</button>
        <button class="ct-btn" id="ctCircle" onclick="setTool('circle')">â—‹</button>
        <div class="tb-sep" style="height:15px"></div>
        ${['#ffffff', '#b8e32a', '#7c5cfc', '#f05252', '#fb923c', '#38bdf8', '#34d399'].map(c => `<div class="ct-color" style="background:${c}" onclick="setCanvasColor('${c}')"></div>`).join('')}
        <input type="color" class="color-native" value="${canvasColor}" oninput="setCanvasColor(this.value)">
        <div class="tb-sep" style="height:15px"></div>
        <select class="ct-size" onchange="setBrushSize(this.value)">
          <option value="2">Fine</option><option value="4" selected>Normal</option><option value="8">Bold</option><option value="16">Thick</option>
        </select>
        <div class="tb-sep" style="height:15px"></div>
        <button class="ct-btn" onclick="clearCanvas()">ðŸ—‘ Clear</button>
        <button class="ct-btn" onclick="downloadCanvas()">â†“ PNG</button>
      </div>
      <div class="canvas-wrap" id="canvasWrap"><canvas id="drawCanvas"></canvas></div>
    </div>`;

      const ed = document.getElementById('ed'); ed.innerHTML = n.content;
      applyEditorSettingsToDOM();
      const fontSel = document.querySelector('.font-sel'); if (fontSel) fontSel.value = editorFontFamily;
      attachChecklistListeners(ed, n.id); attachImageResizeListeners(ed);
      hPush(n.id, n.content); hUpdBtns(); updWC(); refreshTagBtn();
      setTimeout(() => initCanvas(n), 50);
      renderPomoUI(); updateQuoteBtn();
      if (typewriterMode) document.body.classList.add('typewriter-mode');
      else document.body.classList.remove('typewriter-mode');
      updatePomoMini();
    }

    /* â•â•â•â•â•â•â•â•â•â•â• TOOLBAR OVERFLOW (MOBILE) â•â•â•â•â•â•â•â•â•â•â• */
    function toggleToolbarOverflow() { const ov = document.getElementById('toolbarOverflow'); const btn = document.getElementById('toolbarMoreBtn'); if (!ov || !btn) return; const vis = ov.classList.toggle('vis'); btn.classList.toggle('active', vis); }

    /* â•â•â•â•â•â•â•â•â•â•â• IMAGE RESIZE â•â•â•â•â•â•â•â•â•â•â• */
    function handleEditorClick(e) { document.querySelectorAll('.editor img.img-selected').forEach(img => { img.classList.remove('img-selected'); const handle = img.parentElement?.querySelector('.img-resize-handle'); if (handle) handle.remove(); }); if (e.target.tagName === 'IMG') { const img = e.target; img.classList.add('img-selected'); if (!img.parentElement?.classList.contains('img-resize-wrap')) { const wrap = document.createElement('span'); wrap.className = 'img-resize-wrap'; wrap.style.cssText = 'display:inline-block;position:relative;max-width:100%'; img.parentNode.insertBefore(wrap, img); wrap.appendChild(img); } const wrap = img.parentElement; let handle = wrap.querySelector('.img-resize-handle'); if (!handle) { handle = document.createElement('div'); handle.className = 'img-resize-handle'; handle.title = 'Drag to resize'; wrap.appendChild(handle); handle.addEventListener('mousedown', startImgResize); handle.addEventListener('touchstart', startImgResize, { passive: false }); } e.stopPropagation(); } }
    function startImgResize(e) { e.preventDefault(); e.stopPropagation(); const handle = e.currentTarget; const wrap = handle.parentElement; const img = wrap.querySelector('img'); if (!img) return; resizingImg = img; resizeStartX = e.type === 'touchstart' ? e.touches[0].clientX : e.clientX; resizeStartW = img.offsetWidth; const onMove = (ev) => { const cx = ev.type === 'touchmove' ? ev.touches[0].clientX : ev.clientX; const newW = Math.max(50, resizeStartW + (cx - resizeStartX)); img.style.width = newW + 'px'; img.style.maxWidth = '100%'; }; const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); document.removeEventListener('touchmove', onMove); document.removeEventListener('touchend', onUp); onEd(); resizingImg = null; }; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); document.addEventListener('touchmove', onMove, { passive: false }); document.addEventListener('touchend', onUp); }
    function attachImageResizeListeners(ed) { }

    /* â•â•â•â•â•â•â•â•â•â•â• EDITOR SETTINGS â•â•â•â•â•â•â•â•â•â•â• */
    function applyEditorSettingsToDOM() { document.documentElement.style.setProperty('--editor-font', editorFontFamily); document.documentElement.style.setProperty('--editor-max-width', editorLineWidth === 'none' ? 'none' : editorLineWidth + 'ch'); }
    function applyEditorFont(v) { editorFontFamily = v; localStorage.setItem('nf_fontfamily', v); document.documentElement.style.setProperty('--editor-font', v); }
    function openEditorSettings() { const ov = mkOverlay('edSetMod'); ov.innerHTML = `<div class="modal" style="max-width:360px"><div class="modal-stripe stripe-green"></div><div class="modal-icon" style="background:var(--accent-dim);border:1px solid var(--accent-glow)">âš™ï¸</div><h3>Editor Settings</h3><div class="setting-row"><span class="setting-label">Line width</span><select class="setting-select" onchange="setLineWidth(this.value)"><option value="none"${editorLineWidth === 'none' ? ' selected' : ''}>Unlimited</option><option value="65"${editorLineWidth === '65' ? ' selected' : ''}>65 chars</option><option value="75"${editorLineWidth === '75' ? ' selected' : ''}>75 chars</option><option value="100"${editorLineWidth === '100' ? ' selected' : ''}>100 chars</option></select></div><div class="setting-row"><span class="setting-label">Font family</span><select class="setting-select" onchange="applyEditorFont(this.value)"><option value="'DM Sans',sans-serif"${editorFontFamily.includes('DM Sans') ? ' selected' : ''}>DM Sans</option><option value="'Lora',serif"${editorFontFamily.includes('Lora') ? ' selected' : ''}>Lora</option><option value="'Merriweather',serif"${editorFontFamily.includes('Merriweather') ? ' selected' : ''}>Merriweather</option><option value="'JetBrains Mono',monospace"${editorFontFamily.includes('JetBrains') ? ' selected' : ''}>Mono</option></select></div><div class="setting-row"><span class="setting-label">Typewriter mode</span><button class="footer-icon-btn${typewriterMode ? ' active' : ''}" onclick="toggleTypewriter()">${typewriterMode ? 'ON âœ“' : 'OFF'}</button></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('edSetMod')">Close</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('edSetMod'); }); }
    function setLineWidth(v) { editorLineWidth = v; localStorage.setItem('nf_linewidth', v); applyEditorSettingsToDOM(); }

    /* â•â•â•â•â•â•â•â•â•â•â• TYPEWRITER â•â•â•â•â•â•â•â•â•â•â• */
    function toggleTypewriter() { typewriterMode = !typewriterMode; localStorage.setItem('nf_typewriter', typewriterMode ? '1' : ''); document.body.classList.toggle('typewriter-mode', typewriterMode); showToast(typewriterMode ? 'âŒ¨ Typewriter mode on' : 'Typewriter mode off'); }
    function scrollTypewriter() { if (!typewriterMode) return; const sel = window.getSelection(); if (!sel || !sel.rangeCount) return; const node = sel.anchorNode; if (!node) return; const nodeEl = node.nodeType === 3 ? node.parentElement : node; if (nodeEl && nodeEl.scrollIntoView) nodeEl.scrollIntoView({ block: 'center', behavior: 'smooth' }); }

    /* â•â•â•â•â•â•â•â•â•â•â• EDITOR KEYS â•â•â•â•â•â•â•â•â•â•â• */
    function onEdKeyDown(e) {
      const ed = document.getElementById('ed'); if (!ed) return;
      if (e.key === 'ArrowRight' || e.key === 'End') { const sel = window.getSelection(); if (sel && sel.rangeCount) { let node = sel.anchorNode; let offset = sel.anchorOffset; let codeEl = null; let cur = node.nodeType === 3 ? node.parentElement : node; while (cur && cur !== ed) { if (cur.tagName === 'CODE') { codeEl = cur; break; } cur = cur.parentElement; } if (codeEl) { const isAtEnd = (node.nodeType === 3 && offset === node.textContent.length && node === codeEl.lastChild) || (node === codeEl && offset === codeEl.childNodes.length); if (isAtEnd && e.key === 'ArrowRight') { e.preventDefault(); const range = document.createRange(); const afterCode = document.createTextNode('\u200B'); if (codeEl.nextSibling) { range.setStartBefore(codeEl.nextSibling); } else { codeEl.parentNode.appendChild(afterCode); range.setStartAfter(codeEl); } range.collapse(true); sel.removeAllRanges(); sel.addRange(range); return; } } } }
      if (e.key === 'Enter') { const sel = window.getSelection(); if (sel && sel.rangeCount) { let node = sel.anchorNode; let offset = sel.anchorOffset; let cur = node.nodeType === 3 ? node.parentElement : node; let codeEl = null; while (cur && cur !== ed) { if (cur.tagName === 'CODE') { codeEl = cur; break; } cur = cur.parentElement; } if (codeEl) { e.preventDefault(); const p = document.createElement('p'); p.innerHTML = '<br>'; if (codeEl.parentNode.tagName === 'P' || codeEl.parentNode.tagName === 'DIV') { codeEl.parentNode.after(p); } else { codeEl.after(p); } const range = document.createRange(); range.setStart(p, 0); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); onEd(); return; } } }
      if (e.key === ' ' || e.key === 'Enter') { const sel = window.getSelection(); if (!sel || !sel.rangeCount) return; const range = sel.getRangeAt(0); let node = range.startContainer; if (node.nodeType !== 3) return; let inCode = false; let cur = node.parentElement; while (cur && cur !== ed) { if (cur.tagName === 'CODE' || cur.tagName === 'PRE') { inCode = true; break; } cur = cur.parentElement; } if (inCode) return; const text = node.textContent.slice(0, range.startOffset); const mdCheck = (pattern, action) => { const m = text.match(pattern); if (m) { const r2 = range.cloneRange(); r2.setStart(node, 0); r2.setEnd(node, m[0].length); r2.deleteContents(); action(); e.preventDefault(); return true; } return false; }; if (e.key === ' ') { if (mdCheck(/^#{1,3}\s?$/, () => { const level = text.trim().length; document.execCommand('formatBlock', false, 'h' + level); })) return; if (mdCheck(/^>/, () => document.execCommand('formatBlock', false, 'blockquote'))) return; if (mdCheck(/^-\s?$/, () => document.execCommand('insertUnorderedList'))) return; if (mdCheck(/^\d+\.\s?$/, () => document.execCommand('insertOrderedList'))) return; if (mdCheck(/^\[\]\s?$/, () => insChecklist())) return; } }
      if (e.key === 'Tab') { e.preventDefault(); if (e.shiftKey) document.execCommand('outdent'); else document.execCommand('indent'); onEd(); return; }
      if (e.key === 'Enter') { const sel = window.getSelection(); if (!sel || !sel.rangeCount) return; let node = sel.anchorNode; while (node && node !== ed) { if (node.classList && node.classList.contains('cl-item')) { e.preventDefault(); const textContent = node.querySelector('.cl-text')?.textContent?.trim(); if (!textContent) { node.remove(); document.execCommand('insertParagraph'); } else { const newLi = document.createElement('li'); newLi.className = 'cl-item'; const cb = document.createElement('input'); cb.type = 'checkbox'; const span = document.createElement('span'); span.className = 'cl-text'; span.contentEditable = 'true'; span.textContent = ' '; newLi.appendChild(cb); newLi.appendChild(span); node.after(newLi); cb.addEventListener('change', clChange); const r = document.createRange(); const s = window.getSelection(); r.setStart(span, 1); r.collapse(true); s.removeAllRanges(); s.addRange(r); } onEd(); return; } node = node.parentNode; } }
    }

    /* â•â•â•â•â•â•â•â•â•â•â• PASTE â•â•â•â•â•â•â•â•â•â•â• */
    function onEdPaste(e) { }
    function pasteAsPlainText() { navigator.clipboard.readText().then(text => { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand('insertText', false, text); onEd(); showToast('âœ“ Pasted as plain text'); }).catch(() => { showToast('âš ï¸ Clipboard access denied'); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• LOCK â•â•â•â•â•â•â•â•â•â•â• */
    function toggleLock(noteId) { const id = noteId || activeId; const n = noteById(id); if (!n) return; n.locked = !n.locked; n.updatedAt = Date.now(); sv('notes'); if (id === activeId) openNote(id); else renderList(); showToast(n.locked ? 'ðŸ”’ Note locked' : 'ðŸ”“ Note unlocked'); }

    /* â•â•â•â•â•â•â•â•â•â•â• CHECKLIST â•â•â•â•â•â•â•â•â•â•â• */
    function insChecklist() { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); const html = `<ul class="cl-list"><li class="cl-item"><input type="checkbox"><span class="cl-text" contenteditable="true"> Task</span></li></ul>`; document.execCommand('insertHTML', false, html); setTimeout(() => { ed.querySelectorAll('.cl-item input[type=checkbox]').forEach(cb => { cb.addEventListener('change', clChange); }); onEd(); }, 10); }
    function clChange(e) { const li = e.target.closest('.cl-item'); if (!li) return; li.classList.toggle('done', e.target.checked); onEd(); }
    function attachChecklistListeners(ed, noteId) { ed.querySelectorAll('.cl-item input[type=checkbox]').forEach(cb => { cb.addEventListener('change', clChange); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• BLOCKQUOTE â•â•â•â•â•â•â•â•â•â•â• */
    function toggleBlockquote() { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); const sel = window.getSelection(); if (!sel || !sel.rangeCount) return; let node = sel.anchorNode; let inBq = false; while (node && node !== ed) { if (node.tagName === 'BLOCKQUOTE') { inBq = true; break; } node = node.parentNode; } if (inBq) { const bq = node; const frag = document.createDocumentFragment(); while (bq.firstChild) frag.appendChild(bq.firstChild); bq.parentNode.replaceChild(frag, bq); } else { document.execCommand('formatBlock', false, 'blockquote'); } onEd(); setTimeout(updateQuoteBtn, 10); }
    function updateQuoteBtn() { const ed = document.getElementById('ed'); const btn = document.getElementById('tbQuote'); if (!btn || !ed) return; const sel = window.getSelection(); let inBq = false; if (sel && sel.rangeCount) { let node = sel.anchorNode; while (node && node !== ed) { if (node.tagName === 'BLOCKQUOTE') { inBq = true; break; } node = node.parentNode; } } btn.classList.toggle('toggled', inBq); }

    /* â•â•â•â•â•â•â•â•â•â•â• TABLE â•â•â•â•â•â•â•â•â•â•â• */
    function openTableModal() { const ov = mkOverlay('tableMod'); ov.innerHTML = `<div class="modal" style="max-width:320px"><div class="modal-stripe stripe-blue"></div><div class="modal-icon" style="background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25)">âŠž</div><h3>Insert Table</h3><div class="num-row"><div class="num-group"><span class="num-lbl">Rows</span><input class="num-inp" id="tblRows" type="number" value="3" min="1" max="20"></div><div class="num-group"><span class="num-lbl">Cols</span><input class="num-inp" id="tblCols" type="number" value="3" min="1" max="10"></div></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('tableMod')">Cancel</button><button class="btn-accent" onclick="doInsertTable()">Insert</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('tableMod'); }); setTimeout(() => document.getElementById('tblRows')?.focus(), 60); }
    function doInsertTable() { const r = Math.max(1, parseInt(document.getElementById('tblRows')?.value) || 3); const c = Math.max(1, parseInt(document.getElementById('tblCols')?.value) || 3); let thCells = ''; for (let i = 0; i < c; i++)thCells += `<th contenteditable="true">Col ${i + 1}</th>`; const thead = `<thead><tr>${thCells}</tr></thead>`; let tbRows = ''; for (let row = 0; row < r; row++) { let tdCells = ''; for (let col = 0; col < c; col++)tdCells += `<td contenteditable="true">&nbsp;</td>`; tbRows += `<tr>${tdCells}</tr>`; } const tbody = `<tbody>${tbRows}</tbody>`; closeModal('tableMod'); const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); const table = document.createElement('table'); table.innerHTML = thead + tbody; const sel = window.getSelection(); if (sel && sel.rangeCount) { const range = sel.getRangeAt(0); range.collapse(false); const br = document.createElement('p'); br.innerHTML = '<br>'; range.insertNode(br); br.after(table); const afterP = document.createElement('p'); afterP.innerHTML = '<br>'; table.after(afterP); const newRange = document.createRange(); newRange.setStart(afterP, 0); newRange.collapse(true); sel.removeAllRanges(); sel.addRange(newRange); } else { ed.appendChild(table); } onEd(); showToast(`âœ“ Table ${r}Ã—${c} inserted`); }

    /* â•â•â•â•â•â•â•â•â•â•â• EDITOR OPS â•â•â•â•â•â•â•â•â•â•â• */
    function updTitle(v) { const n = noteById(activeId); if (!n) return; n.title = v; n.updatedAt = Date.now(); scheduleSave(); document.querySelectorAll(`.note-item[data-id="${activeId}"] .ni-title`).forEach(t => t.textContent = v || 'Untitled Note'); }
    function onEd() { const ed = document.getElementById('ed'), n = noteById(activeId); if (!ed || !n) return; if (n.locked) return; n.content = ed.innerHTML; n.updatedAt = Date.now(); hPush(activeId, ed.innerHTML); document.querySelectorAll(`.note-item[data-id="${activeId}"] .ni-prev`).forEach(p => p.textContent = ed.innerText.replace(/\s+/g, ' ').trim().slice(0, 60) || 'Empty note'); updWC(); scheduleSave(); setTimeout(updateQuoteBtn, 10); checkMilestones(); }
    function updWC() { const ed = document.getElementById('ed'); if (!ed) return; const c = wc(ed.innerHTML); const we = document.getElementById('wcEl'), re = document.getElementById('rtEl'), ge = document.getElementById('gcEl'); if (we) we.textContent = c + ' word' + (c !== 1 ? 's' : ''); if (re) re.textContent = rt(c); if (ge && wcGoal) { const p = Math.min(100, Math.round(c / wcGoal * 100)); ge.textContent = `${c}/${wcGoal} (${p}%)`; ge.style.display = 'inline'; ge.className = 'wc-goal' + (p >= 100 ? ' done' : p >= 80 ? ' near' : ''); } else if (ge) ge.style.display = 'none'; }
    function setWcGoal() { openInputModal('Word Count Goal', 'Target word count (0 = off):', 'number', wcGoal, val => { wcGoal = Math.max(0, parseInt(val) || 0); localStorage.setItem('nf_wcgoal', wcGoal); updWC(); showToast('âœ“ Goal set'); }); }
    let saveTimer2 = null;
    function scheduleSave() { clearTimeout(saveTimer2); const b = document.getElementById('saveBtn'); if (b) { b.classList.remove('saved'); b.innerHTML = `<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> â€¦`; } saveTimer2 = setTimeout(() => { sv('notes'); setSaved(); }, 900); }
    function setSaved() { const b = document.getElementById('saveBtn'); if (b) { b.classList.add('saved'); b.innerHTML = `<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg> Saved`; setTimeout(() => { b.classList.remove('saved'); b.innerHTML = `<svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Save`; }, 2200); } const u = document.getElementById('updEl'); if (u) u.textContent = 'just now'; }
    function manualSave() { clearTimeout(saveTimer2); sv('notes'); setSaved(); showToast('âœ“ Saved'); }
    function fmt(c) { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand(c, false, null); onEd(); }
    function fb(t) { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand('formatBlock', false, t); onEd(); }
    function applyFontSize(v) { if (!v) return; const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); const sel = window.getSelection(); if (sel && sel.rangeCount && !sel.isCollapsed) { const range = sel.getRangeAt(0); const span = document.createElement('span'); span.style.fontSize = v; try { range.surroundContents(span); } catch (e) { document.execCommand('insertHTML', false, `<span style="font-size:${v}">${sel.toString()}</span>`); } onEd(); } else { showToast('Select text first'); } }
    function applyTxtColor(v) { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand('foreColor', false, v); onEd(); }
    function insHr() { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand('insertHTML', false, '<hr><p><br></p>'); onEd(); }
    function insCode() { const ed = document.getElementById('ed'); if (!ed) return; const sel = window.getSelection(); const t = (sel && !sel.isCollapsed) ? sel.toString() : 'code'; ed.focus(); document.execCommand('insertHTML', false, `<code>${esc(t)}</code>&#8203;`); onEd(); }
    function insLink() { openInputModal('Insert Link', 'URL:', 'text', 'https://', url => { if (!url || url === 'https://') return; const text = window.getSelection()?.toString() || url; const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand('insertHTML', false, `<a href="${esc(url)}" target="_blank">${esc(text)}</a>`); onEd(); }); }
    function insImage() { const inp = document.createElement('input'); inp.type = 'file'; inp.accept = 'image/*'; inp.onchange = e => { const f = e.target.files[0]; if (!f) return; const r = new FileReader(); r.onload = ev => { const ed = document.getElementById('ed'); if (!ed) return; ed.focus(); document.execCommand('insertHTML', false, `<img src="${ev.target.result}" alt="${esc(f.name)}" style="max-width:100%">`); onEd(); }; r.readAsDataURL(f); }; inp.click(); }
    function onDropFile(e) { e.preventDefault();[...e.dataTransfer.files].filter(f => f.type.startsWith('image/')).forEach(f => { const r = new FileReader(); r.onload = ev => { document.execCommand('insertHTML', false, `<img src="${ev.target.result}" alt="${esc(f.name)}">`); onEd(); }; r.readAsDataURL(f); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• TABS â•â•â•â•â•â•â•â•â•â•â• */
    function switchTab(t) { document.getElementById('tabWrite')?.classList.toggle('active', t === 'write'); document.getElementById('tabCanvas')?.classList.toggle('active', t === 'canvas'); document.getElementById('writePanel').style.display = t === 'write' ? 'flex' : 'none'; document.getElementById('canvasPanel').style.display = t === 'canvas' ? 'flex' : 'none'; if (t === 'canvas') { setTimeout(() => { const n = noteById(activeId); resizeCanvas(); if (n && n.canvasData) reloadCanvas(n); }, 30); } if (t === 'canvas') { ['pen', 'eraser', 'line', 'rect', 'circle'].forEach(x => document.getElementById('ct' + x.charAt(0).toUpperCase() + x.slice(1))?.classList.toggle('active', x === drawTool)); } }

    /* â•â•â•â•â•â•â•â•â•â•â• PIN â•â•â•â•â•â•â•â•â•â•â• */
    function togglePin(noteId) { const id = noteId || activeId; const n = noteById(id); if (!n) return; n.pinned = !n.pinned; n.updatedAt = Date.now(); sv('notes'); if (id === activeId) document.getElementById('pinBtn')?.classList.toggle('pinned', n.pinned); showToast(n.pinned ? 'ðŸ“Œ Pinned' : 'Unpinned'); renderList(); }

    /* â•â•â•â•â•â•â•â•â•â•â• TAG PICKER â•â•â•â•â•â•â•â•â•â•â• */
    function refreshTagBtn() { const btn = document.getElementById('tpBtn'), n = noteById(activeId); if (!btn || !n) return; const tags = n.tags || ['misc']; const pills = tags.slice(0, 2).map(tid => { const t = tagById(tid); return `<span class="tp-tag-pill" style="${tCss(t.color)}">${esc(t.label.slice(0, 9))}</span>`; }).join(''); const more = tags.length > 2 ? `<span style="color:var(--text3);font-size:10px">+${tags.length - 2}</span>` : ''; btn.innerHTML = pills + more + '<svg width="8" height="8" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24" style="margin-left:2px;opacity:.45"><polyline points="6 9 12 15 18 9"/></svg>'; }
    function toggleTagPicker(e) { e && e.stopPropagation(); closeAllDropdowns(); const btn = document.getElementById('tpBtn'); if (!btn) return; btn.classList.add('open'); const n = noteById(activeId); const cur = n?.tags || ['misc']; const dd = document.createElement('div'); dd.className = 'dropdown tp-drop'; allTags().forEach(t => { const sel = cur.includes(t.id); const o = document.createElement('div'); o.className = 'dd-item' + (sel ? ' sel' : ''); o.innerHTML = `<span class="dd-dot" style="background:${t.color}"></span>${esc(t.label)}<span class="dd-check">âœ“</span>`; o.onclick = ev => { ev.stopPropagation(); if (!n) return; if (cur.includes(t.id)) { n.tags = cur.filter(x => x !== t.id); if (!n.tags.length) n.tags = ['misc']; } else n.tags = [...cur, t.id]; n.updatedAt = Date.now(); sv('notes'); refreshTagBtn(); renderList(); dd.remove(); btn.classList.remove('open'); toggleTagPicker({ stopPropagation: () => { } }); }; dd.appendChild(o); }); const sep = document.createElement('div'); sep.className = 'dd-sep'; dd.appendChild(sep); const nw = document.createElement('div'); nw.className = 'dd-new'; nw.innerHTML = '<svg width="10" height="10" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> New tagâ€¦'; nw.onclick = ev => { ev.stopPropagation(); dd.remove(); btn.classList.remove('open'); openTagModal(); }; dd.appendChild(nw); btn.parentElement.appendChild(dd); setTimeout(() => { const h = ev => { if (!dd.contains(ev.target) && ev.target !== btn) { dd.remove(); btn.classList.remove('open'); document.removeEventListener('click', h); } }; document.addEventListener('click', h); }, 10); }
    function changeFolder(fid) { const n = noteById(activeId); if (!n) return; n.folder = fid || null; n.updatedAt = Date.now(); sv('notes'); renderList(); }

 function openNoteColorPicker() {
      closeAllDropdowns(); const n = noteById(activeId); if (!n) return;
      const dot = document.getElementById('noteColorDot'); if (!dot) return;
      const dd = document.createElement('div'); dd.className = 'dropdown'; dd.style.cssText = 'top:calc(100% + 6px);right:0;min-width:160px';
      dd.innerHTML = `<div style="padding:6px 9px 2px;font-family:Syne,sans-serif;font-size:9px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3)">Note Color</div>
      <div class="note-color-swatches" style="padding:6px 9px 8px">${NOTE_COLORS.map(c => `<div class="nc-sw${(n.color || '') === c ? ' sel' : ''}" style="background:${c || 'var(--surface3)'};${!c ? 'border:1px dashed var(--border2)' : ''}" onclick="setNoteColor('${c}')" title="${c || 'None'}"></div>`).join('')}</div>`;
      dot.parentElement.appendChild(dd);
      setTimeout(() => { const h = ev => { if (!dd.contains(ev.target) && ev.target !== dot) { dd.remove(); document.removeEventListener('click', h); } }; document.addEventListener('click', h); }, 10);
    }
    function setNoteColor(c) { const n = noteById(activeId); if (!n) return; n.color = c; n.updatedAt = Date.now(); sv('notes'); closeAllDropdowns(); renderList(); const dot = document.getElementById('noteColorDot'); if (dot) dot.style.background = c || 'var(--surface3)'; showToast('âœ“ Color updated'); }

    /* â•â•â•â•â•â•â•â•â•â•â• EXPORT â•â•â•â•â•â•â•â•â•â•â• */
    function toggleExpMenu(e) { e && e.stopPropagation(); closeAllDropdowns(); const btn = e.currentTarget; const dd = document.createElement('div'); dd.className = 'dropdown exp-drop';[['ðŸ“„ PDF', expPDF], ['ðŸ“ Word (.doc)', expWord], ['â¬‡ Markdown', expMD], ['ðŸ“ƒ Plain Text', expTXT]].forEach(([lbl, fn]) => { const o = document.createElement('div'); o.className = 'dd-item'; o.textContent = lbl; o.onclick = ev => { ev.stopPropagation(); dd.remove(); fn(); }; dd.appendChild(o); }); btn.parentElement.appendChild(dd); setTimeout(() => { const h = ev => { if (!dd.contains(ev.target)) { dd.remove(); document.removeEventListener('click', h); } }; document.addEventListener('click', h); }, 10); }

    /* â•â•â•â•â•â•â•â•â•â•â• UNDO/REDO â•â•â•â•â•â•â•â•â•â•â• */
    const HM = {}; let HP = false;
    function hGet(id) { if (!HM[id]) HM[id] = { s: [], p: -1 }; return HM[id]; }
    function hPush(id, html) { if (HP) return; const h = hGet(id); h.s = h.s.slice(0, h.p + 1); if (h.s[h.p] === html) return; h.s.push(html); if (h.s.length > 80) h.s.shift(); h.p = h.s.length - 1; hUpdBtns(); }
    function hUndo() { const h = hGet(activeId); if (h.p <= 0) return; h.p--; hApply(h.s[h.p]); }
    function hRedo() { const h = hGet(activeId); if (h.p >= h.s.length - 1) return; h.p++; hApply(h.s[h.p]); }
    function hApply(html) { const ed = document.getElementById('ed'), n = noteById(activeId); if (!ed || !n) return; HP = true; ed.innerHTML = html; n.content = html; n.updatedAt = Date.now(); sv('notes'); updWC(); hUpdBtns(); HP = false; attachChecklistListeners(ed, activeId); }
    function hUpdBtns() { const h = hGet(activeId);['undoBtn', 'undoBtn2'].forEach(id => { const u = document.getElementById(id); if (u) u.disabled = h.p <= 0; });['redoBtn', 'redoBtn2'].forEach(id => { const r = document.getElementById(id); if (r) r.disabled = h.p >= h.s.length - 1; }); }

    /* â•â•â•â•â•â•â•â•â•â•â• FIND & REPLACE â•â•â•â•â•â•â•â•â•â•â• */
    function toggleFind() { const bar = document.getElementById('findBar'); if (!bar) return; const vis = bar.classList.toggle('vis'); if (vis) document.getElementById('findInp')?.focus(); else closeFind(); }
    function closeFind() { const bar = document.getElementById('findBar'); if (!bar) return; bar.classList.remove('vis'); clearFindHL(); findMatches = []; findIdx = 0; const c = document.getElementById('findCount'); if (c) c.textContent = ''; }
    function clearFindHL() { const ed = document.getElementById('ed'); if (!ed) return; ed.querySelectorAll('mark.hlfnd').forEach(m => { const p = m.parentNode; p.replaceChild(document.createTextNode(m.textContent), m); p.normalize(); }); }
    function doFind() { clearFindHL(); findMatches = []; findIdx = 0; const q = document.getElementById('findInp')?.value; const cnt = document.getElementById('findCount'); if (!q) { if (cnt) cnt.textContent = ''; return; } const ed = document.getElementById('ed'); if (!ed) return; const walker = document.createTreeWalker(ed, NodeFilter.SHOW_TEXT, { acceptNode: n => n.textContent.toLowerCase().includes(q.toLowerCase()) ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_SKIP }); const nodes = []; let node; while (node = walker.nextNode()) nodes.push(node); nodes.forEach(tn => { const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi'); const frag = document.createDocumentFragment(); let last = 0, m; while ((m = re.exec(tn.textContent)) !== null) { if (m.index > last) frag.appendChild(document.createTextNode(tn.textContent.slice(last, m.index))); const mark = document.createElement('mark'); mark.className = 'hlfnd'; mark.textContent = m[0]; findMatches.push(mark); frag.appendChild(mark); last = re.lastIndex; } if (last < tn.textContent.length) frag.appendChild(document.createTextNode(tn.textContent.slice(last))); tn.parentNode.replaceChild(frag, tn); }); if (cnt) cnt.textContent = findMatches.length ? `${findIdx + 1}/${findMatches.length}` : '0 found'; if (findMatches.length) { findIdx = 0; hlCurrent(); } }
    function hlCurrent() { findMatches.forEach((m, i) => m.classList.toggle('active', i === findIdx)); findMatches[findIdx]?.scrollIntoView({ block: 'nearest' }); const cnt = document.getElementById('findCount'); if (cnt && findMatches.length) cnt.textContent = `${findIdx + 1}/${findMatches.length}`; }
    function findNext() { if (!findMatches.length) return; findIdx = (findIdx + 1) % findMatches.length; hlCurrent(); }
    function findPrev() { if (!findMatches.length) return; findIdx = (findIdx - 1 + findMatches.length) % findMatches.length; hlCurrent(); }
    function findKey(e) { if (e.key === 'Enter') { e.shiftKey ? findPrev() : findNext(); } if (e.key === 'Escape') closeFind(); }
    function doReplace() { if (!findMatches.length) return; const rv = document.getElementById('replaceInp')?.value || ''; const m = findMatches[findIdx]; if (!m) return; m.parentNode.replaceChild(document.createTextNode(rv), m); findMatches.splice(findIdx, 1); onEd(); doFind(); }
    function doReplaceAll() { if (!findMatches.length) return; const rv = document.getElementById('replaceInp')?.value || '';[...findMatches].forEach(m => m.parentNode.replaceChild(document.createTextNode(rv), m)); findMatches = []; onEd(); doFind(); showToast('âœ“ Replaced all'); }

    /* â•â•â•â•â•â•â•â•â•â•â• DELETE/BIN â•â•â•â•â•â•â•â•â•â•â• */
    function askDel(id, e) { e && e.stopPropagation(); const n = noteById(id); if (!n) return; showConfirm(e.target, `Move "${(n.title || 'Untitled').slice(0, 22)}" to bin?`, 'Move', () => moveToBin(id)); }
    function moveToBin(id) { const n = notes.find(x => x.id === id); if (!n) return; notes = notes.filter(x => x.id !== id); noteOrder = noteOrder.filter(oid => oid !== id); bin.unshift({ ...n, deletedAt: Date.now() }); sv('notes'); sv('bin'); sv('order'); if (activeId === id) { activeId = null; showEmpty(); } renderList(); showToast('ðŸ—‘ Moved to bin'); }
    function restoreNote(id, e) { e && e.stopPropagation(); const n = bin.find(x => x.id === id); if (!n) return; bin = bin.filter(x => x.id !== id); notes.unshift({ ...n, updatedAt: Date.now() }); noteOrder.unshift(id); delete notes[0].deletedAt; sv('notes'); sv('bin'); sv('order'); renderList(); showToast('â†© Restored'); }
    function permDel(id, e) { e && e.stopPropagation(); showConfirm(e.target, 'Permanently delete? Cannot be undone.', 'Delete', () => { bin = bin.filter(x => x.id !== id); sv('bin'); renderList(); showToast('Deleted permanently'); }); }
    function emptyBin() { showConfirm(document.querySelector('.bin-empty-btn') || document.body, 'Permanently delete ALL notes in bin?', 'Empty', () => { bin = []; sv('bin'); renderList(); showToast('ðŸ—‘ Bin emptied'); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• CANVAS â•â•â•â•â•â•â•â•â•â•â• */
    function initCanvas(n) { const c = document.getElementById('drawCanvas'); if (!c) return; resizeCanvas(); reloadCanvas(n); }
    function reloadCanvas(n) { if (!n?.canvasData) return; const c = document.getElementById('drawCanvas'); if (!c) return; const img = new Image(); img.onload = () => c.getContext('2d').drawImage(img, 0, 0); img.src = n.canvasData; }
    function resizeCanvas() { const c = document.getElementById('drawCanvas'); if (!c) return; const w = document.getElementById('canvasWrap'); if (!w) return; const ctx = c.getContext('2d'); let old = null; try { if (c.width > 0 && c.height > 0) old = c.toDataURL(); } catch (e) { } c.width = w.clientWidth; c.height = w.clientHeight; ctx.fillStyle = currentTheme !== 'dark' ? '#fafafa' : '#0d0d11'; ctx.fillRect(0, 0, c.width, c.height); if (old) { const img = new Image(); img.onload = () => ctx.drawImage(img, 0, 0); img.src = old; } bindCanvas(c); }
    function bindCanvas(c) { c.onpointerdown = e => { e.preventDefault(); isDrawing = true; c.setPointerCapture(e.pointerId); const { x, y } = gPos(c, e); startX = x; startY = y; const ctx = c.getContext('2d'); snapshot = ctx.getImageData(0, 0, c.width, c.height); ctx.beginPath(); ctx.moveTo(x, y); }; c.onpointermove = e => { if (!isDrawing) return; e.preventDefault(); const { x, y } = gPos(c, e); const ctx = c.getContext('2d'); if (drawTool === 'pen' || drawTool === 'eraser') { ctx.globalCompositeOperation = drawTool === 'eraser' ? 'destination-out' : 'source-over'; ctx.lineWidth = drawTool === 'eraser' ? brushSize * 3 : brushSize; ctx.strokeStyle = canvasColor; ctx.lineCap = 'round'; ctx.lineTo(x, y); ctx.stroke(); ctx.beginPath(); ctx.moveTo(x, y); } else { ctx.putImageData(snapshot, 0, 0); drawShape(ctx, x, y); } }; c.onpointerup = e => { if (!isDrawing) return; isDrawing = false; const { x, y } = gPos(c, e); const ctx = c.getContext('2d'); if (drawTool !== 'pen' && drawTool !== 'eraser') drawShape(ctx, x, y); ctx.globalCompositeOperation = 'source-over'; saveCanvas(); }; }
    function gPos(c, e) { const r = c.getBoundingClientRect(); return { x: (e.clientX - r.left) * (c.width / r.width), y: (e.clientY - r.top) * (c.height / r.height) }; }
    function drawShape(ctx, ex, ey) { ctx.strokeStyle = canvasColor; ctx.lineWidth = brushSize; ctx.lineCap = 'round'; ctx.globalCompositeOperation = 'source-over'; if (drawTool === 'line') { ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(ex, ey); ctx.stroke(); } else if (drawTool === 'rect') { ctx.beginPath(); ctx.strokeRect(startX, startY, ex - startX, ey - startY); } else if (drawTool === 'circle') { ctx.beginPath(); const rx = (ex - startX) / 2, ry = (ey - startY) / 2; ctx.ellipse(startX + rx, startY + ry, Math.abs(rx), Math.abs(ry), 0, 0, Math.PI * 2); ctx.stroke(); } }
    function saveCanvas() { const c = document.getElementById('drawCanvas'); if (!c) return; const n = noteById(activeId); if (!n) return; n.canvasData = c.toDataURL(); sv('notes'); }
    function setTool(t) { drawTool = t;['Pen', 'Eraser', 'Line', 'Rect', 'Circle'].forEach(x => document.getElementById('ct' + x)?.classList.toggle('active', x.toLowerCase() === t)); }
    function setCanvasColor(c) { canvasColor = c; }
    function setBrushSize(v) { brushSize = parseInt(v); }
    function clearCanvas() { const c = document.getElementById('drawCanvas'); if (!c) return; const ctx = c.getContext('2d'); ctx.fillStyle = currentTheme !== 'dark' ? '#fafafa' : '#0d0d11'; ctx.fillRect(0, 0, c.width, c.height); const n = noteById(activeId); if (n) { n.canvasData = ''; sv('notes'); } }
    function downloadCanvas() { const c = document.getElementById('drawCanvas'); if (!c) return; const n = noteById(activeId); const a = document.createElement('a'); a.download = (n?.title || 'canvas') + '.png'; a.href = c.toDataURL(); a.click(); showToast('âœ“ Canvas saved'); }
    window.addEventListener('resize', () => { if (document.getElementById('drawCanvas')) resizeCanvas(); });

    /* â•â•â•â•â•â•â•â•â•â•â• FOCUS MODE â•â•â•â•â•â•â•â•â•â•â• */
    function toggleFocusMode() { focusMode = !focusMode; document.body.classList.toggle('focus-mode', focusMode); }

    /* â•â•â•â•â•â•â•â•â•â•â• POMODORO â•â•â•â•â•â•â•â•â•â•â• */
    function togglePomoCollapse() { pomoCollapsed = !pomoCollapsed; localStorage.setItem('nf_pomo_collapsed', pomoCollapsed ? 'true' : ''); const bar = document.getElementById('pomoBar'); if (bar) bar.classList.toggle('collapsed', pomoCollapsed); updatePomoMini(); }
    function updatePomoMini() { const mini = document.getElementById('pomoMini'); if (!mini) return; mini.classList.toggle('vis', pomoCollapsed); }
    function renderPomoUI() { const t = document.getElementById('pomoTimer'), l = document.getElementById('pomoLbl'), f = document.getElementById('pomoFill'), b = document.getElementById('pomoBtnStart'), sess = document.getElementById('pomoSessions'); if (!t) return; const m = Math.floor(pomoState.secs / 60), s = pomoState.secs % 60, total = (pomoState.mode === 'work' ? pomoState.workMins : pomoState.breakMins) * 60; const timeStr = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; t.textContent = timeStr; t.className = 'pomo-timer' + (pomoState.mode === 'break' ? ' break' : pomoState.secs < 60 ? ' danger' : ''); if (l) l.textContent = pomoState.mode === 'work' ? `Work (${pomoState.workMins}m)` : `Break (${pomoState.breakMins}m)`; if (sess) sess.textContent = pomoState.sessions > 0 ? `Â· ${pomoState.sessions}ðŸ…` : ''; if (f) { f.style.width = (pomoState.secs / total * 100) + '%'; f.className = 'pomo-fill' + (pomoState.mode === 'break' ? ' break' : ''); } if (b) { b.className = 'pomo-btn' + (pomoState.running ? ' running' : ''); b.textContent = pomoState.running ? 'â¸ Pause' : 'â–¶ Start'; } const mt = document.getElementById('pomoMiniTime'); if (mt) mt.textContent = timeStr; const bar = document.getElementById('pomoBar'); if (bar) bar.classList.toggle('collapsed', pomoCollapsed); updatePomoMini(); }
    function pomoToggle() { pomoState.running = !pomoState.running; if (pomoState.running) { pomoState.interval = setInterval(() => { pomoState.secs--; if (pomoState.secs <= 0) { clearInterval(pomoState.interval); pomoState.running = false; if (pomoState.mode === 'work') { pomoState.sessions++; pomoState.mode = 'break'; pomoState.secs = pomoState.breakMins * 60; showToast('â˜• Break time! Session #' + pomoState.sessions); } else { pomoState.mode = 'work'; pomoState.secs = pomoState.workMins * 60; showToast('ðŸ’ª Back to work!'); } renderPomoUI(); return; } renderPomoUI(); }, 1000); } else clearInterval(pomoState.interval); renderPomoUI(); }
    function pomoReset() { clearInterval(pomoState.interval); pomoState.running = false; pomoState.secs = (pomoState.mode === 'work' ? pomoState.workMins : pomoState.breakMins) * 60; renderPomoUI(); }
    function pomoConfig() { const ov = mkOverlay('pomoCfgMod'); ov.innerHTML = `<div class="modal" style="max-width:320px"><div class="modal-stripe stripe-orange"></div><div class="modal-icon" style="background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.25)">â±</div><h3>Pomodoro Settings</h3><div class="pomo-cfg-row"><span class="pomo-cfg-lbl">Work (minutes)</span><input class="pomo-num" id="cfgWork" type="number" value="${pomoState.workMins}" min="1" max="120"></div><div class="pomo-cfg-row"><span class="pomo-cfg-lbl">Break (minutes)</span><input class="pomo-num" id="cfgBreak" type="number" value="${pomoState.breakMins}" min="1" max="60"></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('pomoCfgMod')">Cancel</button><button class="btn-accent" onclick="savePomoCfg()">Save</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('pomoCfgMod'); }); setTimeout(() => document.getElementById('cfgWork')?.focus(), 60); }
    function savePomoCfg() { const w = parseInt(document.getElementById('cfgWork')?.value), b = parseInt(document.getElementById('cfgBreak')?.value); if (w > 0) pomoState.workMins = w; if (b > 0) pomoState.breakMins = b; closeModal('pomoCfgMod'); pomoReset(); showToast('â± Pomodoro updated'); }

    /* â•â•â•â•â•â•â•â•â•â•â• GENERIC INPUT MODAL â•â•â•â•â•â•â•â•â•â•â• */
    function openInputModal(title, label, type, current, onOk) { const ov = mkOverlay('inputMod'); ov.innerHTML = `<div class="modal" style="max-width:320px"><div class="modal-stripe stripe-green"></div><h3>${esc(title)}</h3><label class="f-label">${esc(label)}</label><input class="f-inp" id="inputModVal" type="${type}" value="${esc(String(current))}" placeholder=""><div class="m-actions"><button class="btn-cancel" onclick="closeModal('inputMod')">Cancel</button><button class="btn-accent" onclick="submitInputModal()">OK</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('inputMod'); }); window._inputCb = onOk; setTimeout(() => { const i = document.getElementById('inputModVal'); if (i) { i.focus(); i.select(); } }, 60); document.getElementById('inputMod').querySelector('.f-inp').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); submitInputModal(); } }); }
    function submitInputModal() { const val = document.getElementById('inputModVal')?.value; closeModal('inputMod'); if (window._inputCb) window._inputCb(val); }

    /* â•â•â•â•â•â•â•â•â•â•â• EXPORT FUNCTIONS â•â•â•â•â•â•â•â•â•â•â• */
    function expPDF() { const n = noteById(activeId); if (!n) return; const w = window.open('', '_blank'); if (!w) return; w.document.write(`<!DOCTYPE html><html><head><title>${esc(n.title || 'Note')}</title><link href="https://fonts.googleapis.com/css2?family=Syne:wght@700&family=DM+Sans:wght@300;400&display=swap" rel="stylesheet"><style>body{font-family:'DM Sans',sans-serif;max-width:720px;margin:50px auto;color:#111;line-height:1.8;font-size:14px;padding:0 20px}h1,h2,h3{font-family:'Syne',sans-serif}blockquote{border-left:3px solid #888;padding-left:14px;color:#555}code{background:#f0f0f0;padding:2px 5px;border-radius:4px;font-family:monospace}img{max-width:100%;border-radius:6px}table{border-collapse:collapse;width:100%}td,th{border:1px solid #ccc;padding:6px 10px}@media print{body{margin:0}}</style></head><body><h1>${esc(n.title) || 'Untitled'}</h1><p style="color:#888;font-size:11px;margin-bottom:20px">${new Date(n.updatedAt).toLocaleString()}</p>${n.content}</body></html>`); w.document.close(); setTimeout(() => w.print(), 500); showToast('âœ“ PDF ready'); }
    function expWord() { const n = noteById(activeId); if (!n) return; const t = n.title || 'Untitled'; const h = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:w="urn:schemas-microsoft-com:office:word" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset="utf-8"><title>${esc(t)}</title></head><body><h1>${esc(t)}</h1>${n.content}</body></html>`; const blob = new Blob(['\ufeff' + h], { type: 'application/msword' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = t + '.doc'; a.click(); URL.revokeObjectURL(url); showToast('âœ“ Word doc downloaded'); }
    function expMD() { const n = noteById(activeId); if (!n) return; const div = document.createElement('div'); div.innerHTML = n.content; function toMd(node) { let t = ''; node.childNodes.forEach(ch => { if (ch.nodeType === 3) { t += ch.textContent; } else if (ch.tagName) { const tag = ch.tagName.toLowerCase(), inner = toMd(ch); if (tag === 'h1') t += `\n# ${inner}\n`; else if (tag === 'h2') t += `\n## ${inner}\n`; else if (tag === 'h3') t += `\n### ${inner}\n`; else if (tag === 'b' || tag === 'strong') t += `**${inner}**`; else if (tag === 'i' || tag === 'em') t += `*${inner}*`; else if (tag === 'code') t += `\`${inner}\``; else if (tag === 'blockquote') t += `\n> ${inner.trim()}\n`; else if (tag === 'li') t += `- ${inner}\n`; else if (tag === 'ul' || tag === 'ol') t += `\n${inner}`; else if (tag === 'hr') t += '\n---\n'; else if (tag === 'br') t += '\n'; else if (tag === 'img') t += `\n![img](${ch.src})\n`; else if (tag === 'p') t += `\n${inner}\n`; else t += inner; } }); return t; } const md = `# ${n.title || 'Untitled'}\n\n` + toMd(div); const blob = new Blob([md], { type: 'text/markdown' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (n.title || 'note') + '.md'; a.click(); URL.revokeObjectURL(url); showToast('âœ“ Markdown exported'); }
    function expTXT() { const n = noteById(activeId); if (!n) return; const div = document.createElement('div'); div.innerHTML = n.content; const txt = (n.title || 'Untitled') + '\n' + 'â”€'.repeat(38) + '\n\n' + div.innerText; const blob = new Blob([txt], { type: 'text/plain' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = (n.title || 'note') + '.txt'; a.click(); URL.revokeObjectURL(url); showToast('âœ“ Text exported'); }

    /* â•â•â•â•â•â•â•â•â•â•â• TEMPLATES â•â•â•â•â•â•â•â•â•â•â• */
    const BUILT_TEMPLATES = [
      { icon: 'ðŸ“‹', name: 'Meeting Notes', desc: 'Agenda, attendees, actions', content: '<h2>Meeting Notes</h2><p><strong>Date:</strong> ' + new Date().toLocaleDateString() + '<br><strong>Attendees:</strong> </p><h3>Agenda</h3><ul><li>Item 1</li></ul><h3>Action Items</h3><ul><li></li></ul>' },
      { icon: 'ðŸ““', name: 'Daily Journal', desc: 'Mood, gratitude, reflection', content: '<h2>ðŸ““ ' + new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' }) + '</h2><h3>How I feel</h3><p></p><h3>3 things grateful for</h3><ul><li></li><li></li><li></li></ul><h3>Goals today</h3><ul><li></li></ul><h3>Reflection</h3><p></p>' },
      { icon: 'âœ…', name: 'Todo List', desc: 'Tasks with checkboxes', content: '<h2>âœ… Tasks</h2><ul class="cl-list"><li class="cl-item"><input type="checkbox"><span class="cl-text" contenteditable="true"> Task 1</span></li><li class="cl-item"><input type="checkbox"><span class="cl-text" contenteditable="true"> Task 2</span></li></ul>' },
      { icon: 'ðŸš€', name: 'Project Brief', desc: 'Goals, scope, timeline', content: '<h2>ðŸš€ Project Brief</h2><h3>Overview</h3><p></p><h3>Goals</h3><ul><li></li></ul><h3>Timeline</h3><ul><li><strong>Start:</strong> </li><li><strong>End:</strong> </li></ul>' },
      { icon: 'ðŸ“Š', name: 'Weekly Review', desc: 'Wins, challenges, next week', content: '<h2>ðŸ“Š Weekly Review</h2><h3>ðŸ† Wins</h3><ul><li></li></ul><h3>ðŸ˜¤ Challenges</h3><ul><li></li></ul><h3>ðŸŽ¯ Next Week</h3><ul><li></li></ul>' },
      { icon: 'ðŸ’¡', name: 'Idea Capture', desc: 'Problem, solution, next steps', content: '<h2>ðŸ’¡ Idea</h2><h3>Problem</h3><p></p><h3>Solution</h3><p></p><h3>Next Steps</h3><ul><li></li></ul>' },
      { icon: 'ðŸ“–', name: 'Book Notes', desc: 'Summary, quotes, takeaways', content: '<h2>ðŸ“– Book Notes</h2><p><strong>Title:</strong> <br><strong>Author:</strong> </p><h3>Summary</h3><p></p><h3>Key Ideas</h3><ul><li></li></ul><h3>Quotes</h3><blockquote></blockquote>' },
      { icon: 'ðŸŽ¯', name: 'Goal Setting', desc: 'SMART goals framework', content: '<h2>ðŸŽ¯ Goal</h2><p></p><ul><li><strong>Specific:</strong> </li><li><strong>Measurable:</strong> </li><li><strong>Achievable:</strong> </li><li><strong>Relevant:</strong> </li><li><strong>Time-bound:</strong> </li></ul><h3>Action Plan</h3><ul><li></li></ul>' },
    ];
    function openTemplates() { const ov = mkOverlay('tmplMod'); const customCards = customTemplates.map((t, i) => `<div class="tmpl-card custom-tmpl" onclick="useCustomTemplate(${i})"><button class="tmpl-del" onclick="delCustomTemplate(${i},event)" title="Delete">âœ•</button><div class="tmpl-icon">${t.icon || 'ðŸ“'}</div><div class="tmpl-name">${esc(t.name)}</div><div class="tmpl-desc">${esc(t.desc || 'Custom template')}</div></div>`).join(''); const builtCards = BUILT_TEMPLATES.map((t, i) => `<div class="tmpl-card" onclick="useBuiltTemplate(${i})"><div class="tmpl-icon">${t.icon}</div><div class="tmpl-name">${t.name}</div><div class="tmpl-desc">${t.desc}</div></div>`).join(''); ov.innerHTML = `<div class="modal" style="max-width:490px"><div class="modal-stripe stripe-green"></div><div class="modal-icon" style="background:var(--accent-dim);border:1px solid var(--accent-glow)">ðŸ“‹</div><h3>Templates</h3><p class="subtitle">Start with a pre-built structure.</p>${customTemplates.length ? `<div style="font-family:Syne,sans-serif;font-size:9.5px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-top:12px;margin-bottom:4px">â­ Custom</div><div class="tmpl-grid" style="max-height:200px">${customCards}</div><div style="font-family:Syne,sans-serif;font-size:9.5px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--text3);margin-top:12px;margin-bottom:4px">Built-in</div>` : ''}<div class="tmpl-grid">${builtCards}</div><div class="m-actions" style="margin-top:10px"><button class="btn-cancel" onclick="closeModal('tmplMod')">Cancel</button><button class="btn-purple" onclick="openCreateCustomTemplate()">ï¼‹ Create Template</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('tmplMod'); }); }
    function openCreateCustomTemplate() {
      closeModal('tmplMod'); const currentContent = noteById(activeId)?.content || ''; const icons = ['ðŸ“', 'ðŸ“‹', 'ðŸ““', 'âœ…', 'ðŸš€', 'ðŸ’¡', 'ðŸ“Š', 'ðŸ“–', 'ðŸŽ¯', 'ðŸ”¬', 'ðŸ’¼', 'ðŸŒ¿', 'â¤ï¸', 'â­', 'ðŸŽ¨', 'ðŸ”§']; let selIcon = 'ðŸ“'; const ov = mkOverlay('ctmplMod'); ov.innerHTML = `<div class="modal" style="max-width:480px"><div class="modal-stripe stripe-purple"></div><div class="modal-icon" style="background:var(--accent2-dim);border:1px solid rgba(124,92,252,.3)">ðŸ“</div><h3>Create Custom Template</h3><label class="f-label">Template Name</label><input class="f-inp" id="ctName" maxlength="40" placeholder="e.g. Sprint Planningâ€¦"><label class="f-label">Description</label><input class="f-inp" id="ctDesc" maxlength="60" placeholder="Short description"><label class="f-label">Icon</label><div class="icons-grid" id="ctIconGrid">${icons.map(ic => `<span class="icon-opt${ic === selIcon ? ' sel' : ''}" onclick="pickCTIcon('${ic}',this)">${ic}</span>`).join('')}</div><label class="f-label">Content (HTML)</label><textarea class="f-textarea" id="ctContent" placeholder="<h2>Title</h2>..."></textarea><div class="m-actions"><button class="btn-cancel" onclick="closeModal('ctmplMod');openTemplates()">â† Back</button>${activeId ? `<button class="btn-cancel" onclick="useCurrentNoteAsTemplate()" style="flex:0;padding:10px 14px;white-space:nowrap">Use Current Note</button>` : ''}
<button class="btn-purple" onclick="saveCustomTemplate()">Save Template</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) { closeModal('ctmplMod'); } }); setTimeout(() => document.getElementById('ctName')?.focus(), 60);
    }
    let selCTIcon = 'ðŸ“';
    function pickCTIcon(ic, el) { selCTIcon = ic; document.querySelectorAll('#ctIconGrid .icon-opt').forEach(s => s.classList.remove('sel')); if (el) el.classList.add('sel'); }
    function useCurrentNoteAsTemplate() { const n = noteById(activeId); if (!n) return; const ta = document.getElementById('ctContent'); if (ta) ta.value = n.content; showToast('âœ“ Content loaded'); }
    function saveCustomTemplate() { const name = document.getElementById('ctName')?.value.trim(); if (!name) { showToast('âš ï¸ Enter a template name'); return; } let content = document.getElementById('ctContent')?.value.trim(); if (!content && activeId) content = noteById(activeId)?.content || '<p></p>'; if (!content) content = '<h2>' + esc(name) + '</h2><p></p>'; customTemplates.push({ id: 'ct_' + Date.now(), name: name.slice(0, 40), desc: document.getElementById('ctDesc')?.value.trim().slice(0, 60) || '', icon: selCTIcon, content }); sv('ctemplates'); closeModal('ctmplMod'); showToast('âœ“ Template "' + name + '" saved!'); fireConfetti(); openTemplates(); }
    function useBuiltTemplate(i) { closeModal('tmplMod'); const t = BUILT_TEMPLATES[i]; const n = { id: Date.now().toString(), title: t.name, content: t.content, canvasData: '', tags: ['misc'], pinned: false, locked: false, color: '', folder: activeFolder || null, createdAt: Date.now(), updatedAt: Date.now() }; notes.unshift(n); noteOrder.unshift(n.id); sv('notes'); sv('order'); renderList(); openNote(n.id); showToast('âœ“ Template applied'); }
    function useCustomTemplate(i) { closeModal('tmplMod'); const t = customTemplates[i]; if (!t) return; const n = { id: Date.now().toString(), title: t.name, content: t.content, canvasData: '', tags: ['misc'], pinned: false, locked: false, color: '', folder: activeFolder || null, createdAt: Date.now(), updatedAt: Date.now() }; notes.unshift(n); noteOrder.unshift(n.id); sv('notes'); sv('order'); renderList(); openNote(n.id); showToast('âœ“ Custom template applied'); attachChecklistListeners(document.getElementById('ed'), n.id); }
    function delCustomTemplate(i, e) { e && e.stopPropagation(); customTemplates.splice(i, 1); sv('ctemplates'); showToast('Template deleted'); closeModal('tmplMod'); openTemplates(); }

    /* â•â•â•â•â•â•â•â•â•â•â• DAILY NOTE â•â•â•â•â•â•â•â•â•â•â• */
    function openDailyNote() { const key = todayKey(); let n = notes.find(x => x.dailyKey === key); if (!n) { n = { id: Date.now().toString(), title: 'ðŸ“… ' + todayStr(), content: '<h2>ðŸ“… ' + todayStr() + '</h2><h3>Intentions</h3><p></p><h3>Notes</h3><p></p><h3>Reflection</h3><p></p>', canvasData: '', tags: ['personal'], pinned: false, locked: false, color: '', createdAt: Date.now(), updatedAt: Date.now(), dailyKey: key }; notes.unshift(n); noteOrder.unshift(n.id); sv('notes'); sv('order'); renderList(); } openNote(n.id); showToast('ðŸ“… Daily note'); closeMobileSidebar(); }

    /* â•â•â•â•â•â•â•â•â•â•â• STATS â•â•â•â•â•â•â•â•â•â•â• */
    function calcStreak() { const DAY = 864e5; const days = new Set(notes.map(n => Math.floor(n.updatedAt / DAY))); let streak = 0, cur = Math.floor(Date.now() / DAY); while (days.has(cur) || days.has(cur - 1)) { if (days.has(cur)) streak++; cur--; } return streak; }
    function openStats() { const tw = notes.reduce((s, n) => s + wc(n.content), 0); const tc = notes.reduce((s, n) => s + n.content.replace(/<[^>]*>/g, '').length, 0); const DAY = 864e5, now = Date.now(), am = {}; notes.forEach(n => { const d = Math.floor(n.updatedAt / DAY); am[d] = (am[d] || 0) + 1; }); const dateLabels = {}; for (let i = 0; i < 30; i++) { const d = new Date(now - (29 - i) * DAY); dateLabels[Math.floor((now - (29 - i) * DAY) / DAY)] = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } const cells = Array.from({ length: 30 }, (_, i) => { const d = Math.floor((now - (29 - i) * DAY) / DAY); const c = am[d] || 0; const l = c === 0 ? '' : c === 1 ? 'l1' : c <= 3 ? 'l2' : c <= 5 ? 'l3' : 'l4'; return `<div class="hm-cell ${l}" title="${dateLabels[d]}: ${c} update${c !== 1 ? 's' : ''}"></div>`; }).join(''); const streak = calcStreak(); const ov = mkOverlay('statsMod'); ov.innerHTML = `<div class="modal" style="max-width:380px"><div class="modal-stripe stripe-blue"></div><div class="modal-icon" style="background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25)">ðŸ“Š</div><h3>Writing Stats</h3><div class="stats-grid"><div class="stat-card"><div class="stat-num">${notes.length}</div><div class="stat-lbl">Notes</div></div><div class="stat-card"><div class="stat-num">${tw.toLocaleString()}</div><div class="stat-lbl">Words</div></div><div class="stat-card"><div class="stat-num">${notes.filter(n => n.pinned).length}</div><div class="stat-lbl">Pinned</div></div><div class="stat-card"><div class="stat-num">${cTags.length}</div><div class="stat-lbl">Custom Tags</div></div><div class="stat-card"><div class="stat-num">${(tc / 1000).toFixed(1)}k</div><div class="stat-lbl">Chars</div></div></div><div class="heatmap"><div class="heatmap-title">30-Day Activity</div><div class="heatmap-grid">${cells}</div><div class="streak-row">ðŸ”¥ <span class="streak-num">${streak}</span> day writing streak</div></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('statsMod')">Close</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('statsMod'); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• IMPORT â•â•â•â•â•â•â•â•â•â•â• */
    function openImport() { const ov = mkOverlay('importMod'); ov.innerHTML = `<div class="modal"><div class="modal-stripe stripe-blue"></div><div class="modal-icon" style="background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25)">ðŸ“¥</div><h3>Import Notes</h3><p class="subtitle">Import .md or .txt files as notes.</p><div class="import-drop" id="importDrop" onclick="document.getElementById('importFileInp').click()"><div style="font-size:28px">ðŸ“‚</div><p>Click or drag & drop files here</p><input type="file" id="importFileInp" accept=".md,.txt,.markdown" multiple style="display:none" onchange="handleImport(this.files)"></div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('importMod')">Cancel</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('importMod'); }); const drop = document.getElementById('importDrop'); drop.addEventListener('dragover', e => { e.preventDefault(); drop.classList.add('drag'); }); drop.addEventListener('dragleave', () => drop.classList.remove('drag')); drop.addEventListener('drop', e => { e.preventDefault(); drop.classList.remove('drag'); handleImport(e.dataTransfer.files); }); }
    function handleImport(files) { let cnt = 0; const total = files.length; Array.from(files).forEach(f => { const r = new FileReader(); r.onload = ev => { const content = ev.target.result; const lines = content.split('\n'); let title = f.name.replace(/\.(md|txt|markdown)$/, ''); if (lines[0].startsWith('# ')) title = lines[0].slice(2).trim(); const html = mdToHtml(content); const n = { id: Date.now().toString() + Math.random().toString(36).slice(2), title, content: html, canvasData: '', tags: ['misc'], pinned: false, locked: false, color: '', folder: activeFolder || null, createdAt: Date.now(), updatedAt: Date.now() }; notes.unshift(n); noteOrder.unshift(n.id); cnt++; if (cnt === total) { sv('notes'); sv('order'); renderList(); closeModal('importMod'); showToast(`âœ“ Imported ${cnt} note${cnt > 1 ? 's' : ''}`); checkMilestones(); } }; r.readAsText(f); }); }
    function mdToHtml(md) { return md.replace(/^### (.*)/gm, '<h3>$1</h3>').replace(/^## (.*)/gm, '<h2>$1</h2>').replace(/^# (.*)/gm, '<h1>$1</h1>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>').replace(/`(.*?)`/g, '<code>$1</code>').replace(/^- (.*)/gm, '<li>$1</li>').replace(/^> (.*)/gm, '<blockquote>$1</blockquote>').replace(/^---$/gm, '<hr>').replace(/\n\n+/g, '</p><p>').replace(/^/, '<p>').replace(/$/, '</p>'); }

    /* â•â•â•â•â•â•â•â•â•â•â• SHORTCUTS â•â•â•â•â•â•â•â•â•â•â• */
    const SHORTS = [['New Note', 'Ctrl+N'], ['Save', 'Alt+S'], ['Daily Note', 'Alt+D'], ['Find', 'Alt+F'], ['Bold', 'Alt+B'], ['Italic', 'Alt+I'], ['Underline', 'Alt+U'], ['Blockquote', 'Alt+Q'], ['Focus Mode', 'Alt+Z'], ['Undo', 'Ctrl+Z'], ['Redo', 'Ctrl+Y'], ['Typewriter', 'Alt+T'], ['Split View', 'Alt+W'], ['Context Menu', 'Right-click'], ['Rename', 'Double-click']];
    function openShortcuts() { const ov = mkOverlay('shortMod'); ov.innerHTML = `<div class="modal" style="max-width:450px"><div class="modal-stripe stripe-pink"></div><div class="modal-icon" style="background:rgba(217,70,239,.1);border:1px solid rgba(217,70,239,.25)">âŒ¨ï¸</div><h3>Keyboard Shortcuts</h3><div class="shortcuts-grid">${SHORTS.map(([a, k]) => `<div class="sc-row"><span class="sc-action">${a}</span><span class="sc-keys">${k.split('+').map(p => `<span class="sc-key">${p.trim()}</span>`).join('<span style="color:var(--text3);font-size:9px;padding:0 1px">+</span>')}</span></div>`).join('')}</div><div class="m-actions"><button class="btn-cancel" onclick="closeModal('shortMod')">Close</button></div></div>`; document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('shortMod'); }); }

    /* â•â•â•â•â•â•â•â•â•â•â• AI (with setup flow) â•â•â•â•â•â•â•â•â•â•â• */
    let aiMode = 'summarize', lastAI = '';
    function openAI() {
      const n = noteById(activeId); if (!n) return; closeAllDropdowns();
      const ov = mkOverlay('aiMod');
      const keySetup = !aiApiKey ? `
      <div class="ai-setup-banner">
        <strong>âœ¨ AI Assistant Setup</strong><br>
        This feature uses the <strong>Anthropic Claude API</strong>. You need a free API key to get started.
        <br><br>
        1. Go to <a href="https://console.anthropic.com" target="_blank" style="color:var(--accent2)">console.anthropic.com</a><br>
        2. Create an account and generate an API key<br>
        3. Paste it below â€” it's stored locally in your browser only
        <div class="ai-key-row">
          <input class="ai-key-inp" id="aiKeyInp" type="password" placeholder="sk-ant-api03-â€¦" value="${esc(aiApiKey)}">
          <button class="ai-key-btn" onclick="saveAiKey()">Save Key</button>
        </div>
      </div>` :
        `<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding:8px 10px;background:var(--accent-dim);border:1px solid var(--accent-glow);border-radius:8px">
        <span style="font-size:11px;color:var(--accent)">âœ“ API key set</span>
        <button class="ai-key-clear" onclick="clearAiKey()" style="margin-left:auto">Change key</button>
      </div>`;
      ov.innerHTML = `<div class="modal" style="max-width:470px"><div class="modal-stripe stripe-green"></div><div class="modal-icon" style="background:var(--accent-dim);border:1px solid var(--accent-glow);font-size:18px">âœ¨</div><h3>AI Writing Assistant</h3>
    ${keySetup}
    <div class="ai-mode-btns">
      <button class="ai-mode-btn active" id="aim-summarize" onclick="setAIM('summarize')">ðŸ“ Summarize</button>
      <button class="ai-mode-btn" id="aim-continue" onclick="setAIM('continue')">âœ Continue</button>
      <button class="ai-mode-btn" id="aim-title" onclick="setAIM('title')">ðŸ· Auto-Title</button>
      <button class="ai-mode-btn" id="aim-improve" onclick="setAIM('improve')">âœ¨ Improve</button>
      <button class="ai-mode-btn" id="aim-bullets" onclick="setAIM('bullets')">â€¢ Key Points</button>
      <button class="ai-mode-btn" id="aim-custom" onclick="setAIM('custom')">ðŸ’¬ Custom</button>
    </div>
    <div id="aiCustRow" style="display:none;margin-bottom:6px"><input class="f-inp" id="aiCustInp" placeholder="Ask anything about this noteâ€¦" style="margin-top:6px"></div>
    <div class="ai-result" id="aiRes"><span style="color:var(--text3);font-style:italic;font-size:12.5px">${aiApiKey ? 'Click â–¶ Run to generateâ€¦' : 'Add your API key above to get started'}</span></div>
    <div class="m-actions"><button class="btn-cancel" onclick="closeModal('aiMod')">Close</button><button class="btn-accent" id="aiRunBtn" onclick="runAI()" ${!aiApiKey ? 'disabled' : ''}>â–¶ Run</button><button class="btn-purple" id="aiApplyBtn" onclick="applyAI()" style="display:none">âœ“ Apply to Note</button></div></div>`;
      document.body.appendChild(ov); ov.addEventListener('click', e => { if (e.target === ov) closeModal('aiMod'); }); aiMode = 'summarize'; lastAI = '';
    }
    function saveAiKey() { const val = document.getElementById('aiKeyInp')?.value.trim(); if (!val) { showToast('âš ï¸ Please enter an API key'); return; } aiApiKey = val; localStorage.setItem('nf_ai_key', val); showToast('âœ“ API key saved'); closeModal('aiMod'); openAI(); }
    function clearAiKey() { aiApiKey = ''; localStorage.removeItem('nf_ai_key'); closeModal('aiMod'); openAI(); }
    function setAIM(m) { aiMode = m; document.querySelectorAll('.ai-mode-btn').forEach(b => b.classList.remove('active')); document.getElementById('aim-' + m)?.classList.add('active'); document.getElementById('aiCustRow').style.display = m === 'custom' ? 'block' : 'none'; document.getElementById('aiApplyBtn').style.display = 'none'; document.getElementById('aiRes').innerHTML = '<span style="color:var(--text3);font-style:italic;font-size:12.5px">Click â–¶ Run to generateâ€¦</span>'; }
    async function runAI() {
      if (!aiApiKey) { showToast('âš ï¸ Please add your API key first'); return; }
      const n = noteById(activeId); if (!n) { showToast('âš ï¸ No note selected'); return; }
      const btn = document.getElementById('aiRunBtn'); btn.disabled = true; btn.textContent = 'Runningâ€¦';
      document.getElementById('aiRes').innerHTML = '<span class="ai-loading" style="color:var(--text3)">Thinking</span>';
      document.getElementById('aiApplyBtn').style.display = 'none';
      const pt = n.content.replace(/<[^>]*>/g, ' ').replace(/\s+/g, ' ').trim().slice(0, 3000);
      const prompts = { summarize: `Summarize this note in 3-5 concise sentences.\n\nTitle: "${n.title}"\n\nContent:\n${pt}`, continue: `Continue this note naturally with 2-3 paragraphs in the same style and tone.\n\nTitle: "${n.title}"\n\nContent:\n${pt}`, title: `Suggest 5 creative, concise titles for this note. Format as a numbered list.\n\nContent:\n${pt}`, improve: `Rewrite this note to be clearer, more concise, and more engaging. Keep the same meaning.\n\nTitle: "${n.title}"\n\nContent:\n${pt}`, bullets: `Extract the 5-8 most important key points from this note as bullet points.\n\nContent:\n${pt}`, custom: (document.getElementById('aiCustInp')?.value?.trim() || 'Summarize this note.') + '\n\nNote title: "' + n.title + '"\n\nNote content:\n' + pt };
      try {
        const res = await fetch('https://api.anthropic.com/v1/messages', { method: 'POST', headers: { 'Content-Type': 'application/json', 'x-api-key': aiApiKey, 'anthropic-version': '2023-06-01', 'anthropic-dangerous-direct-browser-access': 'true' }, body: JSON.stringify({ model: 'claude-haiku-4-5-20251001', max_tokens: 1000, messages: [{ role: 'user', content: prompts[aiMode] || prompts.summarize }] }) });
        if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.error?.message || `HTTP ${res.status}`); }
        const data = await res.json();
        const text = data.content?.filter(b => b.type === 'text').map(b => b.text).join('') || 'No response generated.';
        lastAI = text; document.getElementById('aiRes').textContent = text;
        if (aiMode === 'continue' || aiMode === 'improve') { document.getElementById('aiApplyBtn').style.display = 'flex'; }
      } catch (err) {
        document.getElementById('aiRes').innerHTML = `<span style="color:var(--danger)">${esc(err.message)}</span>`;
        showToast('âš ï¸ AI error: ' + err.message.slice(0, 50));
      }
      btn.disabled = false; btn.textContent = 'â–¶ Run';
    }
    function applyAI() { const n = noteById(activeId); if (!n || !lastAI) return; const escaped = lastAI.replace(/\n\n/g, '</p><p>').replace(/\n/g, '<br>'); if (aiMode === 'continue') n.content += `<hr><p>${escaped}</p>`; else if (aiMode === 'improve') n.content = `<p>${escaped}</p>`; n.updatedAt = Date.now(); sv('notes'); const ed = document.getElementById('ed'); if (ed) ed.innerHTML = n.content; attachChecklistListeners(ed, activeId); updWC(); closeModal('aiMod'); showToast('âœ“ AI result applied'); }


    /* â•â•â•â•â•â•â•â•â•â•â• MODAL/TOAST/CONFIRM â•â•â•â•â•â•â•â•â•â•â• */
    function mkOverlay(id) { document.getElementById(id)?.remove(); const ov = document.createElement('div'); ov.className = 'overlay'; ov.id = id; return ov; }
    function closeModal(id) { const el = document.getElementById(id); if (!el) return; el.classList.add('hiding'); setTimeout(() => el.remove(), 155); }
    function showToast(msg) { document.querySelector('.toast')?.remove(); const t = document.createElement('div'); t.className = 'toast'; t.textContent = msg; document.body.appendChild(t); setTimeout(() => { t.classList.add('hide'); setTimeout(() => t.remove(), 240); }, 2400); }
    function showConfirm(anchor, msg, okLbl, onOk) {
      closeAllDropdowns();
      const p = document.createElement('div'); p.className = 'confirm-popup';
      const rect = (anchor && anchor.getBoundingClientRect) ? anchor.getBoundingClientRect() : { bottom: 80, left: 20, top: 60 };
      p.style.cssText = `top:${Math.min(rect.bottom + 6, window.innerHeight - 130)}px;left:${Math.max(4, Math.min(rect.left, window.innerWidth - 230))}px`;
      p.innerHTML = `<div class="confirm-msg">${esc(msg)}</div><div class="confirm-btns"><button class="confirm-cancel" onclick="this.closest('.confirm-popup').remove()">Cancel</button><button class="confirm-ok" id="cfmOk">${esc(okLbl)}</button></div>`;
      document.body.appendChild(p);
      p.querySelector('#cfmOk').onclick = () => { onOk(); p.remove(); };
      setTimeout(() => { const h = ev => { if (!p.contains(ev.target)) { p.remove(); document.removeEventListener('click', h); } }; document.addEventListener('click', h); }, 10);
    }

    /* â•â•â•â•â•â•â•â•â•â•â• KEYBOARD NAV â•â•â•â•â•â•â•â•â•â•â• */
    document.getElementById('notesList').addEventListener('keydown', e => {
      const items = document.querySelectorAll('.note-item'); if (!items.length) return;
      if (e.key === 'ArrowDown') { e.preventDefault(); kbdIdx = Math.min(kbdIdx + 1, items.length - 1); }
      else if (e.key === 'ArrowUp') { e.preventDefault(); kbdIdx = Math.max(kbdIdx - 1, 0); }
      else if (e.key === 'Enter' && kbdIdx >= 0) { items[kbdIdx]?.click(); return; }
      items.forEach((el, i) => el.classList.toggle('kbd-focus', i === kbdIdx));
      items[kbdIdx]?.scrollIntoView({ block: 'nearest' });
    });

    /* â•â•â•â•â•â•â•â•â•â•â• GLOBAL KEYBOARD SHORTCUTS â•â•â•â•â•â•â•â•â•â•â• */
    document.addEventListener('keydown', e => {
      const mod = e.ctrlKey || e.metaKey; const alt = e.altKey;
      if (e.key === 'Escape') { closeAllDropdowns(); document.querySelectorAll('.overlay').forEach(o => closeModal(o.id)); closeFind(); if (selMode) exitSelMode(); return; }
      if (e.key === '?' && !mod && !alt && !document.activeElement.matches('input,textarea,[contenteditable]')) { openShortcuts(); return; }
      if (alt && !mod) {
        switch (e.key.toLowerCase()) {
          case 's': e.preventDefault(); if (activeId) manualSave(); break;
          case 'd': e.preventDefault(); openDailyNote(); break;
          case 'f': e.preventDefault(); if (activeId) toggleFind(); break;
          case 'z': e.preventDefault(); if (activeId) toggleFocusMode(); break;
          case 't': e.preventDefault(); toggleTypewriter(); break;
        }
      }
      const ed = document.getElementById('ed');
      const edFocused = ed && (document.activeElement === ed || ed.contains(document.activeElement));
      if (edFocused) {
        if (mod && !alt && e.key.toLowerCase() === 'z') { e.preventDefault(); hUndo(); return; }
        if (mod && !alt && e.key.toLowerCase() === 'y') { e.preventDefault(); hRedo(); return; }
        if (alt && !mod) {
          switch (e.key.toLowerCase()) {
            case 'b': e.preventDefault(); fmt('bold'); break;
            case 'i': e.preventDefault(); fmt('italic'); break;
            case 'u': e.preventDefault(); fmt('underline'); break;
            case 'q': e.preventDefault(); toggleBlockquote(); break;
          }
        }
      }
      if (mod && !alt && e.key.toLowerCase() === 'z' && activeId && !edFocused) { e.preventDefault(); hUndo(); }
      if (mod && !alt && e.key.toLowerCase() === 'y' && activeId && !edFocused) { e.preventDefault(); hRedo(); }
    });

    /* â•â•â•â•â•â•â•â•â•â•â• INIT â•â•â•â•â•â•â•â•â•â•â• */
    typewriterMode = localStorage.getItem('nf_typewriter') === '1';
    if (typewriterMode) document.body.classList.add('typewriter-mode');
    applyEditorSettingsToDOM();

    notes.forEach(n => {
      if (!n.tags) { n.tags = n.tag ? [n.tag] : ['misc']; delete n.tag; }
      if (!('color' in n)) n.color = '';
      if (!('locked' in n)) n.locked = false;
    });
    sv('notes');
    renderTags(); renderTagFilterStrip(); renderFolders(); renderList();
    updateRailStreak();

    if (!notes.length) {
      notes = [
        { id: '1', title: 'Welcome to Noteflux âœ¦', content: '<h2>Welcome! âœ¦</h2><p>Noteflux v2 is here with major improvements:</p><ul><li>ðŸ· <strong>Tag filter strip</strong> â€” click tags in the sidebar to filter notes</li><li>ðŸ‘ <strong>Hover preview</strong> â€” hover a note for 500ms to see its content</li><li>ðŸ”’ <strong>Note locking</strong> â€” lock button in editor to prevent edits</li><li>âŒ¨ <strong>Typewriter mode</strong> â€” Alt+T or footer âŒ¨ button</li><li>ðŸ“ <strong>Markdown shortcuts</strong> â€” type # then space for H1, - for list, > for quote</li><li>âŽ˜ <strong>Paste as plain text</strong> â€” removes formatting on paste</li><li>ðŸ“ <strong>Line width control</strong> â€” optimal 65-char reading width option</li><li>ðŸ”¤ <strong>Font family selector</strong> â€” Sans, Serif, Merriweather, Mono</li><li>ðŸŽ¨ <strong>3 themes</strong> â€” Dark, Light, Sepia (click moon icon)</li><li>â± <strong>Collapsible Pomodoro</strong> â€” click â± in footer</li><li>ðŸ”¥ <strong>Streak in rail</strong> â€” see your writing streak at a glance</li><li>ðŸŽ‰ <strong>Milestone celebrations</strong> â€” confetti on first note, 10 notes, 1000 words!</li><li>ðŸ“Š <strong>Improved Stats</strong> â€” hover heatmap cells for date details</li><li>âœ… <strong>Better checklists</strong> â€” Enter adds new item, fix empty items</li></ul><p>Most features work offline â€” data is stored in your browser.</p>', canvasData: '', tags: ['personal'], pinned: true, locked: false, color: '', folder: null, createdAt: Date.now() - 86400000, updatedAt: Date.now() - 3600000 },
        { id: '2', title: 'Project Ideas', content: '<h3>Q2 Roadmap</h3><p>Some ideas for next quarter.</p><blockquote>Always build with the user in mind.</blockquote>', canvasData: '', tags: ['idea', 'work'], pinned: false, locked: false, color: '#7c5cfc', folder: null, createdAt: Date.now() - 172800000, updatedAt: Date.now() - 7200000 },
      ];
      sv('notes'); renderList();
    }
  </script>
</body>

</html>
